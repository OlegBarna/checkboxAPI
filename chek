unit chek;

{$mode objfpc}{$H+}

interface

uses
  Classes, SysUtils, FileUtil, LResources, Forms, Controls, Graphics, Dialogs,
  ExtCtrls, StdCtrls, Buttons, DbCtrls, DBGrids, DataMod, Grids, IniPropStorage,
  LR_Class, LR_DBSet, LR_BarC, DKlient, DRek, dgssch,  dsch, splash,
  dsopl, dvras, sprop, kredit, printers, Menus, EditBtn, dklgrupa,dndata,
  dklnt, dgtov, LCLType, ComCtrls, Spin, ReceiptWebAPI, DateUtils,
  fpjson, jsonparser, jsonscanner,StrUtils, DB,  FiscalCheckViewer, uchekdb;

type
  TStatusType = (stAPI, stCashier, stCashRegister, stShift);
  TStatusValue = (svUnknown, svDisabled, svOffline, svOnline, svReady,
                  svOpened, svClosed, svError, svProcessing);
  { TFmChek }

  TFmChek = class(TForm)
    btbtnSendReceiptCurl: TBitBtn;
    BitBtn10: TBitBtn;
    BitBtn11: TBitBtn;
    BitBtn12: TBitBtn;
    btnCheckConnectivity: TButton;
    btnCloseShiftSimpleCurl: TButton;
    btnCloseShiftWithReportCurl: TButton;
    btnCreateCheck: TBitBtn;
    btnCheckErase: TBitBtn;
    BitBtn15: TBitBtn;
    BitBtn16: TBitBtn;
    btnCheckPrint: TBitBtn;
    btnCheckCancel: TBitBtn;
    btnCreateNonFiscalCheck: TBitBtn;
    btnGoOnline: TButton;
    btnForsedShiftClose: TButton;
    btnGetCashRegisterStatusCurl: TButton;
    btnFindCashRegister: TButton;
    btnGetFiscalMemoryStatus: TButton;
    btnGetPrinterStatus: TButton;
    btnGetShiftStatusCurl: TButton;
    btnGoOffline: TButton;
    btnLoginCurl: TButton;
    btnLogoutCurl: TButton;
    btnOpenShiftCurl: TButton;
    btnOpenShift: TButton;
    btnProcessOfflineReceipts: TButton;
    btnWarranty: TBitBtn;
    btnRecoverShift: TButton;
    btnInitializeCashRegister: TButton;
    btnSaveSettings: TButton;
    btnCashIn: TButton;
    btnCashOut: TButton;
    btnPinCodeLogin: TButton;
    btnRefreshCashRegisters: TButton;
    btnSelectCashRegister: TButton;
    btnGetXReport: TButton;
    chkPreferTestCashRegister: TCheckBox;
    chkUseCheckboxAPI: TCheckBox;
    chkSkipClientNameCheck: TCheckBox;
    cmbCashRegisters: TComboBox;
    DBComboPaymentType: TDBComboBox;
    DBGrid1: TDBGrid;
    DBGrid3: TDBGrid;
    DBGrid4: TDBGrid;
    DBNavigator1: TDBNavigator;
    DBNavigator5: TDBNavigator;
    DBNavigator6: TDBNavigator;
    DBText1: TDBText;
    edtPinCode: TEdit;
    edtBaseURL: TEdit;
    edtCashRegisterId: TEdit;
    edtClientName: TEdit;
    edtClientVersion: TEdit;
    edtFiscalCode: TEdit;
    edtFiscalDate: TEdit;
    edtLicenseKey: TEdit;
    edtPassword: TEdit;
    edtShiftId: TEdit;
    edtUsername: TEdit;
    fseAmount: TFloatSpinEdit;
    frBarCodeObject1: TfrBarCodeObject;
    frDBDataSet1: TfrDBDataSet;
    frReport1: TfrReport;
    GroupBox1: TGroupBox;
    gbLoginType: TGroupBox;
    GroupBox2: TGroupBox;
    grpActions: TGroupBox;
    grpAdditional: TGroupBox;
    grpAuthentication: TGroupBox;
    grpCashRegister: TGroupBox;
    grpConnection: TGroupBox;
    grpOptions: TGroupBox;
    grpShiftOperations: TGroupBox;
    IniPropStorage1: TIniPropStorage;
    Label1: TLabel;
    Label16: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    lblCashierName: TLabel;
    lblPinCode: TLabel;
    lblBalance: TLabel;
    lblBaseURL: TLabel;
    lblCashRegisterId: TLabel;
    lblClientName: TLabel;
    lblClientVersion: TLabel;
    lblFiscalCode: TLabel;
    lblFiscalDate: TLabel;
    lblLicenseKey: TLabel;
    lblPassword: TLabel;
    lblShiftId: TLabel;
    lblUsername: TLabel;
    memLog: TMemo;
    PageControl1: TPageControl;
    Panel1: TPanel;
    Panel10: TPanel;
    Panel11: TPanel;
    Panel12: TPanel;
    Panel13: TPanel;
    Panel14: TPanel;
    Panel15: TPanel;
    Panel2: TPanel;
    Panel3: TPanel;
    Panel4: TPanel;
    Panel5: TPanel;
    Panel6: TPanel;
    Panel7: TPanel;
    Panel8: TPanel;
    Panel9: TPanel;
    rbPinCode: TRadioButton;
    rbPassword: TRadioButton;
    StatusBar1: TStatusBar;
    tsCash: TTabSheet;
    tsConnection: TTabSheet;
    tsLog: TTabSheet;
    tsOperations: TTabSheet;

    procedure BitBtn10Click(Sender: TObject);
    procedure BitBtn11Click(Sender: TObject);
    procedure BitBtn12Click(Sender: TObject);
    procedure btbtnSendReceiptCurlClick(Sender: TObject);
    procedure btnCashInClick(Sender: TObject);
    procedure btnCashOutClick(Sender: TObject);
    procedure btnCloseShiftSimpleCurlClick(Sender: TObject);
    procedure btnCloseShiftWithReportCurlClick(Sender: TObject);
    procedure btnCreateCheckClick(Sender: TObject);
    procedure btnCheckEraseClick(Sender: TObject);
    procedure BitBtn15Click(Sender: TObject);
    procedure BitBtn16Click(Sender: TObject);
    procedure btnCheckPrintClick(Sender: TObject);
    procedure btnCheckCancelClick(Sender: TObject);
    procedure btnCreateNonFiscalCheckClick(Sender: TObject);
    procedure btnFindCashRegisterClick(Sender: TObject);
    procedure btnForsedShiftCloseClick(Sender: TObject);
    procedure btnGetCashRegisterStatusCurlClick(Sender: TObject);
    procedure btnGetShiftStatusCurlClick(Sender: TObject);
    procedure btnGetXReportClick(Sender: TObject);
    procedure btnGoOfflineClick(Sender: TObject);
    procedure btnGoOnlineClick(Sender: TObject);
    procedure btnInitializeCashRegisterClick(Sender: TObject);
    procedure btnLoginCurlClick(Sender: TObject);
    procedure btnLogoutCurlClick(Sender: TObject);
    procedure btnOpenShiftClick(Sender: TObject);
    procedure btnOpenShiftCurlClick(Sender: TObject);
    procedure btnPinCodeLoginClick(Sender: TObject);
    procedure btnRecoverShiftClick(Sender: TObject);
    procedure btnRefreshCashRegistersClick(Sender: TObject);
    procedure btnSaveSettingsClick(Sender: TObject);
    procedure btnSendReceiptClick(Sender: TObject);
    procedure btnWarrantyClick(Sender: TObject);
    procedure chkPreferTestCashRegisterClick(Sender: TObject);
    procedure chkUseCheckboxAPIClick(Sender: TObject);
    procedure cmbCashRegistersChange(Sender: TObject);
    procedure DBComboPaymentTypeChange(Sender: TObject);
    procedure DBGrid1DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure DBGrid3DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure DBGrid4DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure FormClose(Sender: TObject; var CloseAction: TCloseAction);
    procedure FormCreate(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure FormShow(Sender: TObject);
    procedure frReport1GetValue(const ParName: String; var ParValue: Variant);

    procedure btnCheckConnectivityClick(Sender: TObject);
    procedure btnGetPrinterStatusClick(Sender: TObject);
    procedure btnGetFiscalMemoryStatusClick(Sender: TObject);
    procedure btnProcessOfflineReceiptsClick(Sender: TObject);

    procedure edtFiscalCodeChange(Sender: TObject);
    procedure edtCashRegisterIdChange(Sender: TObject);
    procedure PageControl1Change(Sender: TObject);
    procedure rbPasswordClick(Sender: TObject);
    procedure rbPinCodeClick(Sender: TObject);
    procedure tsCashShow(Sender: TObject);
  private
    FDBManager: TChekDBManager;

    datavv,nomer,psvid,nalkod,pnazva,pnazshort:string;
    reppath:string;
    logpath:string;
    receiptspath:String;
    temppath:string;
    level,createlogs:boolean;
    FCurrentBalance: Integer;
    FLastBalanceUpdate: TDateTime;
    FReceiptAPI: TReceiptWebAPI; // –ï–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—à–æ–≥–æ API –∫–ª–∞—Å—É
    UseCheckboxAPI: Boolean; // –ù–æ–≤–∞ –≥–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞
    FUpdatingCheckboxState: Boolean;
    PinLogin: Boolean;
    FPreferTestCashRegister: Boolean;
    FCashRegisters: TCashRegisterArray;

    FSessionCounter: Integer;        // –õ—ñ—á–∏–ª—å–Ω–∏–∫ —Å–µ—Å—ñ–π
    FCurrentLogFileName: string;     // –ü–æ—Ç–æ—á–Ω–∏–π —Ñ–∞–π–ª –ª–æ–≥—É

    FIsProcessingFiscalization: Boolean; // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ —Ä–µ–∫—É—Ä—Å—ñ—ó
    FCashierNameFromIni: string;
    FDepartamentFromIni: string;
    GoodsTaxGroup: integer; // –∑ –∫–æ–Ω—Ñ—ñ–≥ —Ñ–∞–π–ª—É –≥—Ä—É–ø–∞ –ø–æ–¥–∞—Ç–∫—ñ–≤ –¥–ª—è —Ç–æ–≤–∞—Ä—ñ–≤
    FUpdatingPaymentType: Boolean;

    function DBManagerReady: Boolean;


    procedure InitializeLogFile;     // –ù–æ–≤–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –ª–æ–≥—É
    procedure WriteLogToFile(const AMessage: string); // –ú–µ—Ç–æ–¥ –∑–∞–ø–∏—Å—É –≤ —Ñ–∞–π–ª

    procedure Log(const AMessage: string); // –î–æ–ø–æ–º—ñ–∂–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
    procedure ParseAndShowZReport(const AZReportJSON: string);
    procedure ClearShiftStateFile;
    procedure SynchronizeShiftId(const AShiftId: string);
    function ValidateShiftId(const AShiftId: string): Boolean;
    procedure ClearShiftState;
    procedure SaveSettings;
    procedure SaveCashRegisterId(const ACashRegisterId: string);
    procedure SaveFiscalCode(const AFiscalCode: string);
    function GetAmountInKopiyky: Integer;
    procedure UpdateCashBalance;
    procedure UpdateBalanceAfterOperation;
    function CalculateLocalBalance: Integer;
    procedure ChangeCheckboxAPIFunctionality(Functionality: Boolean);
    function IsShiftOpen: Boolean;
    function CheckAndRenewAuth: Boolean;
    function ValidateAPIState(RequireShift: Boolean = False;RequireCashRegister: Boolean = False;
                              RequireCashRegisterList: Boolean = False): Boolean;
    function ValidateCheckForFiscalization: Boolean;
    function InitializeOptimalCashRegister(var Response: string): Boolean;
    procedure LoadCashRegisterPreferences;
    procedure SaveCashRegisterPreferences;
    procedure RefreshCashRegisterList;
    function RetryFiscalization(Receipt: TReceipt; MaxRetries: Integer): Boolean;
    procedure ProcessPendingFiscalizations;
    function ValidateReceiptData: Boolean;

    procedure MarkCheckAsPrinted(CheckID: Integer);
    procedure UpdateFiscalStatus(CheckID: Integer; Status: string;FiscalData: string = ''; ErrorText: string = '');
    procedure ConvertToFiscalCheck(CheckID: Integer);
    procedure ConvertToNonFiscalCheck(CheckID: Integer);

    procedure FillMandatoryReceiptFields(Receipt: TReceipt; CheckID: Integer);
    procedure FillGoodsFromDatabase(Receipt: TReceipt; CheckID: Integer);
    procedure FillPaymentsFromDatabase(Receipt: TReceipt; CheckID: Integer);
    function CreateTaxByGroup(TaxGroup: Integer): TTax;
    function ValidateReceiptStructure(Receipt: TReceipt): Boolean;
    function ValidateGoods(Goods: array of TGoodItem): Boolean;
    function CalculateTotalSum(Goods: array of TGoodItem): Integer;
    function ExceptionToString(E: Exception): string;
    function DetermineTaxGroupForProduct(ProductCode: string): Integer;
    function ReceiptStatusToString(Status: TReceiptStatus): string;


    procedure HandleSuccessfulFiscalization(ACheckID: Integer;
      AReceipt: TReceipt; AReceiptResponse: TReceiptResponse);
    procedure HandleFailedFiscalization(ACheckID: Integer; const AResponse: string);
    procedure HandleFiscalizationException(ACheckID: Integer; E: Exception);
    function ShouldRetryFiscalization(ACheckID: Integer; const AResponse: string; CurrentRetry: Integer): Boolean;
    function IsNetworkError(const AResponse: string): Boolean;
    procedure SaveReceiptToOfflineQueue(CheckID: Integer);

    procedure CheckPendingFiscalizations;
    function IsShiftReadyForFiscalization: Boolean;
    function IsCashRegisterOnline: Boolean;
    function WaitForReceiptFiscalization(const AReceiptId: string;
        TimeoutSeconds: Integer = 30): Boolean;

    procedure UpdateCashierInfo;
    procedure ClearCashierInfo;

    procedure UpdateStatusBar(StatusType: TStatusType; StatusValue: TStatusValue;AdditionalText: string = '');
    procedure UpdateAPIStatus(AStatus: TStatusValue; const AAdditional: string = '');
    procedure UpdateCashierStatus(AStatus: TStatusValue; const ACashierName: string = '');
    procedure UpdateCashRegisterStatus(AStatus: TStatusValue; const ARegisterInfo: string = '');
    procedure UpdateShiftStatus(AStatus: TStatusValue; const AShiftInfo: string = '');
    procedure UpdateAllStatuses;

    procedure ChangePaymentType(CheckID: Integer; NewPaymentType: string;
       CashAmount: Double = 0; CardAmount: Double = 0; CardInfo: string = '');
    procedure SaveStringToFile(const AFileName, AContent: string);
    // –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ Z-–∑–≤—ñ—Ç–æ–º
    function ExtractZReportIdFromResponse(Response: string): string;
    procedure GetZReportTextAndSave(ReportId: string);
    procedure GetZReportPNGAndSave(ReportId: string);

  public
    { public declarations }
  end;

var
  FmChek: TFmChek;

implementation


const
  StatusEmoji: array[TStatusValue] of string = (
    '‚ùì', // svUnknown
    '‚ö´', // svDisabled
    'üî¥', // svOffline
    'üü¢', // svOnline
    'üü°', // svReady
    '‚úÖ', // svOpened
    '‚ùå', // svClosed
    'üö´', // svError
    '‚è≥'  // svProcessing
  );

  StatusText: array[TStatusValue] of string = (
    '–ù–µ–≤—ñ–¥–æ–º–æ',   // svUnknown
    '–í–∏–º–∫–Ω–µ–Ω–æ',   // svDisabled
    '–û—Ñ–ª–∞–π–Ω',     // svOffline
    '–û–Ω–ª–∞–π–Ω',     // svOnline
    '–ì–æ—Ç–æ–≤–æ',     // svReady
    '–í—ñ–¥–∫—Ä–∏—Ç–∞',   // svOpened
    '–ó–∞–∫—Ä–∏—Ç–∞',    // svClosed
    '–ü–æ–º–∏–ª–∫–∞',    // svError
    '–û–±—Ä–æ–±–∫–∞'     // svProcessing
  );




procedure TFmChek.FormClose(Sender: TObject; var CloseAction: TCloseAction);
var
  cr: TCashRegister;
begin
  if createlogs and (FCurrentLogFileName <> '') then
  begin
    WriteLogToFile('=== –ó–ê–í–ï–†–®–ï–ù–ù–Ø –°–ï–°–Ü–á ===');
    WriteLogToFile('–ß–∞—Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è: ' + DateTimeToStr(Now));
    WriteLogToFile('=====================' + sLineBreak);
  end;

 // –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –∑–º—ñ–Ω–∏ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ —Ñ–æ—Ä–º–∏
 if Assigned(FReceiptAPI) and (FReceiptAPI.CurrentShiftId <> '') then
 begin
   FReceiptAPI.SaveShiftToFile(FReceiptAPI.CurrentShiftId);
   Log('–°—Ç–∞–Ω –∑–º—ñ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ —Ñ–æ—Ä–º–∏: ' + FReceiptAPI.CurrentShiftId);
 end;

 if Assigned(FReceiptAPI) then
 begin
   if FReceiptAPI.IsTokenValid then
     FReceiptAPI.HandleAuthState(aaSave)  // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è, —è–∫—â–æ –≤–∞–ª—ñ–¥–Ω–∏–π
   else
     FReceiptAPI.HandleAuthState(aaClear);  // –û—á–∏—â–µ–Ω–Ω—è, —è–∫—â–æ –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π
 end;

 // –í FormClose –∑–∞–º—ñ–Ω–∏—Ç–∏:
  FDBManager.ClsCon;


 // –ó–≤—ñ–ª—å–Ω–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ë–î
 if Assigned(FDBManager) then
 begin
   Log('–ó–≤—ñ–ª—å–Ω–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ë–î...');
   FreeAndNil(FDBManager);
 end;

 // –ó–≤—ñ–ª—å–Ω–µ–Ω–Ω—è –ø–∞–º'—è—Ç—ñ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ —Ñ–æ—Ä–º–∏
 if Assigned(FReceiptAPI) then
    FreeAndNil(FReceiptAPI);

 for cr in FCashRegisters do
    if Assigned(cr) then
      cr.Free;
  SetLength(FCashRegisters, 0);

  Log('–ó–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—É—î —Ä–æ–±–æ—Ç—É');
  UpdateAllStatuses;
end;

procedure TFmChek.FormCreate(Sender: TObject);
begin
  FUpdatingCheckboxState := False;
  FCurrentBalance := -1;
  FLastBalanceUpdate := 0;
  FIsProcessingFiscalization := False;
  GoodsTaxGroup := 8;

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ë–î (–ø–æ–∫–∏ —â–æ –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤, schet —â–µ –Ω–µ –≤—ñ–¥–æ–º–∏–π)
  FDBManager := nil;

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–º—ñ–Ω–Ω–∏—Ö –¥–ª—è Checkbox API
  UseCheckboxAPI := False; // –°–ø–æ—á–∞—Ç–∫—É –≤–∏–º–∫–Ω–µ–Ω–æ, –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –≤ FormShow
  FPreferTestCashRegister := True; // –ó–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
  PinLogin := False;

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —Å–µ—Å—ñ–π —Ç–∞ —Ñ–∞–π–ª—É –ª–æ–≥—É
  FSessionCounter := 0;
  FCurrentLogFileName := '';

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–∞—Å–∏–≤—É –∫–∞—Å
  SetLength(FCashRegisters, 0);

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∞–ø–æ—Ä—Ü—ñ–≤ —Å—Ç–∞–Ω—É
  FUpdatingPaymentType := False;
  FUpdatingCheckboxState := False;

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –∫–∞—Å–∏—Ä–∞
  FCashierNameFromIni := '';
  FDepartamentFromIni := '';

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è API (–±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ –ø—Ä–∏ –ø–æ—Ç—Ä–µ–±—ñ)
  FReceiptAPI := nil;

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞—Ç—É—Å—ñ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Å—Ç–∞–Ω—É UseCheckboxAPI
  // –ù–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ UseCheckboxAPI —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó,
  // —Ç–æ–º—É –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å–∏ —è–∫ –Ω–µ–≤—ñ–¥–æ–º—ñ - –≤–æ–Ω–∏ –±—É–¥—É—Ç—å –æ–Ω–æ–≤–ª–µ–Ω—ñ –≤ FormShow
  UpdateAPIStatus(svUnknown, '–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è...');
  UpdateCashierStatus(svUnknown);
  UpdateCashRegisterStatus(svUnknown);
  UpdateShiftStatus(svUnknown);

  Log('–§–æ—Ä–º–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞ - –ø–æ—á–∞—Ç–∫–æ–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
end;

procedure TFmChek.FormKeyDown(Sender: TObject;var Key: Word;Shift: TShiftState);
begin
 //messagedlg(' >'+inttostr(key),mtinformation,[mbok],0);
  if Key=VK_F2 then
  begin
    btnCreateCheck.Click;
  end;
end;





procedure TFmChek.DBGrid3DrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
   if not DMMag.QNDataKOD.IsNull and
    (DMMag.QNDataKONTR1.AsInteger>0) and
    (DMMag.QNDataKONTR2.AsInteger>0)
 then DBGrid3.Canvas.Font.Color:=clBlue
 else DBGrid3.Canvas.Font.Color:=clWindowText;

 with DBGrid3 do
  begin
    if gdSelected in State then Canvas.Brush.Color:=clSkyBlue;
    Canvas.FillRect(Rect);
    DefaultDrawColumnCell(Rect,DataCol,Column,State);
  end;
 //DBGrid3.DefaultDrawColumnCell(Rect,DataCol,Column,State);

end;

procedure TFmChek.DBGrid4DrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
   with DBGrid4 do
   begin
     if gdSelected in State then Canvas.Brush.Color:=clSkyBlue;
     Canvas.FillRect(Rect);
     DefaultDrawColumnCell(Rect,DataCol,Column,State);
   end;
end;


function TFmChek.GetAmountInKopiyky: Integer;
begin
  try
    Result := Round( fseAmount.Value * 100);  // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ –∫–æ–ø—ñ–π–∫–∏
  except
    on E: Exception do
    begin
      ShowMessage('–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó —Å—É–º–∏: ' + E.Message + #13#10 +
                 '–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 275,00 –∞–±–æ 275)');
      Result := 0;
    end;
  end;
end;



procedure TFmChek.BitBtn11Click(Sender: TObject);
var
  CurrentProductID: Integer;
  ProductName: string;
begin
  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —á–µ–∫–∞
  if not FDBManager.CanModifyCheck then Exit;

  if (not DMMag.QChekKod.IsNull) and (not DMMag.QNDataKod.IsNull) then
  begin
    ProductName := DMMag.QNDataNazva.AsString;

    if MessageDlg('–î—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –∑–Ω–∏—â–∏—Ç–∏ —Ä—è–¥–æ–∫:' + #13 + ProductName + ' ?',
                  mtWarning, [mbYes, mbNo], 0) = mrYes then
    begin
      // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–µ–Ω–µ–¥–∂–µ—Ä –ë–î –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
      CurrentProductID := FDBManager.GetCurrentProductID;

      if CurrentProductID > 0 then
      begin
        try
          FDBManager.RemoveProductFromCheck(CurrentProductID);

          // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ –ø—ñ—Å–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
          DMMag.QNData.Refresh;
          if DMMag.QNData.RecordCount > 0 then
            DMMag.QNData.Last;

          Log('‚úÖ –¢–æ–≤–∞—Ä –≤–∏–¥–∞–ª–µ–Ω–æ: ' + ProductName);

        except
          on E: Exception do
          begin
            Log('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É: ' + E.Message);
            MessageDlg('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É: ' + E.Message, mtError, [mbOk], 0);
          end;
        end;
      end;
    end;
  end
  else
    MessageDlg('–ó–Ω–∏—â–µ–Ω–Ω—è –Ω–µ–º–æ–∂–ª–∏–≤–µ!', mtError, [mbOk], 0);
end;

procedure TFmChek.BitBtn12Click(Sender: TObject);
begin
  FDBManager.UpdateProductInCheck;
end;

procedure TFmChek.btbtnSendReceiptCurlClick(Sender: TObject);
var
  Receipt: TReceipt;
  Response: string;
  ReceiptResponse: TReceiptResponse;
  Success: Boolean;
  CheckID: Integer;
  RetryCount: Integer;
  MaxRetries: Integer;
  TotalGoodsSum: Integer;
  TotalPaymentsSum: Integer;
  i: Integer;
  UserCancelled: Boolean;
  CurrentRetryCount: Integer;
  // –î–û–î–ê–ù–Ü –ó–ú–Ü–ù–ù–Ü –î–õ–Ø –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–á
  LHTMLContent: string;
  LPNGFileName: string;
  LQRCodeFileName: string;
  LTextContent: string;
  // –ù–û–í–Ü –ó–ú–Ü–ù–ù–Ü –î–õ–Ø –ü–ï–†–ï–í–Ü–†–û–ö
  TotalFromGoods: Double;
begin
  UpdateAPIStatus(svProcessing);
  Receipt := nil;
  ReceiptResponse := nil;
  UserCancelled := False;
  // –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ù–û–í–ò–• –ó–ú–Ü–ù–ù–ò–•
  LHTMLContent := '';
  LPNGFileName := '';
  LQRCodeFileName := '';
  LTextContent := '';

  // –û—Ç—Ä–∏–º–∞—Ç–∏ CheckID –ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º ValidateAndRepairCheckData
  CheckID := DMMag.QChekKOD.AsInteger;

  // –í–Ü–î–ù–û–í–õ–ï–ù–ù–Ø –î–ê–ù–ò–• –ü–Ü–°–õ–Ø –ê–í–ê–†–Ü–ô–ù–û–ì–û –ó–ê–í–ï–†–®–ï–ù–ù–Ø
  FDBManager.ValidateAndRepairCheckData(CheckID);

  if FIsProcessingFiscalization then
  begin
    Log('–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—è –≤–∂–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è');
    ShowMessage('–§—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—è –≤–∂–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è. –ó–∞—á–µ–∫–∞–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è...');
    Exit;
  end;

  FIsProcessingFiscalization := True;
  btbtnSendReceiptCurl.Enabled := False;
  Screen.Cursor := crHourGlass;

  try
    // –ü–ï–†–ï–í–Ü–†–ö–ê –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–á –°–£–ú –ü–ï–†–ï–î –§–Ü–°–ö–ê–õ–Ü–ó–ê–¶–Ü–Ñ–Æ
    TotalFromGoods := 0.0;

    DMMag.QNData.First;
    while not DMMag.QNData.EOF do
    begin
      TotalFromGoods := TotalFromGoods + DMMag.QNDataSUMMA.AsFloat;
      DMMag.QNData.Next;
    end;

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —Å—É–º–∞ —Ç–æ–≤–∞—Ä—ñ–≤ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—É–º—ñ –≤ —á–µ–∫—É
    if Abs(TotalFromGoods - DMMag.QChekSUMMA.AsFloat) > 0.01 then
    begin
      Log(Format('‚ùå –ù–ï–°–ü–Ü–í–ü–ê–î–Ü–ù–ù–Ø –°–£–ú: –¢–æ–≤–∞—Ä–∏=%.2f, –ß–µ–∫=%.2f', [TotalFromGoods, DMMag.QChekSUMMA.AsFloat]));
      ShowMessage(Format('–ù–µ—Å–ø—ñ–≤–ø–∞–¥—ñ–Ω–Ω—è —Å—É–º:' + sLineBreak +
                        '–°—É–º–∞ —Ç–æ–≤–∞—Ä—ñ–≤: %.2f –≥—Ä–Ω' + sLineBreak +
                        '–°—É–º–∞ –≤ —á–µ–∫—É: %.2f –≥—Ä–Ω' + sLineBreak +
                        '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö.',
                        [TotalFromGoods, DMMag.QChekSUMMA.AsFloat]));
      Exit;
    end;

    if not ValidateAPIState(True, True) then
      Exit;

    if not ValidateCheckForFiscalization then
      Exit;

    if not DMMag.QChekFISCAL_STATUS.IsNull and
       (DMMag.QChekFISCAL_STATUS.AsString = 'DONE') then
    begin
      if MessageDlg('–ß–µ–∫ –≤–∂–µ —Ñ—ñ—Å–∫–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π',
          '–¶–µ–π —á–µ–∫ –≤–∂–µ –º–∞—î —Ñ—ñ—Å–∫–∞–ª—å–Ω–∏–π –Ω–æ–º–µ—Ä: ' + DMMag.QChekFISCAL_CODE.AsString +
          #13#10'–ë–∞–∂–∞—î—Ç–µ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —á–µ–∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ?',
          mtConfirmation, [mbYes, mbNo], 0) <> mrYes then
      begin
        UserCancelled := True;
        Log('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥–º–æ–≤–∏–≤—Å—è –≤—ñ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ—ó —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó —á–µ–∫–∞ ' + DMMag.QChekFISCAL_CODE.AsString);
        Exit;
      end;
    end;

    if not IsShiftReadyForFiscalization then
    begin
      Log('–ó–º—ñ–Ω–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞ –¥–ª—è —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó');
      Exit;
    end;

    if not IsCashRegisterOnline then
    begin
      Log('–ö–∞—Å–∞ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—ñ - —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–µ–º–æ–∂–ª–∏–≤–∞');
      Exit;
    end;

    if not FReceiptAPI.CheckConnectivityCurl(Response) then
    begin
      UpdateAPIStatus(svOffline);
      Log('–í—ñ–¥—Å—É—Ç–Ω—î –∑ º—î–¥–Ω–∞–Ω–Ω—è –∑ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º: ' + Response);
      ShowMessage('–í—ñ–¥—Å—É—Ç–Ω—î –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É! –§—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–µ–º–æ–∂–ª–∏–≤–∞.');
      Exit;
    end
    else
    begin
      Log('–ó º—î–¥–Ω–∞–Ω–Ω—è –∑ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
    end;

    FReceiptAPI.ReceiptsDirectory := receiptspath;
    FReceiptAPI.TempDirectory := temppath;

    // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
    if not DirectoryExists(FReceiptAPI.ReceiptsDirectory) then
    begin
      if not ForceDirectories(FReceiptAPI.ReceiptsDirectory) then
      begin
        Log('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –¥–ª—è —á–µ–∫—ñ–≤: ' + FReceiptAPI.ReceiptsDirectory);
        Exit;
      end;
    end;

    if not DirectoryExists(FReceiptAPI.TempDirectory) then
    begin
      if not ForceDirectories(FReceiptAPI.TempDirectory) then
      begin
        Log('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é: ' + FReceiptAPI.TempDirectory);
        Exit;
      end;
    end;

    if not DMMag.QChekFISCAL_STATUS.IsNull and
       (DMMag.QChekFISCAL_STATUS.AsString = 'NON_FISCAL') then
    begin
      ShowMessage('–¶–µ —Å–ª—É–∂–±–æ–≤–∏–π —á–µ–∫ - —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è');
      Exit;
    end;

    if DMMag.QNData.RecordCount = 0 then
    begin
      ShowMessage('–ß–µ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π! –î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä–∏ –ø–µ—Ä–µ–¥ —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—î—é.');
      Exit;
    end;

    if DMMag.QChekSUMMA.AsFloat <= 0 then
    begin
      ShowMessage('–°—É–º–∞ —á–µ–∫–∞ –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0!');
      Exit;
    end;

    // CheckID –≤–∂–µ –æ—Ç—Ä–∏–º–∞–Ω–æ –≤–∏—â–µ

    // –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–± –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó
    CurrentRetryCount := 0;
    try
      DMMag.SQLQ.SQL.Text := 'SELECT COALESCE(FISCAL_RETRY_COUNT, 0) AS RETRY_COUNT FROM CHEK WHERE KOD = :CHECK_ID';
      DMMag.SQLQ.ParamByName('CHECK_ID').AsInteger := CheckID;
      DMMag.SQLQ.Open;
      CurrentRetryCount := DMMag.SQLQ.FieldByName('RETRY_COUNT').AsInteger;
      DMMag.SQLQ.Close;

      Log('–ü–æ—Ç–æ—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–± –¥–ª—è —á–µ–∫–∞ ' + IntToStr(CheckID) + ': ' + IntToStr(CurrentRetryCount));
    except
      on E: Exception do
      begin
        Log('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —Å–ø—Ä–æ–±: ' + E.Message);
        DMMag.SQLQ.Close;
      end;
    end;

    try
      Log('=== –ü–û–ß–ê–¢–û–ö –§–Ü–°–ö–ê–õ–Ü–ó–ê–¶–Ü–á –ß–ï–ö–ê ===');
      Log('ID —á–µ–∫–∞: ' + IntToStr(CheckID));
      Log('–ù–æ–º–µ—Ä —á–µ–∫–∞: ' + DMMag.QChekNOMER.AsString);
      Log('ID –∑–º—ñ–Ω–∏: ' + FReceiptAPI.CurrentShiftId);
      Log('ID –∫–∞—Å–∏: ' + FReceiptAPI.CurrentCashRegisterId);
      Log('–ü–æ—á–∞—Ç–∫–æ–≤–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–±: ' + IntToStr(CurrentRetryCount));

      Log('=== –ü–ï–†–ï–í–Ü–†–ö–ê –°–¢–ê–ù–£ –ë–î ===');
      Log('QChek –∞–∫—Ç–∏–≤–Ω–∏–π: ' + BoolToStr(DMMag.QChek.Active, True));
      Log('QChek –∑–∞–ø–∏—Å—ñ–≤: ' + IntToStr(DMMag.QChek.RecordCount));
      Log('QNData –∞–∫—Ç–∏–≤–Ω–∏–π: ' + BoolToStr(DMMag.QNData.Active, True));
      Log('QNData –∑–∞–ø–∏—Å—ñ–≤: ' + IntToStr(DMMag.QNData.RecordCount));

      if not DMMag.QChek.Active or not DMMag.QNData.Active then
      begin
        Log('‚ùå –ü–û–ú–ò–õ–ö–ê: –ó–∞–ø–∏—Ç–∏ –¥–æ –ë–î –Ω–µ –∞–∫—Ç–∏–≤–Ω—ñ!');
        ShowMessage('–ü–æ–º–∏–ª–∫–∞: –≤—Ç—Ä–∞—á–µ–Ω–æ –∑–≤ º—è–∑–æ–∫ –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
        Exit;
      end;

      Receipt := TReceipt.Create;
      FillMandatoryReceiptFields(Receipt, CheckID);

      // –î–û–î–ê–¢–ö–û–í–ê –ü–ï–†–ï–í–Ü–†–ö–ê –°–¢–†–£–ö–¢–£–†–ò –ß–ï–ö–ê
      Log('=== –§–Ü–ù–ê–õ–¨–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê –°–¢–†–£–ö–¢–£–†–ò –ß–ï–ö–ê ===');
      Log('Receipt.TotalSum: ' + IntToStr(Receipt.TotalSum) + ' –∫–æ–ø');
      Log('Receipt.TotalPayment: ' + IntToStr(Receipt.TotalPayment) + ' –∫–æ–ø');
      Log('Receipt.Rest: ' + IntToStr(Receipt.Rest) + ' –∫–æ–ø');

      if Receipt.TotalPayment < Receipt.TotalSum then
      begin
        Log('‚ùå –ö–†–ò–¢–ò–ß–ù–ê –ü–û–ú–ò–õ–ö–ê: TotalPayment < TotalSum!');
        Log('TotalPayment: ' + IntToStr(Receipt.TotalPayment) + ', TotalSum: ' + IntToStr(Receipt.TotalSum));

        // –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ï –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –ó–ê–ú–Ü–°–¢–¨ –ê–í–ê–†–Ü–ô–ù–û–ì–û –ó–ê–í–ï–†–®–ï–ù–ù–Ø
        Log('üîÑ –°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Å—É–º...');
        Receipt.TotalPayment := Receipt.TotalSum;
        Receipt.Rest := 0;

        // –ö–æ—Ä–µ–∫—Ç—É—î–º–æ –æ–ø–ª–∞—Ç–∏
        if Length(Receipt.Payments) > 0 then
        begin
          Receipt.Payments[0].Value := Receipt.TotalSum;
          Log('‚úÖ –°—É–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ');
        end
        else
        begin
          ShowMessage('–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: —Å—É–º–∞ –æ–ø–ª–∞—Ç–∏ –º–µ–Ω—à–∞ –∑–∞ –∑–∞–≥–∞–ª—å–Ω—É —Å—É–º—É —á–µ–∫–∞. –î–æ–¥–∞–π—Ç–µ –æ–ø–ª–∞—Ç—É.');
          Exit;
        end;
      end
      else
      begin
        Log('‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —á–µ–∫–∞ –∫–æ—Ä–µ–∫—Ç–Ω–∞');
      end;

      Log('=== –ü–ï–†–ï–í–Ü–†–ö–ê –°–£–ú –ü–ï–†–ï–î –í–Ü–î–ü–†–ê–í–ö–û–Æ ===');

      TotalGoodsSum := 0;
      for i := 0 to High(Receipt.Goods) do
      begin
        if Assigned(Receipt.Goods[i]) then
          TotalGoodsSum := TotalGoodsSum + Receipt.Goods[i].TotalSum;
      end;
      Log('–°—É–º–∞ —Ç–æ–≤–∞—Ä—ñ–≤: ' + FloatToStrF(TotalGoodsSum/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');

      TotalPaymentsSum := 0;
      for i := 0 to High(Receipt.Payments) do
      begin
        if Assigned(Receipt.Payments[i]) then
          TotalPaymentsSum := TotalPaymentsSum + Receipt.Payments[i].Value;
      end;
      Log('–°—É–º–∞ –æ–ø–ª–∞—Ç: ' + FloatToStrF(TotalPaymentsSum/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');

      if TotalGoodsSum <> TotalPaymentsSum then
      begin
        Log('‚ùå –ü–û–ú–ò–õ–ö–ê: –°—É–º–∞ —Ç–æ–≤–∞—Ä—ñ–≤ ‚â† –°—É–º—ñ –æ–ø–ª–∞—Ç!');
        Log('–†—ñ–∑–Ω–∏—Ü—è: ' + FloatToStrF((TotalGoodsSum - TotalPaymentsSum)/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');

        // –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ï –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø
        if TotalPaymentsSum < TotalGoodsSum then
        begin
          Log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–ø—Ä–∞–≤–ª—è—î–º–æ –æ–ø–ª–∞—Ç—É...');
          if Length(Receipt.Payments) > 0 then
          begin
            Receipt.Payments[0].Value := TotalGoodsSum;
            Receipt.TotalPayment := TotalGoodsSum;
            Receipt.Rest := 0;
            Log('‚úÖ –û–ø–ª–∞—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ');
          end;
        end;

        // –í—Å–µ –æ–¥–Ω–æ –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –∞–ª–µ –Ω–µ –∑—É–ø–∏–Ω—è—î–º–æ –ø—Ä–æ–≥—Ä–∞–º—É
        ShowMessage('–£–≤–∞–≥–∞: –°—É–º–∞ —Ç–æ–≤–∞—Ä—ñ–≤ (' + FloatToStrF(TotalGoodsSum/100, ffNumber, 10, 2) +
                   ' –≥—Ä–Ω) –Ω–µ –¥–æ—Ä—ñ–≤–Ω—é—î —Å—É–º—ñ –æ–ø–ª–∞—Ç (' + FloatToStrF(TotalPaymentsSum/100, ffNumber, 10, 2) + ' –≥—Ä–Ω)' +
                   sLineBreak + '–°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è...');
      end
      else
      begin
        Log('‚úÖ –°—É–º–∏ –∑–±—ñ–≥–∞—é—Ç—å—Å—è');
      end;
      Log('=== –ö–Ü–ù–ï–¶–¨ –ü–ï–†–ï–í–Ü–†–ö–ò –°–£–ú ===');

      // –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –Ω–∞ 'SENT' –∑ –ø–æ—Ç–æ—á–Ω–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Å–ø—Ä–æ–±
      FDBManager.UpdateFiscalStatusInDB(CheckID, 'SENT', '', '', '', '', -1, '', '', CurrentRetryCount);

      MaxRetries := 3;
      RetryCount := CurrentRetryCount;
      Success := False;

      while RetryCount < MaxRetries do
      begin
        Log(Format('–°–ø—Ä–æ–±–∞ —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó %d –∑ %d (–≤—Å—å–æ–≥–æ —Å–ø—Ä–æ–±: %d)',
            [RetryCount - CurrentRetryCount + 1, MaxRetries - CurrentRetryCount, RetryCount + 1]));

        Success := FReceiptAPI.SendReceiptCurl(Receipt, Response, ReceiptResponse);

        if Success then
        begin
          Log('‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞ –æ—Ç—Ä–∏–º–∞–Ω–∞ —É—Å–ø—ñ—à–Ω–æ');

          // –°–∫–∏–Ω—É—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å–ø—Ä–æ–± –ø—Ä–∏ —É—Å–ø—ñ—Ö—É, —è–∫—â–æ –±—É–ª–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –Ω–µ–≤–¥–∞–ª—ñ —Å–ø—Ä–æ–±–∏
          if RetryCount > CurrentRetryCount then
          begin
            try
              DMMag.SQLQ.SQL.Text := 'UPDATE CHEK SET FISCAL_RETRY_COUNT = 0 WHERE KOD = :CHECK_ID';
              DMMag.SQLQ.ParamByName('CHECK_ID').AsInteger := CheckID;
              DMMag.SQLQ.ExecSQL;
              Log('–õ—ñ—á–∏–ª—å–Ω–∏–∫ —Å–ø—Ä–æ–± —Å–∫–∏–Ω—É—Ç–æ –¥–æ 0 –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó');
            except
              on E: Exception do
                Log('–ü–æ–º–∏–ª–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —Å–ø—Ä–æ–±: ' + E.Message);
            end;
          end;
          Break;
        end
        else
        begin
          Log('‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–ø—Ä–æ–±–∏ ' + IntToStr(RetryCount + 1) + ': ' + Response);

          // –°–ü–ï–¶–Ü–ê–õ–¨–ù–ê –û–ë–†–û–ë–ö–ê –ü–û–ú–ò–õ–û–ö –ü–û–î–ê–¢–ö–û–í–ò–• –ì–†–£–ü
          if (Pos('–ø–æ–¥–∞—Ç–∫', LowerCase(Response)) <> 0) or (Pos('tax', LowerCase(Response)) <> 0) then
          begin
            Log('‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ –∑ –ø–æ–¥–∞—Ç–∫–æ–≤–∏–º–∏ –≥—Ä—É–ø–∞–º–∏ - –ø–æ—Ç—Ä—ñ–±–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤ –∫–∞–±—ñ–Ω–µ—Ç—ñ Checkbox');
            ShowMessage('–ü–æ–º–∏–ª–∫–∞ –ø–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –≥—Ä—É–ø:' + sLineBreak +
                       '–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –ø–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∞–≤–∫–∏ –≤ –∫–∞–±—ñ–Ω–µ—Ç—ñ Checkbox.' + sLineBreak +
                       '–î–µ—Ç–∞–ª—ñ: ' + Copy(Response, 1, 150));
            // –ù–µ —Ä–æ–±–∏–º–æ –ø–æ–¥–∞–ª—å—à–∏—Ö —Å–ø—Ä–æ–± –¥–ª—è —Ü—å–æ–≥–æ —Ç–∏–ø—É –ø–æ–º–∏–ª–æ–∫
            Break;
          end;

          // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –≤–∞—Ä—Ç–æ —Ä–æ–±–∏—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—É —Å–ø—Ä–æ–±—É
          if not ShouldRetryFiscalization(CheckID, Response, RetryCount) then
          begin
            Log('‚èπÔ∏è  –ü–æ–¥–∞–ª—å—à—ñ —Å–ø—Ä–æ–±–∏ –ø—Ä–∏–ø–∏–Ω–µ–Ω–æ –∑–∞ –ª–æ–≥—ñ–∫–æ—é ShouldRetryFiscalization');
            Break;
          end;

          if Pos('order_id', Response) > 0 then
          begin
            Log('‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ –∑ order_id - —Å–µ—Ä–≤–µ—Ä –æ—á—ñ–∫—É—î UUID –∞–±–æ –ø–æ—Ä–æ–∂–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è');
          end;

          if Pos('offline', LowerCase(Response)) > 0 then
          begin
            Log('‚ö†Ô∏è –ö–∞—Å–∞ –ø–µ—Ä–µ–π—à–ª–∞ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º –ø—ñ–¥ —á–∞—Å —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó');
            ShowMessage('–ö–∞—Å–∞ –ø–µ—Ä–µ–π—à–ª–∞ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.');
            Break;
          end;

          if Pos('shift', LowerCase(Response)) > 0 then
          begin
            Log('‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ –∑—ñ –∑–º—ñ–Ω–æ—é - –º–æ–∂–ª–∏–≤–æ, –∑–º—ñ–Ω–∞ –∑–∞–∫—Ä–∏—Ç–∞ –∞–±–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞');
            ShowMessage('–ü—Ä–æ–±–ª–µ–º–∞ –∑—ñ –∑–º—ñ–Ω–æ—é. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –∑–º—ñ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞.');
            Break;
          end;

          Inc(RetryCount);

          // –û–Ω–æ–≤–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å–ø—Ä–æ–± –≤ –ë–î –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó –Ω–µ–≤–¥–∞–ª–æ—ó —Å–ø—Ä–æ–±–∏
          if RetryCount < MaxRetries then
          begin
            try
              DMMag.SQLQ.SQL.Text := 'UPDATE CHEK SET FISCAL_RETRY_COUNT = :RETRY_COUNT WHERE KOD = :CHECK_ID';
              DMMag.SQLQ.ParamByName('RETRY_COUNT').AsInteger := RetryCount;
              DMMag.SQLQ.ParamByName('CHECK_ID').AsInteger := CheckID;
              DMMag.SQLQ.ExecSQL;
              Log('–û–Ω–æ–≤–ª–µ–Ω–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å–ø—Ä–æ–±: ' + IntToStr(RetryCount));
            except
              on E: Exception do
                Log('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —Å–ø—Ä–æ–±: ' + E.Message);
            end;

            Log('üïí –ü–æ–≤—Ç–æ—Ä–Ω–∞ —Å–ø—Ä–æ–±–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏...');
            Sleep(2000);
          end;
        end;
      end;

      if Success and Assigned(ReceiptResponse) then
      begin
        Log('‚úÖ –ó–∞–ø–∏—Ç —á–µ–∫–∞ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!');
        Log('ID —á–µ–∫–∞ –≤ Checkbox: ' + ReceiptResponse.Id);
        Log('–ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å: ' + ReceiptStatusToString(ReceiptResponse.Status));
        Log('–§—ñ—Å–∫–∞–ª—å–Ω–∏–π –Ω–æ–º–µ—Ä: ' + ReceiptResponse.FiscalCode);

        // –ë–ï–ó–ü–ï–ß–ù–ï –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –î–ê–ù–ò–• –£ –ë–î
          try
            Log('–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –ë–î –ø–µ—Ä–µ–¥ –∫–æ–º—ñ—Ç–æ–º:');
            FDBManager.LogDatabaseState;
            FDBManager.SafeCommitAndReopenConnection;
            Log('–°—Ç–∞–Ω –ë–î –ø—ñ—Å–ª—è –∫–æ–º—ñ—Ç—É:');
            FDBManager.LogDatabaseState;
          except
            on E: Exception do
            begin
              Log('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –≤ –ë–î: ' + E.Message);
              // –ù–µ –ø–µ—Ä–µ—Ä–∏–≤–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å, –∞–ª–µ –ª–æ–≥—É—î–º–æ –ø–æ–º–∏–ª–∫—É
              // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—Ç—Ä–∏–º–∞–≤ —Ñ—ñ—Å–∫–∞–ª—å–Ω–∏–π —á–µ–∫, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –ë–î –Ω–µ –≤–¥–∞–ª–æ—Å—è
            end;
          end;

        HandleSuccessfulFiscalization(CheckID, Receipt, ReceiptResponse);

        // –û–¢–†–ò–ú–ê–ù–ù–Ø –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–á –ü–û–°–õ–Ø –§–Ü–°–ö–ê–õ–Ü–ó–ê–¶–Ü–á
        Log('=== –ü–û–ß–ê–¢–û–ö –û–¢–†–ò–ú–ê–ù–ù–Ø –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–á –ß–ï–ö–ê ===');

        Log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π:');
        Log('ReceiptsDirectory: ' + FReceiptAPI.ReceiptsDirectory);
        Log('TempDirectory: ' + FReceiptAPI.TempDirectory);
        Log('Directory exists: ' + BoolToStr(DirectoryExists(FReceiptAPI.ReceiptsDirectory), True));

        // 1. –û—Ç—Ä–∏–º—É—î–º–æ PNG –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        Log('–û—Ç—Ä–∏–º–∞–Ω–Ω—è PNG –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —á–µ–∫–∞...');
        if FReceiptAPI.GetReceiptPNG(ReceiptResponse.Id, LPNGFileName, 30, 58, 75) then
        begin
          Log('‚úì PNG –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –æ—Ç—Ä–∏–º–∞–Ω–æ: ' + ExtractFileName(LPNGFileName));

          // –ü–ï–†–ï–í–Ü–†–ö–ê –ü–ï–†–ï–î –ü–û–ö–ê–ó–û–ú
          Log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ñ–∞–π–ª—É –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º:');
          Log('–ü–æ–≤–Ω–∏–π —à–ª—è—Ö: ' + LPNGFileName);
          Log('–§–∞–π–ª —ñ—Å–Ω—É—î: ' + BoolToStr(FileExists(LPNGFileName), True));

          if FileExists(LPNGFileName) then
          begin
            Log('–†–æ–∑–º—ñ—Ä —Ñ–∞–π–ª—É: ' + IntToStr(FileSize(LPNGFileName)) + ' –±–∞–π—Ç');
            ShowCheck(LPNGFileName);
          end
          else
          begin
            Log('‚ùå –§–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è!');
            ShowMessage('–§–∞–π–ª —á–µ–∫—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: ' + ExtractFileName(LPNGFileName));
          end;
        end
        else
        begin
          Log('‚úó –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è PNG: ' + FReceiptAPI.LastError);
          ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —á–µ–∫–∞: ' + FReceiptAPI.LastError);
        end;

        // 2. –û—Ç—Ä–∏–º—É—î–º–æ QR-–∫–æ–¥
        Log('–û—Ç—Ä–∏–º–∞–Ω–Ω—è QR-–∫–æ–¥—É...');
        if FReceiptAPI.GetReceiptQRCode(ReceiptResponse.Id, LQRCodeFileName) then
        begin
          Log('‚úì QR-–∫–æ–¥ –æ—Ç—Ä–∏–º–∞–Ω–æ: ' + ExtractFileName(LQRCodeFileName));
        end
        else
        begin
          Log('‚úó –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è QR-–∫–æ–¥—É: ' + FReceiptAPI.LastError);
        end;

        // 3. –û—Ç—Ä–∏–º—É—î–º–æ HTML –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è
        Log('–û—Ç—Ä–∏–º–∞–Ω–Ω—è HTML –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è...');
        if FReceiptAPI.GetReceiptHTML(ReceiptResponse.Id, LHTMLContent) then
        begin
          Log('‚úì HTML –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –æ—Ç—Ä–∏–º–∞–Ω–æ');
          SaveStringToFile(FReceiptAPI.ReceiptsDirectory + '/receipt_' + ReceiptResponse.Id + '.html', LHTMLContent);
        end
        else
        begin
          Log('‚úó –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è HTML: ' + FReceiptAPI.LastError);
        end;

        // 4. –û—Ç—Ä–∏–º—É—î–º–æ —Ç–µ–∫—Å—Ç–æ–≤–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è
        Log('–û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è...');
        if FReceiptAPI.GetReceiptText(ReceiptResponse.Id, LTextContent) then
        begin
          Log('‚úì –¢–µ–∫—Å—Ç–æ–≤–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –æ—Ç—Ä–∏–º–∞–Ω–æ');
          SaveStringToFile(FReceiptAPI.ReceiptsDirectory + '/receipt_' + ReceiptResponse.Id + '.txt', LTextContent);
        end
        else
        begin
          Log('‚úó –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É: ' + FReceiptAPI.LastError);
        end;

        Log('=== –ó–ê–í–ï–†–®–ï–ù–ù–Ø –û–¢–†–ò–ú–ê–ù–ù–Ø –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–á ===');
      end
      else
      begin
        Log('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ñ—ñ—Å–∫–∞–ª—å–Ω–æ–≥–æ —á–µ–∫–∞ –ø—ñ—Å–ª—è ' + IntToStr(RetryCount - CurrentRetryCount + 1) + ' —Å–ø—Ä–æ–±: ' + Response);

        // –û–Ω–æ–≤–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å–ø—Ä–æ–± –ø—Ä–∏ –æ—Å—Ç–∞—Ç–æ—á–Ω—ñ–π –ø–æ–º–∏–ª—Ü—ñ
        try
          DMMag.SQLQ.SQL.Text := 'UPDATE CHEK SET FISCAL_RETRY_COUNT = :RETRY_COUNT WHERE KOD = :CHECK_ID';
          DMMag.SQLQ.ParamByName('RETRY_COUNT').AsInteger := RetryCount;
          DMMag.SQLQ.ParamByName('CHECK_ID').AsInteger := CheckID;
          DMMag.SQLQ.ExecSQL;
          Log('–§—ñ–Ω–∞–ª—å–Ω–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å–ø—Ä–æ–±: ' + IntToStr(RetryCount));
        except
          on E: Exception do
            Log('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —Å–ø—Ä–æ–±: ' + E.Message);
        end;

        HandleFailedFiscalization(CheckID, Response);

        if IsNetworkError(Response) then
        begin
          ShowMessage('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ –ø—ñ—Å–ª—è ' + IntToStr(RetryCount - CurrentRetryCount + 1) + ' —Å–ø—Ä–æ–±:' + sLineBreak +
                     '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≤''—è–∑–∞—Ç–∏—Å—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º Checkbox.' + sLineBreak +
                     '–ß–µ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ—ó –æ–±—Ä–æ–±–∫–∏.');

          SaveReceiptToOfflineQueue(CheckID);
        end
        else if Pos('validation', LowerCase(Response)) > 0 then
        begin
          ShowMessage('–ü–æ–º–∏–ª–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –¥–∞–Ω–∏—Ö:' + sLineBreak +
                     '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö —á–µ–∫–∞.' + sLineBreak +
                     Copy(Response, 1, 200));
        end
        else
        begin
          ShowMessage('–ü–æ–º–∏–ª–∫–∞ —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó: ' + Copy(Response, 1, 200));
        end;
      end;

    except
      on E: Exception do
      begin
        Log('üí• –í–∏–Ω—è—Ç–æ–∫ –ø—Ä–∏ —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó: ' + E.Message);
        Log('–¢–∏–ø –≤–∏–Ω—è—Ç–∫—É: ' + E.ClassName);
        if not UserCancelled then
          HandleFiscalizationException(CheckID, E);
        ShowMessage('–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: ' + E.Message);
      end;
    end;

  finally
    if not UserCancelled then
    begin
      Log('–û—á–∏—â–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤...');
      if Assigned(Receipt) then
        FreeAndNil(Receipt);

      if Assigned(ReceiptResponse) then
        FreeAndNil(ReceiptResponse);
    end
    else
    begin
      Log('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥–º–æ–≤–∏–≤—Å—è –≤—ñ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ—ó —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó - –æ—á–∏—â–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–µ');
    end;

    btbtnSendReceiptCurl.Enabled := True;
    Screen.Cursor := crDefault;
    FIsProcessingFiscalization := False;

    Log('=== –ó–ê–í–ï–†–®–ï–ù–ù–Ø –§–Ü–°–ö–ê–õ–Ü–ó–ê–¶–Ü–á ===');
    UpdateAllStatuses;
  end;
end;

// –î–ª—è –≤–Ω–µ—Å–µ–Ω–Ω—è –≥–æ—Ç—ñ–≤–∫–∏
procedure TFmChek.btnCashInClick(Sender: TObject);
var
  Response: string;
  ReceiptResponse: TReceiptResponse;
  Amount: Integer;
begin
  // –ó–ê–ú–Ü–ù–ê: –û–¥–Ω–∞ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–º—ñ—Å—Ç—å –¥–µ–∫—ñ–ª—å–∫–æ—Ö
  if not ValidateAPIState(False, True) then  // RequireCashRegister = True
    Exit;

  Amount := GetAmountInKopiyky;

  if Amount <= 0 then
  begin
    ShowMessage('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É!');
    fseAmount.SetFocus;
    Exit;
  end;

  if FReceiptAPI.CashIncome(Amount, '–í–Ω–µ—Å–µ–Ω–Ω—è –≥–æ—Ç—ñ–≤–∫–∏ –≤ –∫–∞—Å—É', Response, ReceiptResponse) then
  begin
    ShowMessage('–ì–æ—Ç—ñ–≤–∫—É –≤–Ω–µ—Å–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!' + #13#10 +
                'ID —á–µ–∫–∞: ' + ReceiptResponse.Id + #13#10 +
                '–°—É–º–∞: ' + FloatToStrF(Amount/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');
    fseAmount.Value := 0;
    UpdateBalanceAfterOperation;
  end
  else
  begin
    ShowMessage('–ü–æ–º–∏–ª–∫–∞: ' + Response);
  end;
  UpdateAllStatuses;
  if Assigned(ReceiptResponse) then
    FreeAndNil(ReceiptResponse);
end;


// –î–ª—è –≤–∏–Ω–µ—Å–µ–Ω–Ω—è –≥–æ—Ç—ñ–≤–∫–∏
procedure TFmChek.btnCashOutClick(Sender: TObject);
var
  Response: string;
  ReceiptResponse: TReceiptResponse;
  Amount: Integer;
begin
  // –ó–ê–ú–Ü–ù–ê: –û–¥–Ω–∞ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–º—ñ—Å—Ç—å –¥–µ–∫—ñ–ª—å–∫–æ—Ö
  if not ValidateAPIState(False, True) then  // RequireCashRegister = True
    Exit;

  Amount := GetAmountInKopiyky;

  if Amount <= 0 then
  begin
    ShowMessage('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É!');
    fseAmount.SetFocus;
    Exit;
  end;

  if Amount > FCurrentBalance then
  begin
    ShowMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤ –≤ –∫–∞—Å—ñ –¥–ª—è –≤–∏–Ω–µ—Å–µ–Ω–Ω—è!' + #13#10 +
                '–î–æ—Å—Ç—É–ø–Ω–æ: ' + FloatToStrF(FReceiptAPI.CurrentBalance/100, ffNumber, 10, 2) + ' –≥—Ä–Ω' + #13#10 +
                '–°–ø—Ä–æ–±–∞ –≤–∏–Ω–µ—Å–µ–Ω–Ω—è: ' + FloatToStrF(Amount/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');
    Exit;
  end;

  if MessageDlg('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–Ω–µ—Å–µ–Ω–Ω—è –≥–æ—Ç—ñ–≤–∫–∏',
                '–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–Ω–µ—Å—Ç–∏ ' + FloatToStrF(Amount/100, ffNumber, 10, 2) + ' –≥—Ä–Ω –∑ –∫–∞—Å–∏?',
                mtConfirmation, [mbYes, mbNo], 0) <> mrYes then
  begin
    Exit;
  end;

  if FReceiptAPI.CashOutcome(Amount, '–í–∏–Ω–µ—Å–µ–Ω–Ω—è –≥–æ—Ç—ñ–≤–∫–∏ –∑ –∫–∞—Å–∏', Response, ReceiptResponse) then
  begin
    ShowMessage('–ì–æ—Ç—ñ–≤–∫—É –≤–∏–Ω–µ—Å–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!' + #13#10 +
                'ID —á–µ–∫–∞: ' + ReceiptResponse.Id + #13#10 +
                '–°—É–º–∞: ' + FloatToStrF(Amount/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');
    fseAmount.Value := 0;
    UpdateBalanceAfterOperation;
  end
  else
  begin
    ShowMessage('–ü–æ–º–∏–ª–∫–∞ –≤–∏–Ω–µ—Å–µ–Ω–Ω—è –≥–æ—Ç—ñ–≤–∫–∏: ' + Response);
  end;
  UpdateAllStatuses;
  if Assigned(ReceiptResponse) then
    FreeAndNil(ReceiptResponse);
end;


procedure TFmChek.btnCreateCheckClick(Sender: TObject);
var
  CheckID,nch: Integer;
begin
  if (FDBManager.CurrentSchet > 0) then
  begin
    CheckID := FDBManager.CreateNewCheck(FDBManager.CurrentSchet, True, 'CASH');

    if CheckID > 0 then
    begin
      DMMag.QChek.Last;
      //rbCash.Checked := True;
      Log('‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ —Ç–∞ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –Ω–æ–≤–∏–π —á–µ–∫ ID: ' + IntToStr(CheckID));
    end
    else
      MessageDlg('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–µ–∫–∞!', mtError, [mbOk], 0);
  end
  else
    MessageDlg('–û–ø–µ—Ä–∞—Ü—ñ—è –Ω–µ–º–æ–∂–ª–∏–≤–∞ (—Ä–∞—Ö—É–Ω–æ–∫/–º—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è?)!', mtError, [mbOk], 0);

  (*FDBManager.SavedChekPos := FDBManager.CreateNewCheck(FDBManager.CurrentSchet);
    if FDBManager.SavedChekPos > 0 then
    begin
      Log('–ù–æ–≤–∏–π —á–µ–∫ ID: ' + IntToStr(FDBManager.SavedChekPos) + ', –ø–æ—Ç–æ—á–Ω–∏–π –≤ QChek: ' + IntToStr(DMMag.QChekKOD.AsInteger));
      nch := FDBManager.GetNextCheckNumber(FDBManager.CurrentSchet) + 1;  // –Ø–∫—â–æ +1 —Ä–æ–±–∏—Ç—å—Å—è —Ç—É—Ç
      FDBManager.AssignCheckNumber(FDBManager.SavedChekPos, nch, FDBManager.CurrentSchet);
    end; *)
end;

procedure TFmChek.BitBtn10Click(Sender: TObject);
var
  IsCashPayment: Boolean;
begin
  IsCashPayment := (DBComboPaymentType.Text = 'CASH');
  FDBManager.AddProductToCheck(IsCashPayment);
end;

procedure TFmChek.btnCheckEraseClick(Sender: TObject);
begin
    if not FDBManager.DeleteCheck then
      MessageDlg('–ß–µ–∫ –Ω–µ –≤–∏–¥–∞–ª–µ–Ω–æ!', mtError, [mbOk], 0);
end;




procedure TFmChek.BitBtn15Click(Sender: TObject);
begin
 FDBManager.VibSer;
end;

procedure TFmChek.BitBtn16Click(Sender: TObject);
var sk:integer;
begin
  if  (not DMMag.QChekKOD.IsNull) and
      (not DMMag.QNDataKOD.IsNull) and (not DMMag.QNSerKOD.IsNull) then
  begin
      FDBManager.SavPos;
      sk:=DMMag.QNSerKOD.AsInteger;
      FDBManager.ClsCon;
      DMMag.LaunchQuery(DMMag.SQLQ,DMMag.TrMag,'update serijnik set nak_data=null where kod='+inttostr(sk));
      FDBManager.OpnCon;
      FDBManager.RstPos;
  end
  else MessageDlg('–û–ø–µ—Ä–∞—Ü—ñ—è –Ω–µ–º–æ–∂–ª–∏–≤–∞!',mtError,[mbOk],0);
end;

procedure TFmChek.btnCheckPrintClick(Sender: TObject);
begin
  if not DBManagerReady then Exit;
  if FDBManager.CheckPrinting(pnazva) then
    begin
     frDBDataSet1.DataSource := DMMag.DSNData;
     frDBDataSet1.DataSet := DMMag.QNData;
     frReport1.LoadFromFile(reppath + '/chek.lrf');
     frReport1.ShowReport;
    end;
end;


procedure TFmChek.btnWarrantyClick(Sender: TObject);
var
  WarrantyDataSet: TDataSet;
begin
  // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ —á–µ—Ä–µ–∑ FDBManager
  WarrantyDataSet := FDBManager.GetWarrantyProducts(
    DMMag.QChekKOD.AsInteger,
    DMMag.QChekSCHET.AsInteger
  );

  if Assigned(WarrantyDataSet) then
  begin
    // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –∑–≤—ñ—Ç
    frDBDataSet1.DataSource := DMMag.DSGar; // –∞–±–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –æ–∫—Ä–µ–º–∏–π DataSource
    frDBDataSet1.DataSet := WarrantyDataSet;
    frReport1.LoadFromFile(reppath + '/gar_chek.lrf');
    frReport1.ShowReport;

    // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ DataSet —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä
    FDBManager.CloseWarrantyDataSet;
  end
  else
  begin
    MessageDlg('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≥–∞—Ä–∞–Ω—Ç—ñ–π–Ω—ñ —Ç–æ–≤–∞—Ä–∏', mtError, [mbOK], 0);
  end;
end;

procedure TFmChek.chkPreferTestCashRegisterClick(Sender: TObject);
begin
  SaveCashRegisterPreferences;

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≤–∏–±—Ä–∞—Ç–∏ –∫–∞—Å—É –∑–≥—ñ–¥–Ω–æ –Ω–æ–≤–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
  if Assigned(FReceiptAPI) and FReceiptAPI.IsTokenValid then
  begin
    btnRefreshCashRegisters.Click;
  end;

  Log('–ó–º—ñ–Ω–µ–Ω–æ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –∫–∞—Å–∏: PreferTest=' +
      BoolToStr(chkPreferTestCashRegister.Checked, True));
end;



procedure TFmChek.chkUseCheckboxAPIClick(Sender: TObject);
var
  ShiftStatus: TShiftStatus;
  Response: string;
  MsgResult: Integer;
begin
  // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∏–º –≤–∏–∫–ª–∏–∫–∞–º
  if FUpdatingCheckboxState then
    Exit;

  FUpdatingCheckboxState := True;
  try
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∑–Ω–∞—á–µ–Ω–Ω—è –¥—ñ–π—Å–Ω–æ –∑–º—ñ–Ω–∏–ª–æ—Å—è
    if chkUseCheckboxAPI.Checked = UseCheckboxAPI then
    begin
      // –ó–Ω–∞—á–µ–Ω–Ω—è –Ω–µ –∑–º—ñ–Ω–∏–ª–æ—Å—è - –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ
      Log('–°—Ç–∞–Ω—É Checkbox API –Ω–µ –∑–º—ñ–Ω–∏–≤—Å—è: ' + BoolToStr(UseCheckboxAPI, True));
      Exit;
    end;

    Log('–°–ø—Ä–æ–±–∞ –∑–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞–Ω Checkbox API: ' +
        BoolToStr(UseCheckboxAPI, True) + ' -> ' +
        BoolToStr(chkUseCheckboxAPI.Checked, True));

    // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –≤–∏–º–∫–Ω—É—Ç–∏ API
    if not chkUseCheckboxAPI.Checked then
    begin
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–∞—Å–∏—Ä —É–≤—ñ–π—à–æ–≤ –≤ —Å–∏—Å—Ç–µ–º—É
      if Assigned(FReceiptAPI) and FReceiptAPI.IsTokenValid then
      begin
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –≤—ñ–¥–∫—Ä–∏—Ç–∞ –∑–º—ñ–Ω–∞
        if FReceiptAPI.CurrentShiftId <> '' then
        begin
          // –°–ø—Ä–æ–±–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏
          if FReceiptAPI.GetShiftStatusCurl(FReceiptAPI.CurrentShiftId, Response, ShiftStatus) and
             Assigned(ShiftStatus) then
          begin
            try
              if ShiftStatus.Status = 'OPENED' then
              begin
                // –ó–º—ñ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞ - –∑–∞–ø–∏—Ç—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                MsgResult := MessageDlg('–ù–µ–º–æ–∂–ª–∏–≤–æ –≤–∏–º–∫–Ω—É—Ç–∏ Checkbox API',
                  '–£ –≤–∞—Å —î –≤—ñ–¥–∫—Ä–∏—Ç–∞ –∑–º—ñ–Ω–∞!' + sLineBreak + sLineBreak +
                  '–ù–æ–º–µ—Ä –∑–º—ñ–Ω–∏: ' + IntToStr(ShiftStatus.Serial) + sLineBreak +
                  'ID –∑–º—ñ–Ω–∏: ' + Copy(ShiftStatus.Id, 1, 8) + '...' + sLineBreak +
                  '–í—ñ–¥–∫—Ä–∏—Ç–∞: ' + DateTimeToStr(ShiftStatus.OpenedAt) + sLineBreak + sLineBreak +
                  '–î–ª—è –≤–∏–º–∫–Ω–µ–Ω–Ω—è API –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ:' + sLineBreak +
                  '1. –ó–∞–∫—Ä–∏—Ç–∏ –∑–º—ñ–Ω—É' + sLineBreak +
                  '2. –í–∏–π—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∏ (Logout)' + sLineBreak +
                  '3. –ü–æ—Ç—ñ–º –≤–∏–º–∫–Ω—É—Ç–∏ API',
                  mtWarning, [mbCancel], 0);

                // –°–∫–∞—Å–æ–≤—É—î–º–æ –∑–º—ñ–Ω—É —Å—Ç–∞–Ω—É —á–µ–∫–±–æ–∫—Å–∞
                chkUseCheckboxAPI.Checked := True;
                Log('–í–∏–º–∫–Ω–µ–Ω–Ω—è API —Å–∫–∞—Å–æ–≤–∞–Ω–æ - –≤—ñ–¥–∫—Ä–∏—Ç–∞ –∑–º—ñ–Ω–∞');
                Exit;
              end;
            finally
              FreeAndNil(ShiftStatus);
            end;
          end;
        end;

        // –ö–∞—Å–∏—Ä —É–≤—ñ–π—à–æ–≤, –∞–ª–µ –∑–º—ñ–Ω–∏ –Ω–µ–º–∞—î - –∑–∞–ø–∏—Ç—É—î–º–æ –ø—Ä–æ –≤–∏—Ö—ñ–¥
        MsgResult := MessageDlg('–£–≤–∞–≥–∞: –∫–∞—Å–∏—Ä –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π',
          '–í–∏ —É–≤—ñ–π—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É —è–∫ –∫–∞—Å–∏—Ä.' + sLineBreak + sLineBreak +
          '–î–ª—è –≤–∏–º–∫–Ω–µ–Ω–Ω—è API —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è:' + sLineBreak +
          '1. –í–∏–π—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∏ (–∫–Ω–æ–ø–∫–∞ Logout)' + sLineBreak +
          '2. –ü–æ—Ç—ñ–º –≤–∏–º–∫–Ω—É—Ç–∏ API' + sLineBreak + sLineBreak +
          '–í–∏–π—Ç–∏ –∑–∞—Ä–∞–∑ —ñ –≤–∏–º–∫–Ω—É—Ç–∏ API?',
          mtConfirmation, [mbYes, mbNo], 0);

        if MsgResult = mrYes then
        begin
          // –í–∏–∫–æ–Ω—É—î–º–æ –≤–∏—Ö—ñ–¥
          if FReceiptAPI.LogoutCurl(Response) then
          begin
            // –û–ß–ò–°–¢–ò–¢–ò –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Æ –ü–†–ò –í–ò–•–û–î–Ü
            FReceiptAPI.HandleAuthState(aaClear);
            Log('–ö–∞—Å–∏—Ä –≤–∏–π—à–æ–≤ –∑ —Å–∏—Å—Ç–µ–º–∏ –¥–ª—è –≤–∏–º–∫–Ω–µ–Ω–Ω—è API');
            ShowMessage('–í–∏—Ö—ñ–¥ –≤–∏–∫–æ–Ω–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ. –í–∏–º–∫–Ω–µ–Ω–Ω—è API...');
          end
          else
          begin
            Log('–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É: ' + Response);
            ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–π—Ç–∏: ' + Copy(Response, 1, 100));
            chkUseCheckboxAPI.Checked := True;
            Exit;
          end;
        end
        else
        begin
          // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥–º–æ–≤–∏–≤—Å—è –≤–∏—Ö–æ–¥–∏—Ç–∏ - —Å–∫–∞—Å–æ–≤—É—î–º–æ
          Log('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥–º–æ–≤–∏–≤—Å—è –≤–∏—Ö–æ–¥–∏—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∏');
          chkUseCheckboxAPI.Checked := True;
          Exit;
        end;
      end;
    end;

    // –Ø–∫—â–æ –¥—ñ–π—à–ª–∏ –¥–æ —Ü—å–æ–≥–æ –º–æ–º–µ–Ω—Ç—É - –º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Å—Ç–∞–Ω
    UseCheckboxAPI := chkUseCheckboxAPI.Checked;
    IniPropStorage1.WriteInteger('UseCheckboxAPI', Ord(UseCheckboxAPI));
    Log('–°—Ç–∞–Ω Checkbox API –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó: ' + BoolToStr(UseCheckboxAPI, True));
    UpdateAllStatuses;
    // –û–Ω–æ–≤–ª—é—î–º–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª
    ChangeCheckboxAPIFunctionality(UseCheckboxAPI);

    // –î–æ–¥–∞—Ç–∫–æ–≤–æ: —è–∫—â–æ API –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ, —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –π–æ–≥–æ
    if UseCheckboxAPI and not Assigned(FReceiptAPI) then
    begin
      try
        FReceiptAPI := TReceiptWebAPI.Create(
          edtBaseURL.Text,
          edtClientName.Text,
          edtClientVersion.Text,
          edtLicenseKey.Text,
          @Self.Log
        );
        Log('–ï–∫–∑–µ–º–ø–ª—è—Ä API —Å—Ç–≤–æ—Ä–µ–Ω–æ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó');

        // –ó–ê–í–ê–ù–¢–ê–ñ–ò–¢–ò –ó–ë–ï–†–ï–ñ–ï–ù–£ –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Æ –ü–†–ò –°–¢–í–û–†–ï–ù–ù–Ü API
        FReceiptAPI.HandleAuthState(aaLoad);

        // –°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó, —è–∫—â–æ —î –¥–∞–Ω—ñ
        if (edtUsername.Text <> '') and (edtPassword.Text <> '') then
        begin
          Log('–°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...');
          if FReceiptAPI.LoginCurl(edtUsername.Text, edtPassword.Text, Response) then
          begin
            Log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞');
            // –ó–ë–ï–†–ï–ì–¢–ò –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Æ –ü–Ü–°–õ–Ø –£–°–ü–Ü–®–ù–û–ì–û –í–•–û–î–£
            FReceiptAPI.HandleAuthState(aaSave);
          end
          else
          begin
            Log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –Ω–µ –≤–¥–∞–ª–∞—Å—è: ' + Response);
            // –û–ß–ò–°–¢–ò–¢–ò –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Æ –ü–†–ò –ù–ï–í–î–ê–õ–Ü–ô –°–ü–†–û–ë–Ü
            FReceiptAPI.HandleAuthState(aaClear);
          end;
        end;
      except
        on E: Exception do
        begin
          Log('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è API: ' + E.Message);
          // –û–ß–ò–°–¢–ò–¢–ò –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Æ –ü–†–ò –ü–û–ú–ò–õ–¶–Ü
          if Assigned(FReceiptAPI) then
            FReceiptAPI.HandleAuthState(aaClear);
          // –í—ñ–¥–∫–∞—Ç—É—î–º–æ –∑–º—ñ–Ω–∏
          UseCheckboxAPI := False;
          chkUseCheckboxAPI.Checked := False;
          IniPropStorage1.WriteInteger('UseCheckboxAPI', Ord(False));
          ChangeCheckboxAPIFunctionality(False);
          ShowMessage('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è API: ' + E.Message);
        end;
      end;
    end
    else if not UseCheckboxAPI and Assigned(FReceiptAPI) then
    begin
      // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è–º –ø–∞–º'—è—Ç—ñ
      if FReceiptAPI.IsTokenValid then
      begin
        Log('–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è API –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º—É —Ç–æ–∫–µ–Ω—ñ');
      end;

      // –û–ß–ò–°–¢–ò–¢–ò –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Æ –ü–ï–†–ï–î –ó–í–Ü–õ–¨–ù–ï–ù–ù–Ø–ú –ü–ê–ú'–Ø–¢–Ü
      FReceiptAPI.HandleAuthState(aaClear);

      // –ó–≤—ñ–ª—å–Ω—è—î–º–æ –ø–∞–º'—è—Ç—å API –ø—Ä–∏ –≤–∏–º–∫–Ω–µ–Ω–Ω—ñ
      FreeAndNil(FReceiptAPI);
      Log('–ï–∫–∑–µ–º–ø–ª—è—Ä API –∑–≤—ñ–ª—å–Ω–µ–Ω–æ –ø—Ä–∏ –≤–∏–º–∫–Ω–µ–Ω–Ω—ñ');

      // –û—á–∏—â–∞—î–º–æ —Å—Ç–∞–Ω –∑–º—ñ–Ω–∏
      ClearShiftState;
    end;

    Log('–ó–º—ñ–Ω–∞ —Å—Ç–∞–Ω—É Checkbox API –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ');

  finally
    FUpdatingCheckboxState := False;
  end;
end;


procedure TFmChek.cmbCashRegistersChange(Sender: TObject);
var
  SelectedIndex: Integer;
  SelectedCashRegister: TCashRegister;
begin
  if not ValidateAPIState(False, False, True) then // –ü–æ—Ç—Ä—ñ–±–µ–Ω —Å–ø–∏—Å–æ–∫ –∫–∞—Å
    Exit;
  SelectedIndex := cmbCashRegisters.ItemIndex;
  if (SelectedIndex < 0) or (SelectedIndex >= Length(FCashRegisters)) then
  begin
    Log('–ù–µ–≤—ñ—Ä–Ω–∏–π –≤–∏–±—ñ—Ä –∫–∞—Å–∏');
    Exit;
  end;

  SelectedCashRegister := FCashRegisters[SelectedIndex];

  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ –∞–∫—Ç–∏–≤–Ω–∞ –∫–∞—Å–∞?
  if not SelectedCashRegister.Active then
  begin
    ShowMessage('–û–±—Ä–∞–Ω–∞ –∫–∞—Å–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞! –û–±–µ—Ä—ñ—Ç—å —ñ–Ω—à—É.');
    Exit;
  end;

  // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –Ω–æ–≤—É –∫–∞—Å—É —è–∫ –ø–æ—Ç–æ—á–Ω—É
  FReceiptAPI.CurrentCashRegisterId := SelectedCashRegister.Id;
  edtCashRegisterId.Text := SelectedCashRegister.Id;

  // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
  UpdateCashRegisterStatus(svReady);
  // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤–∏–±—ñ—Ä (—É INI)
  SaveCashRegisterPreferences;
  UpdateAllStatuses;

  Log('–ö–∞—Å—É –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞: ' + SelectedCashRegister.FiscalNumber);

  // –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ –∑–º—ñ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞)
  if FReceiptAPI.CurrentShiftId <> '' then
    btnGetShiftStatusCurl.Click;  // –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏ –¥–ª—è –Ω–æ–≤–æ—ó –∫–∞—Å–∏
end;

procedure TFmChek.DBComboPaymentTypeChange(Sender: TObject);
var
  NewType: string;
begin
  // –í–∏—Ö–æ–¥–∏–º–æ, —è–∫—â–æ —Ü–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∑–º—ñ–Ω–∞ –ø—Ä–∏ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
  if not DBComboPaymentType.Focused then Exit;
  if FUpdatingPaymentType then Exit;
  FUpdatingPaymentType := True;
  try
    NewType := DBComboPaymentType.Text;
    Log('=== DBComboPaymentTypeChange (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–º—ñ–Ω–∏–≤) ===');
    Log('NewType: ' + NewType);
    if not FDBManager.CanModifyCheck then
    begin
      DBComboPaymentType.Text := FDBManager.GetCurrentPaymentType;
      Exit;
    end;
    Log('–û–±—Ä–æ–±–ª—è—î–º–æ: ' + NewType);
    case NewType of
      'CASH':
        begin
          Log('–í–∏–∫–ª–∏–∫ UpdatePaymentInfoToCash');
          FDBManager.UpdatePaymentInfoToCash;
        end;
      'CARD':
        begin
          Log('–í–∏–∫–ª–∏–∫ UpdatePaymentInfoToCard');
          FDBManager.UpdatePaymentInfoToCard;
        end;
      {'MIXED':
        begin
          Log('–í–∏–∫–ª–∏–∫ UpdatePaymentInfoToMixed');
          // –Ø–∫—â–æ –Ω–µ–º–∞—î —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ –º–µ—Ç–æ–¥—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ ChangePaymentType –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
          // –ù–∞–ø—Ä–∏–∫–ª–∞–¥: –∑–∞–ø–∏—Ç —Å—É–º–∏ —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∞–±–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
          // –¢—É—Ç –ø—Ä–∏–ø—É—Å—Ç–∏–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –º–µ—Ç–æ–¥—É; –∞–¥–∞–ø—Ç—É–π—Ç–µ –∑–∞ –ø–æ—Ç—Ä–µ–±–æ—é
          ChangePaymentType(FDBManager.CurrentCheckID, 'MIXED',
            // –ü—Ä–∏–∫–ª–∞–¥: –ø–æ–ª–æ–≤–∏–Ω—É –≥–æ—Ç—ñ–≤–∫–æ—é, –ø–æ–ª–æ–≤–∏–Ω—É –∫–∞—Ä—Ç–∫–æ—é - —Ä–µ–∞–ª—ñ–∑—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
            FDBManager.GetCheckTotal(FDBManager.CurrentCheckID) / 2,
            FDBManager.GetCheckTotal(FDBManager.CurrentCheckID) / 2,
            'Mixed payment info');
        end;  }
    end;
  finally
    FUpdatingPaymentType := False;
  end;
end;



procedure TFmChek.DBGrid1DrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumn; State: TGridDrawState);
var
  BaseBrushColor, BaseFontColor: TColor;
  BaseFontStyle: TFontStyles;
  FiscalStatus: string;
begin
  BaseBrushColor := clWindow;
  BaseFontColor := clWindowText;
  BaseFontStyle := [];

  if not DMMag.QChekFISCAL_STATUS.IsNull then
    FiscalStatus := DMMag.QChekFISCAL_STATUS.AsString
  else
    FiscalStatus := '';

  FiscalStatus := UpperCase(Trim(FiscalStatus));

  case FiscalStatus of
    'NON_FISCAL', '':
      begin
        BaseBrushColor := clWindow;
        BaseFontColor := clWindowText;
      end;
    'DONE':
      begin
        BaseBrushColor := clMoneyGreen;
        BaseFontColor := clGreen;
      end;
    'PENDING':
      begin
        BaseBrushColor := clWindow;
        BaseFontColor := clBlue;
      end;
    'ERROR':
      begin
        BaseBrushColor := $00E1E4FF; // Light pink (MistyRose)
        BaseFontColor := clRed;
      end;
  end;

  if gdSelected in State then
  begin
    DBGrid1.Canvas.Brush.Color := clSkyBlue;
    DBGrid1.Canvas.Font.Color := BaseFontColor;
    DBGrid1.Canvas.Font.Style := BaseFontStyle + [fsBold];
  end
  else
  begin
    DBGrid1.Canvas.Brush.Color := BaseBrushColor;
    DBGrid1.Canvas.Font.Color := BaseFontColor;
    DBGrid1.Canvas.Font.Style := BaseFontStyle;
  end;

  DBGrid1.Canvas.FillRect(Rect);
  DBGrid1.DefaultDrawColumnCell(Rect, DataCol, Column, State);
end;

procedure TFmChek.btnCheckCancelClick(Sender: TObject);
var
  CurrentNumber: Integer;
begin
  if not DBManagerReady then Exit;
  if FDBManager.CurrentSchet <= 0 then Exit;
  if DMMag.QChek.IsEmpty then Exit;
  if DMMag.QChekNOMER.IsNull then Exit;
  CurrentNumber := DMMag.QChekNOMER.AsInteger;
  if MessageDlg('–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏ —á–µ–∫ ‚Ññ' + IntToStr(CurrentNumber) + ' ?',
                mtWarning, [mbYes, mbNo], 0) = mrYes then
  begin
   FDBManager.CancelCheckNumber(DMMag.QChekKOD.AsInteger, FDBManager.CurrentSchet);
  end;
end;

procedure TFmChek.btnCreateNonFiscalCheckClick(Sender: TObject);
var
  CheckID: Integer;
begin
  if (FDBManager.CurrentSchet > 0) then
  begin
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–µ–Ω–µ–¥–∂–µ—Ä –ë–î –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ª—É–∂–±–æ–≤–æ–≥–æ —á–µ–∫–∞
    CheckID := FDBManager.CreateNewCheck(FDBManager.CurrentSchet, False, 'CASH', '–°–õ–£–ñ–ë–û–í–ò–ô –ß–ï–ö');

    if CheckID > 0 then
    begin
      // –û–Ω–æ–≤–∏—Ç–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      DMMag.QChek.Last;

      Log('‚úÖ –°–ª—É–∂–±–æ–≤–∏–π —á–µ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–æ ID: ' + IntToStr(CheckID));
      ShowMessage('–°–ª—É–∂–±–æ–≤–∏–π —á–µ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–æ - —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏–º–µ—Ç—å—Å—è');
    end
    else
    begin
      MessageDlg('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ª—É–∂–±–æ–≤–æ–≥–æ —á–µ–∫–∞!', mtError, [mbOk], 0);
    end;
  end
  else
    MessageDlg('–û–ø–µ—Ä–∞—Ü—ñ—è –Ω–µ–º–æ–∂–ª–∏–≤–∞ (—Ä–∞—Ö—É–Ω–æ–∫/–º—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è?)!', mtError, [mbOk], 0);
end;

procedure TFmChek.btnFindCashRegisterClick(Sender: TObject);
var
  Response, CashRegisterId: string;
  Success: Boolean;
begin
  if not ValidateAPIState(False, False, True) then // –ü–æ—Ç—Ä—ñ–±–µ–Ω —Å–ø–∏—Å–æ–∫ –∫–∞—Å
      Exit;

  Success := FReceiptAPI.FindCashRegisterByFiscalNumber(
    edtFiscalCode.Text,
    CashRegisterId,
    Response
  );

  if Success then
  begin
    edtCashRegisterId.Text := CashRegisterId;
    SaveCashRegisterId(CashRegisterId); // –î–û–î–ê–ù–û: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
    Log('–ó–Ω–∞–π–¥–µ–Ω–æ –∫–∞—Å—É: ' + CashRegisterId);
  end
  else
  begin
    Log('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –∫–∞—Å—É: ' + Response);
  end;
end;


procedure TFmChek.btnForsedShiftCloseClick(Sender: TObject);
var
  Response: string;
  ShiftStatus: TShiftStatus;
  MsgResult: Integer;
  StartTime: TDateTime;
begin
  if not ValidateAPIState(True, False) then  // RequireShift = True
    Exit;
  // –ó–∞–ø–∏—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
  MsgResult := MessageDlg('–ü—Ä–∏–º—É—Å–æ–≤–µ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏',
    '–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø—Ä–∏–º—É—Å–æ–≤–æ –∑–∞–∫—Ä–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω—É –∑–º—ñ–Ω—É?' + sLineBreak +
    '–¶—è –æ–ø–µ—Ä–∞—Ü—ñ—è –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –≤—Ç—Ä–∞—Ç–∏ –¥–∞–Ω–∏—Ö!',
    mtWarning, [mbYes, mbNo], 0);

  if MsgResult <> mrYes then
    Exit;

  btnForsedShiftClose.Enabled := False;
  Screen.Cursor := crHourGlass;
  ShiftStatus := nil;
  StartTime := Now;

  try
    Log('=== –ü–û–ß–ê–¢–û–ö –ü–†–ò–ú–£–°–û–í–û–ì–û –ó–ê–ö–†–ò–¢–¢–Ø –ó–ú–Ü–ù–ò ===');

    // 1. –ü–†–ê–í–ò–õ–¨–ù–ò–ô –í–ò–ö–õ–ò–ö –ë–ï–ó ShiftId
    if FReceiptAPI.CloseCurrentShiftCurl(Response, ShiftStatus) then
    begin
      if Assigned(ShiftStatus) then
      begin
        // 2. –û–ë–†–û–ë–ö–ê –†–Ü–ó–ù–ò–• –°–¢–ê–¢–£–°–Ü–í
        case ShiftStatus.Status of
          'DONE', 'CLOSED':
          begin
            UpdateShiftStatus(svClosed);
            Log('–ó–º—ñ–Ω–∞ –∑–∞–∫—Ä–∏—Ç–∞ —É—Å–ø—ñ—à–Ω–æ! –°—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
            Log('Z-–∑–≤—ñ—Ç: ' + ShiftStatus.ZReport);
            Log('–ß–∞—Å –∑–∞–∫—Ä–∏—Ç—Ç—è: ' + DateTimeToStr(ShiftStatus.ClosedAt));

            // –û—á–∏—â–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—É –∑–º—ñ–Ω—É
            FReceiptAPI.CurrentShiftId := '';
            FReceiptAPI.SaveShiftIdToFile;

            {ShowMessage('–ó–º—ñ–Ω—É —É—Å–ø—ñ—à–Ω–æ –∑–∞–∫—Ä–∏—Ç–æ!' + sLineBreak +
                       'Z-–∑–≤—ñ—Ç: ' + ShiftStatus.ZReport);}
          end;

          'CLOSING':
          begin
            Log('–ó–º—ñ–Ω–∞ –≤ –ø—Ä–æ—Ü–µ—Å—ñ –∑–∞–∫—Ä–∏—Ç—Ç—è. –°—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
            Log('–û—á—ñ–∫—É—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∑–∞–∫—Ä–∏—Ç—Ç—è...');

            // –û–ß–Ü–ö–£–Ñ–ú–û –ó–ê–í–ï–†–®–ï–ù–ù–Ø –ó–ê–ö–†–ò–¢–¢–Ø
            FreeAndNil(ShiftStatus);
            if FReceiptAPI.WaitForShiftStatus(FReceiptAPI.CurrentShiftId, 'CLOSED',
               Response, ShiftStatus, 60) then
            begin
              if Assigned(ShiftStatus) then
              begin
                Log('–ó–º—ñ–Ω—É —É—Å–ø—ñ—à–Ω–æ –∑–∞–∫—Ä–∏—Ç–æ! –°—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
                FReceiptAPI.CurrentShiftId := '';
                FReceiptAPI.SaveShiftIdToFile;
                {ShowMessage('–ó–º—ñ–Ω—É —É—Å–ø—ñ—à–Ω–æ –∑–∞–∫—Ä–∏—Ç–æ!');}
              end;
            end
            else
            begin
              ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏: ' + Copy(Response, 1, 100));
            end;
          end;

          'PENDING':
          begin
            Log('–ó–º—ñ–Ω–∞ –≤ –ø—Ä–æ—Ü–µ—Å—ñ –∑–∞–∫—Ä–∏—Ç—Ç—è. –°—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
            ShowMessage('–ó–º—ñ–Ω–∞ –≤ –ø—Ä–æ—Ü–µ—Å—ñ –∑–∞–∫—Ä–∏—Ç—Ç—è. –û—á—ñ–∫—É–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è...');
          end;

          'ERROR':
          begin
            Log('–ü–æ–º–∏–ª–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏. –°—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
            ShowMessage('–ü–æ–º–∏–ª–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
          end;
        else
          Log('–ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
          ShowMessage('–û—Ç—Ä–∏–º–∞–Ω–æ –Ω–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
        end;
      end;
    end
    else
    begin
      // 3. –î–ï–¢–ê–õ–¨–ù–ê –û–ë–†–û–ë–ö–ê –ü–û–ú–ò–õ–û–ö
      Log('–ü–æ–º–∏–ª–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏: ' + Response);

      if Pos('no open shift', LowerCase(Response)) > 0 then
      begin
        ShowMessage('–í—ñ–¥–∫—Ä–∏—Ç–∏—Ö –∑–º—ñ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        // –û—á–∏—â–∞—î–º–æ –Ω–∞ –≤—Å—è–∫–∏–π –≤–∏–ø–∞–¥–æ–∫
        FReceiptAPI.CurrentShiftId := '';
        FReceiptAPI.SaveShiftIdToFile;
      end
      else if Pos('already closed', LowerCase(Response)) > 0 then
      begin
        ShowMessage('–ó–º—ñ–Ω–∞ –≤–∂–µ –∑–∞–∫—Ä–∏—Ç–∞');
        FReceiptAPI.CurrentShiftId := '';
        FReceiptAPI.SaveShiftIdToFile;
      end
      else
      begin
        ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–∫—Ä–∏—Ç–∏ –∑–º—ñ–Ω—É: ' + Copy(Response, 1, 150));
      end;
    end;

  finally
    if Assigned(ShiftStatus) then
      FreeAndNil(ShiftStatus);
    btnForsedShiftClose.Enabled := True;
    Screen.Cursor := crDefault;
    Log('=== –ó–ê–í–ï–†–®–ï–ù–ù–Ø –ü–†–ò–ú–£–°–û–í–û–ì–û –ó–ê–ö–†–ò–¢–¢–Ø ===');
    Log('–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: ' + IntToStr(SecondsBetween(Now, StartTime)) + ' —Å–µ–∫');
  end;
end;

procedure TFmChek.btnGetCashRegisterStatusCurlClick(Sender: TObject);
var
  Response: string;
  CashRegisterStatus: TCashRegisterStatus;
  Success: Boolean;
begin
  if not ValidateAPIState(False, True) then  // RequireCashRegister = True
    Exit;

  // –î–û–î–ê–ù–û: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è ID –∫–∞—Å–∏, —è–∫—â–æ –ø–æ–ª–µ –ø–æ—Ä–æ–∂–Ω—î
  if edtCashRegisterId.Text = '' then
  begin
    Log('–ü–æ–ª–µ ID –∫–∞—Å–∏ –ø–æ—Ä–æ–∂–Ω—î, —Å–ø—Ä–æ–±–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è...');
    if FReceiptAPI.InitializeFirstCashRegister(Response) then
    begin
      edtCashRegisterId.Text := FReceiptAPI.CurrentCashRegisterId;
      Log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ç—Ä–∏–º–∞–Ω–æ ID –∫–∞—Å–∏: ' + FReceiptAPI.CurrentCashRegisterId);
    end
    else
    begin
      Log('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ ID –∫–∞—Å–∏: ' + Response);
      ShowMessage('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å ID –∫–∞—Å–∏ –∞–±–æ –≤–∏–∫–æ–Ω–∞–π—Ç–µ –ø–æ—à—É–∫ –∫–∞—Å–∏');
      Exit;
    end;
  end;

  if not FReceiptAPI.IsTokenValid then
  begin
    Log('–¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π! –°–ø—Ä–æ–±—É–π—Ç–µ —É–≤—ñ–π—Ç–∏ –∑–Ω–æ–≤—É.');
    ShowMessage('–¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –£–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
    Exit;
  end;

  if edtCashRegisterId.Text = '' then
  begin
    Log('–í–≤–µ–¥—ñ—Ç—å ID –∫–∞—Å–∏!');
    ShowMessage('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å ID –∫–∞—Å–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å—É');
    Exit;
  end;

  try
    Log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –∫–∞—Å–∏ —á–µ—Ä–µ–∑ CURL...');
    Log('ID –∫–∞—Å–∏: ' + edtCashRegisterId.Text);

    // –í–∏–∫–ª–∏–∫–∞—î–º–æ –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å—É –∫–∞—Å–∏ —á–µ—Ä–µ–∑ CURL
    Success := FReceiptAPI.GetCashRegisterStatusCurl(
      edtCashRegisterId.Text,  // ID –∫–∞—Å–∏
      Response,                // –í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞
      CashRegisterStatus       // –û–±'—î–∫—Ç –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º
    );

    if Success and Assigned(CashRegisterStatus) then
    begin
      // –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —Ä–µ–∂–∏–º—ñ–≤
      Log('–†–µ–∂–∏–º –æ—Ñ–ª–∞–π–Ω: ' + BoolToStr(CashRegisterStatus.OfflineMode, True));
      Log('–ó–∞–ª–∏—à–∞—Ç–∏—Å—è –≤ –æ—Ñ–ª–∞–π–Ω—ñ: ' + BoolToStr(CashRegisterStatus.StayOffline, True));
      Log('–¢–µ—Å—Ç–æ–≤–∞ –∫–∞—Å–∞: ' + BoolToStr(CashRegisterStatus.IsTest, True));



      Log('‚úÖ –°—Ç–∞—Ç—É—Å –∫–∞—Å–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ —á–µ—Ä–µ–∑ CURL!');
      Log('ID: ' + CashRegisterStatus.Id);
      Log('–§—ñ—Å–∫–∞–ª—å–Ω–∏–π –Ω–æ–º–µ—Ä: ' + CashRegisterStatus.FiscalNumber);
      Log('–ù–æ–º–µ—Ä –∫–∞—Å–∏: ' + CashRegisterStatus.Number);
      Log('–ê–∫—Ç–∏–≤–Ω–∞: ' + BoolToStr(CashRegisterStatus.Active, True));
      Log('–°—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏: ' + CashRegisterStatus.ShiftStatus);
      Log('–ü–æ—Ç–æ—á–Ω–∏–π –Ω–æ–º–µ—Ä –∑–º—ñ–Ω–∏: ' + IntToStr(CashRegisterStatus.CurrentShiftNumber));
      Log('–û—Å—Ç–∞–Ω–Ω—ñ–π Z-–∑–≤—ñ—Ç: ' + DateTimeToStr(CashRegisterStatus.LastZReportDate));
      Log('–°—Ç–≤–æ—Ä–µ–Ω–æ: ' + DateTimeToStr(CashRegisterStatus.CreatedAt));
      Log('–û–Ω–æ–≤–ª–µ–Ω–æ: ' + DateTimeToStr(CashRegisterStatus.UpdatedAt));

      // –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Å—Ç–∞–Ω
      if CashRegisterStatus.Active then
      begin
        Log('‚úÖ –ö–∞—Å–∞ –∞–∫—Ç–∏–≤–Ω–∞');
        if CashRegisterStatus.ShiftStatus = 'OPENED' then
        begin
          Log('‚ö†Ô∏è  –ó–º—ñ–Ω–∞ –≤–∂–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞!');
        end
        else if CashRegisterStatus.ShiftStatus = 'CLOSED' then
          Log('‚úÖ –ö–∞—Å–∞ –≥–æ—Ç–æ–≤–∞ –¥–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –Ω–æ–≤–æ—ó –∑–º—ñ–Ω–∏');
      end
      else
      begin
        Log('‚ùå –ö–∞—Å–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞');
      end;
      // –ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
      if CashRegisterStatus.Active
         then UpdateCashRegisterStatus(svOnline, CashRegisterStatus.FiscalNumber)
         else UpdateCashRegisterStatus(svError, '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞');
      // –ó–≤—ñ–ª—å–Ω—è—î–º–æ –ø–∞–º'—è—Ç—å
      FreeAndNil(CashRegisterStatus);
    end
    else
    begin
      UpdateCashRegisterStatus(svError);
      Log('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –∫–∞—Å–∏ —á–µ—Ä–µ–∑ CURL');
      Log('–í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞: ' + Response);

      // –î–µ—Ç–∞–ª—å–Ω—ñ—à–∞ –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
      if Pos('"message":"', Response) > 0 then
        Log('–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É: ' + Response)
      else if Pos('Not Found', Response) > 0 then
        Log('–ö–∞—Å—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ ID –∫–∞—Å–∏.')
      else if Pos('Unauthorized', Response) > 0 then
        Log('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π.');
      ShowMessage('–ü–æ–º–∏–ª–∫–∞: ' + Copy(Response, 1, 200));
      UpdateCashRegisterStatus(svError);
    end;

  except
    on E: Exception do
    begin
      Log('‚ùå –í–∏–Ω—è—Ç–æ–∫ –ø—Ä–∏ CURL –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ —Å—Ç–∞—Ç—É—Å—É –∫–∞—Å–∏: ' + E.Message);
      Log('–¢–∏–ø –ø–æ–º–∏–ª–∫–∏: ' + E.ClassName);
      ShowMessage('–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞: ' + E.Message);
    end;
  end;
  UpdateAllStatuses;
end;

procedure TFmChek.btnLoginCurlClick(Sender: TObject);
var
  Response: string;
  Success: Boolean;
begin
  if not UseCheckboxAPI then
  begin
    ShowMessage('–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª Checkbox API –≤–∏–º–∫–Ω–µ–Ω–æ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö');
    Exit;
  end;
  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∂–µ —ñ—Å–Ω—É—î –µ–∫–∑–µ–º–ø–ª—è—Ä API
  if Assigned(FReceiptAPI) then
    FreeAndNil(FReceiptAPI);

  try
    // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä API –∑ –ª—ñ—Ü–µ–Ω–∑—ñ–π–Ω–∏–º –∫–ª—é—á–µ–º
    FReceiptAPI := TReceiptWebAPI.Create(
      edtBaseURL.Text,      // –ë–∞–∑–æ–≤–∏–π URL API
      edtClientName.Text,   // –ù–∞–∑–≤–∞ –∫–ª—ñ—î–Ω—Ç–∞
      edtClientVersion.Text, // –í–µ—Ä—Å—ñ—è –∫–ª—ñ—î–Ω—Ç–∞
      edtLicenseKey.Text,    // –õ—ñ—Ü–µ–Ω–∑—ñ–π–Ω–∏–π –∫–ª—é—á
      @Self.Log // –ü–µ—Ä–µ–¥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –º–µ—Ç–æ–¥ Log
    );

    Log('–°—Ç–≤–æ—Ä–µ–Ω–æ –µ–∫–∑–µ–º–ø–ª—è—Ä TReceiptWebAPI');

    // –í–∏–∫–æ–Ω—É—î–º–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é —á–µ—Ä–µ–∑ CURL
    Success := FReceiptAPI.LoginCurl(
      edtUsername.Text, // –Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
      edtPassword.Text, // –ü–∞—Ä–æ–ª—å
      Response          // –í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞
    );

    if Success then
    begin
      // –û–Ω–æ–≤–∏—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–∞—Å–∏—Ä–∞
      UpdateCashierInfo;
      FReceiptAPI.HandleAuthState(aaSave);
      Log('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ CURL —É—Å–ø—ñ—à–Ω–∞!');
      Log('–¢–æ–∫–µ–Ω: ' + Copy(FReceiptAPI.AuthToken, 1, 20) + '...'); // –õ–æ–≥—É—î–º–æ —á–∞—Å—Ç–∏–Ω—É —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –±–µ–∑–ø–µ–∫–∏
      // –ê–∫—Ç–∏–≤—É—î–º–æ –∫–Ω–æ–ø–∫–∏, —è–∫—ñ –≤–∏–º–∞–≥–∞—é—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
      btbtnSendReceiptCurl.Enabled := True;
      btnLogoutCurl.Enabled := True;
      btnGetCashRegisterStatusCurl.Enabled := True;
      btnOpenShiftCurl.Enabled := True;
      btnGetShiftStatusCurl.Enabled := True;
      btnCloseShiftSimpleCurl.Enabled := True;
      btnCloseShiftWithReportCurl.Enabled := True;
      UpdateCashierStatus(svOnline, '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ');
    end
    else
    begin
      Log('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ CURL: ' + Response);
      ShowMessage('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ CURL: ' + Response);
      UpdateCashierStatus(svError, '–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó');
    end;

  except
    on E: Exception do
    begin
      Log('–í–∏–Ω—è—Ç–æ–∫ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ CURL: ' + E.Message);
      ShowMessage('–ü–æ–º–∏–ª–∫–∞: ' + E.Message);
    end;
  end;
  UpdateAllStatuses;
end;



procedure TFmChek.btnSaveSettingsClick(Sender: TObject);
begin
  SaveSettings;
  SaveCashRegisterPreferences; // –î–æ–¥–∞—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∫–∞—Å–∏
  ShowMessage('–í—Å—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!');
end;

procedure TFmChek.btnLogoutCurlClick(Sender: TObject);
var
  Response: string;
  Success: Boolean;
begin
  if not UseCheckboxAPI then
  begin
    ShowMessage('–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª Checkbox API –≤–∏–º–∫–Ω–µ–Ω–æ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö');
    Exit;
  end;
  if not Assigned(FReceiptAPI) then
  begin
    Log('API –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ!');
    Exit;
  end;

  // –í–∏–∫–æ–Ω—É—î–º–æ –≤–∏—Ö—ñ–¥ —á–µ—Ä–µ–∑ CURL
  Success := FReceiptAPI.LogoutCurl(Response);

  if Success then
  begin
    FReceiptAPI.HandleAuthState(aaClear);
    Log('–í–∏—Ö—ñ–¥ —á–µ—Ä–µ–∑ CURL —É—Å–ø—ñ—à–Ω–∏–π!');
    FReceiptAPI.HandleAuthState(aaClear);
    // –û—á–∏—Å—Ç–∏—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–∞—Å–∏—Ä–∞
    ClearCashierInfo;
    // –î–µ–∞–∫—Ç–∏–≤—É—î–º–æ –∫–Ω–æ–ø–∫–∏, —è–∫—ñ –≤–∏–º–∞–≥–∞—é—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
    btbtnSendReceiptCurl.Enabled := False;
    btnLogoutCurl.Enabled := False;
    UpdateCashierStatus(svUnknown);
    UpdateShiftStatus(svUnknown);
  end
  else
  begin
    Log('–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É —á–µ—Ä–µ–∑ CURL: ' + Response);
    ShowMessage('–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É —á–µ—Ä–µ–∑ CURL: ' + Response);
  end;
  UpdateAllStatuses;
end;

procedure TFmChek.btnOpenShiftClick(Sender: TObject);
var
  Response: string;
  Success: Boolean;
  ACashRegisterStatus: TCashRegisterStatus;
begin
  // –ó–∞–≥–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É API
  if not ValidateAPIState(False, True) then  // RequireCashRegister = True
    Exit;

  // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å - –ø–æ—á–∞—Ç–æ–∫ –æ–ø–µ—Ä–∞—Ü—ñ—ó
  UpdateShiftStatus(svProcessing);
  btnOpenShift.Enabled := False;
  Screen.Cursor := crHourGlass;
  ACashRegisterStatus := nil;

  try
    try
      // –ö–†–û–ö 1: –ü–µ—Ä–µ—Ö—ñ–¥ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º
      Log('=== –ö–†–û–ö 1: –ü–µ—Ä–µ—Ö—ñ–¥ –∫–∞—Å–∏ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º ===');
      Success := FReceiptAPI.GoOfflineCurl(Response);

      if not Success then
      begin
        Log('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º: ' + Response);
        UpdateCashRegisterStatus(svError);
        if Pos('"message":"', Response) > 0 then
          Log('–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É: ' + Response)
        else if Pos('Not Found', Response) > 0 then
          Log('–ö–∞—Å—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ ID –∫–∞—Å–∏.')
        else if Pos('Unauthorized', Response) > 0 then
          Log('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π.');

        ShowMessage('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º: ' + Copy(Response, 1, 200));
        Exit;
      end;

      Log('‚úÖ –ö–∞—Å—É —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º!');
      // –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è —Å—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—ó
      Sleep(1000);

      // –ö–†–û–ö 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É –∫–∞—Å–∏ –ø—ñ—Å–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –≤ –æ—Ñ–ª–∞–π–Ω
      Log('=== –ö–†–û–ö 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É –∫–∞—Å–∏ ===');
      if not FReceiptAPI.GetCashRegisterStatusCurl(FReceiptAPI.CurrentCashRegisterId, Response, ACashRegisterStatus) then
      begin
        Log('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –∫–∞—Å–∏ –ø—ñ—Å–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –≤ –æ—Ñ–ª–∞–π–Ω');
        UpdateCashRegisterStatus(svError);
        ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞–Ω –∫–∞—Å–∏ –ø—ñ—Å–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –≤ –æ—Ñ–ª–∞–π–Ω');
        Exit;
      end;

      try
        if Assigned(ACashRegisterStatus) then
        begin
          Log('–°—Ç–∞—Ç—É—Å –∫–∞—Å–∏ –ø—ñ—Å–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –≤ –æ—Ñ–ª–∞–π–Ω:');
          Log(' - OfflineMode: ' + BoolToStr(ACashRegisterStatus.OfflineMode, True));
          Log(' - StayOffline: ' + BoolToStr(ACashRegisterStatus.StayOffline, True));
          Log(' - ShiftStatus: ' + ACashRegisterStatus.ShiftStatus);

          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –∫–∞—Å–∞ –¥—ñ–π—Å–Ω–æ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—ñ
          if not ACashRegisterStatus.OfflineMode then
          begin
            Log('‚ùå –ö–∞—Å–∞ –Ω–µ –ø–µ—Ä–µ–π—à–ª–∞ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º');
            UpdateCashRegisterStatus(svError);
            ShowMessage('–ö–∞—Å–∞ –Ω–µ –ø–µ—Ä–µ–π—à–ª–∞ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
            Exit;
          end;

          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –∑–º—ñ–Ω–∏
          if ACashRegisterStatus.ShiftStatus = 'OPENED' then
          begin
            UpdateShiftStatus(svOpened);
            Log('‚ÑπÔ∏è –ó–º—ñ–Ω–∞ –≤–∂–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞!');
            FReceiptAPI.CurrentShiftId := FReceiptAPI.GetCurrentShiftIdCurl(Response);
            if FReceiptAPI.CurrentShiftId <> '' then
            begin
              edtShiftId.Text := FReceiptAPI.CurrentShiftId;
              ShowMessage('–ó–º—ñ–Ω–∞ –≤–∂–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞! –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø–æ—Ç–æ—á–Ω–∞ –∑–º—ñ–Ω–∞: ' + FReceiptAPI.CurrentShiftId);
              Exit; // –ó–º—ñ–Ω–∞ –≤–∂–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞ - –≤–∏—Ö–æ–¥–∏–º–æ
            end;
          end;
        end;
      finally
        FreeAndNil(ACashRegisterStatus);
      end;

      Log('‚úÖ –°—Ç–∞—Ç—É—Å –∫–∞—Å–∏ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ - –≥–æ—Ç–æ–≤–∞ –¥–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏');
      UpdateCashRegisterStatus(svReady);

      // –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è–º –∑–º—ñ–Ω–∏
      Sleep(1000);

      // –ö–†–û–ö 3: –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—ñ
      Log('=== –ö–†–û–ö 3: –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—ñ ===');
      // –í–∏–∫–ª–∏–∫–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –º–µ—Ç–æ–¥ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏
      btnOpenShiftCurlClick(Sender);

      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∑–º—ñ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–∫—Ä–∏—Ç–∞
      if FReceiptAPI.CurrentShiftId <> '' then
      begin
        UpdateShiftStatus(svOpened);
        Log('‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!');

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –Ω–∞–∑–∞–¥ –≤ –æ–Ω–ª–∞–π–Ω (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
        Log('=== –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –≤ –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º ===');
        Success := FReceiptAPI.GoOnlineCurl(Response);
        if Success and (Pos('"status":"ok"', Response) > 0) then
        begin
          Log('‚úÖ –ö–∞—Å—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –Ω–∞–∑–∞–¥ –≤ –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º!');
          UpdateCashRegisterStatus(svOnline);
        end
        else
        begin
          Log('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∫–∞—Å—É –≤ –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º: ' + Response);
          UpdateCashRegisterStatus(svReady, '–û—Ñ–ª–∞–π–Ω');
          ShowMessage('–ó–º—ñ–Ω—É —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–∫—Ä–∏—Ç–æ!' + sLineBreak +
                     '–î–ª—è —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó —á–µ–∫—ñ–≤ –ø–µ—Ä–µ–≤–µ–¥—ñ—Ç—å –∫–∞—Å—É –≤ –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º.');
        end;
      end
      else
      begin
        Log('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ –∑–º—ñ–Ω—É');
        UpdateShiftStatus(svError);
      end;

    except
      on E: Exception do
      begin
        Log('‚ùå –í–∏–Ω—è—Ç–æ–∫ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–º—É –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –∑–º—ñ–Ω–∏: ' + E.Message);
        Log('–¢–∏–ø –ø–æ–º–∏–ª–∫–∏: ' + E.ClassName);
        UpdateShiftStatus(svError);
        UpdateCashRegisterStatus(svError);
        ShowMessage('–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –∑–º—ñ–Ω–∏: ' + E.Message);
      end;
    end;
  finally
    btnOpenShift.Enabled := True;
    Screen.Cursor := crDefault;

    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –∫–∞—Å–∏ —á–µ—Ä–µ–∑ –ø—Ä—è–º–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –∞ –Ω–µ –∫–ª—ñ–∫ –ø–æ –∫–Ω–æ–ø—Ü—ñ
    if Assigned(FReceiptAPI) and (FReceiptAPI.CurrentCashRegisterId <> '') then
    begin
      if FReceiptAPI.GetCashRegisterStatusCurl(FReceiptAPI.CurrentCashRegisterId, Response, ACashRegisterStatus) then
      begin
        try
          if Assigned(ACashRegisterStatus) then
          begin
            if ACashRegisterStatus.Active then
              UpdateCashRegisterStatus(svOnline, ACashRegisterStatus.Number)
            else
              UpdateCashRegisterStatus(svError);
          end;
        finally
          FreeAndNil(ACashRegisterStatus);
        end;
      end;
    end;
  end;
end;

procedure TFmChek.btnSendReceiptClick(Sender: TObject);
var
  Receipt: TReceipt;
  Good: TGood;
  GoodItem: TGoodItem;
  Payment: TPayment;
  Response: string;
  ReceiptResponse: TReceiptResponse;
  Success: Boolean;
begin
  if not Assigned(FReceiptAPI) or not FReceiptAPI.IsTokenValid then
  begin
    Log('API –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –∞–±–æ —Ç–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π!');
    Exit;
  end;

  try
    Log('–ü–æ—á–∞—Ç–æ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–µ–∫–∞...');

    // –°—Ç–≤–æ—Ä—é—î–º–æ –æ—Å–Ω–æ–≤–Ω–∏–π –æ–±'—î–∫—Ç —á–µ–∫–∞
    Receipt := TReceipt.Create;

    // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –æ—Å–Ω–æ–≤–Ω—ñ –¥–∞–Ω—ñ —á–µ–∫–∞
    //Receipt.Id := FReceiptAPI.GenerateUUID; // –ì–µ–Ω–µ—Ä—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID
    Receipt.Id := TGUID.NewGuid.ToString;
    Receipt.CashierName := '–Ü–≤–∞–Ω–æ–≤ –Ü.–Ü.';
    Receipt.Departament := '–ì–æ–ª–æ–≤–Ω–∏–π –≤—ñ–¥–¥—ñ–ª';
    Receipt.OrderId := 'ORDER-12345';
    Receipt.Header := '–ß–µ–∫ –ø–æ–∫—É–ø–∫–∏';
    Receipt.Footer := '–î—è–∫—É—î–º–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!';
    Receipt.Rounding := True;

    // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–æ–≤–∞—Ä
    Good := FReceiptAPI.CreateGood(
      '123456',          // –ö–æ–¥ —Ç–æ–≤–∞—Ä—É
      '–¢–µ–ª–µ—Ñ–æ–Ω Samsung', // –ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É
      1999900            // –¶—ñ–Ω–∞ —É –∫–æ–ø—ñ–π–∫–∞—Ö (19999.00 –≥—Ä–Ω)
    );

    // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é —Ç–æ–≤–∞—Ä—É –≤ —á–µ–∫—É
    GoodItem := FReceiptAPI.CreateGoodItem(Good, 1000); // 1000 = 1 —à—Ç (—É —Ç–∏—Å—è—á–∞—Ö)
    GoodItem.TotalSum := 1999900; // –ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞ –∑–∞ –ø–æ–∑–∏—Ü—ñ—é

    // –î–æ–¥–∞—î–º–æ —Ç–æ–≤–∞—Ä –¥–æ —á–µ–∫–∞
    SetLength(Receipt.Goods, 1);
    Receipt.Goods[0] := GoodItem;

    // –°—Ç–≤–æ—Ä—é—î–º–æ –æ–ø–ª–∞—Ç—É
    Payment := FReceiptAPI.CreatePayment(ptCashless, 1999900); // –ë–µ–∑–≥–æ—Ç—ñ–≤–∫–æ–≤–∞ –æ–ø–ª–∞—Ç–∞
    Payment.LabelText := '–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–∫–æ—é';
    Payment.CardMask := '****1234';
    Payment.BankName := '–ü—Ä–∏–≤–∞—Ç–ë–∞–Ω–∫';

    // –î–æ–¥–∞—î–º–æ –æ–ø–ª–∞—Ç—É –¥–æ —á–µ–∫–∞
    SetLength(Receipt.Payments, 1);
    Receipt.Payments[0] := Payment;

    Log('–ß–µ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–æ. –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ HTTP...');

    // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —á–µ–∫
    Success := FReceiptAPI.SendReceiptCurl(Receipt, Response, ReceiptResponse);

    if Success and Assigned(ReceiptResponse) then
    begin
      Log('–ß–µ–∫ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!');
      Log('ID —á–µ–∫–∞: ' + ReceiptResponse.Id);
      Log('–§—ñ—Å–∫–∞–ª—å–Ω–∏–π –Ω–æ–º–µ—Ä: ' + ReceiptResponse.FiscalCode);
      Log('–°—Ç–∞—Ç—É—Å: ' + IntToStr(Ord(ReceiptResponse.Status)));

      // –ú–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
      if ReceiptResponse.Status = rsDone then
        Log('–ß–µ–∫ —É—Å–ø—ñ—à–Ω–æ –æ–ø—Ä–∞—Ü—å–æ–≤–∞–Ω–æ!');

      // –í–∞–∂–ª–∏–≤–æ: –∑–≤—ñ–ª—å–Ω—è—î–º–æ –ø–∞–º'—è—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
      FreeAndNil(ReceiptResponse);
    end
    else
    begin
      Log('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞: ' + Response);
      ShowMessage('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: ' + Response);
    end;

  except
    on E: Exception do
    begin
      Log('–í–∏–Ω—è—Ç–æ–∫ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ/–≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ —á–µ–∫–∞: ' + E.Message);
      ShowMessage('–ü–æ–º–∏–ª–∫–∞: ' + E.Message);
    end;
  end;

  // –í–∞–∂–ª–∏–≤–æ: –∑–≤—ñ–ª—å–Ω—è—î–º–æ –ø–∞–º'—è—Ç—å —á–µ–∫–∞
  if Assigned(Receipt) then
    FreeAndNil(Receipt);
end;


procedure TFmChek.btnOpenShiftCurlClick(Sender: TObject);
var
  Response: string;
  ShiftStatus: TShiftStatus;
  Success: Boolean;
  ShiftId, FiscalDate: string;
  StartTime: TDateTime;
  ACashRegisterStatus: TCashRegisterStatus;
begin

 // –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–∫–ª–∏–∫
 if btnOpenShift.Enabled = False then
 begin
  if not ValidateAPIState(False, False) then  // Basic API only
    Exit;

  // 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –∫–∞—Å—É
  if FReceiptAPI.CurrentCashRegisterId = '' then
  begin
    Log('–ö–∞—Å–∞ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞!');
    if MessageDlg('–ö–∞—Å–∞ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞',
        '–°–ø–æ—á–∞—Ç–∫—É –ø–æ—Ç—Ä—ñ–±–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫–∞—Å—É. –í–∏–∫–æ–Ω–∞—Ç–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é?',
        mtConfirmation, [mbYes, mbNo], 0) = mrYes then
    begin
      btnInitializeCashRegisterClick(Sender);
      if FReceiptAPI.CurrentCashRegisterId = '' then
      begin
        ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫–∞—Å—É');
        Exit;
      end;
    end
    else
    begin
      Exit;
    end;
  end;

  // 2. –ü–ï–†–ï–í–Ü–†–ö–ê –û–§–õ–ê–ô–ù-–†–ï–ñ–ò–ú–£
  if FReceiptAPI.GetCashRegisterStatusCurl(FReceiptAPI.CurrentCashRegisterId, Response, ACashRegisterStatus) then
  begin
    try
      if Assigned(ACashRegisterStatus) then
      begin
        Log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–∂–∏–º—É –∫–∞—Å–∏: OfflineMode=' +
            BoolToStr(ACashRegisterStatus.OfflineMode, True) +
            ', StayOffline=' + BoolToStr(ACashRegisterStatus.StayOffline, True));

        // –û–ë–†–û–ë–ö–ê –°–¢–ê–¢–£–°–Ü–í –ó–ú–Ü–ù–ò
        case ACashRegisterStatus.ShiftStatus of
          'OPENED':
          begin
            UpdateShiftStatus(svOpened);
            Log('–ó–º—ñ–Ω–∞ –≤–∂–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞!');
            FReceiptAPI.CurrentShiftId := FReceiptAPI.GetCurrentShiftIdCurl(Response);
            if FReceiptAPI.CurrentShiftId <> '' then
            begin
              edtShiftId.Text := FReceiptAPI.CurrentShiftId;
              btnCloseShiftSimpleCurl.Enabled := True;

              // –û–ù–û–í–õ–Æ–Ñ–ú–û –ë–ê–õ–ê–ù–° –î–õ–Ø –í–Ü–î–ö–†–ò–¢–û–á –ó–ú–Ü–ù–ò
              if FReceiptAPI.GetShiftStatusCurl(FReceiptAPI.CurrentShiftId, Response, ShiftStatus) then
              begin
                if Assigned(ShiftStatus) and Assigned(ShiftStatus.Balance) then
                begin
                  Log('–ë–∞–ª–∞–Ω—Å –ø–æ—Ç–æ—á–Ω–æ—ó –∑–º—ñ–Ω–∏: ' +
                      Format('%.2f –≥—Ä–Ω', [ShiftStatus.Balance.Balance / 100]));
                end;
                FreeAndNil(ShiftStatus);
              end;

              ShowMessage('–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø–æ—Ç–æ—á–Ω–∞ –∑–º—ñ–Ω–∞: ' + FReceiptAPI.CurrentShiftId);
            end
            else
            begin
              ShowMessage('–ó–º—ñ–Ω–∞ –≤–∂–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞, –∞–ª–µ –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —ó—ó ID');
            end;
            Exit;
          end;

          'CLOSED':
          begin
            Log('–ü–æ–ø–µ—Ä–µ–¥–Ω—è –∑–º—ñ–Ω–∞ –∑–∞–∫—Ä–∏—Ç–∞. –ú–æ–∂–Ω–∞ –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏ –Ω–æ–≤—É.');
            // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –æ–±—Ä–æ–±–∫—É
          end;

          'ERROR':
          begin
            Log('–ü–æ–ø–µ—Ä–µ–¥–Ω—è –∑–º—ñ–Ω–∞ –≤ —Å—Ç–∞–Ω—ñ –ø–æ–º–∏–ª–∫–∏!');
            if MessageDlg('–ü–æ–ø–µ—Ä–µ–¥–Ω—è –∑–º—ñ–Ω–∞ –≤ —Å—Ç–∞–Ω—ñ –ø–æ–º–∏–ª–∫–∏',
                '–ë–∞–∂–∞—î—Ç–µ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–æ–≤—É –∑–º—ñ–Ω—É?',
                mtWarning, [mbYes, mbNo], 0) = mrNo then
            begin
              Exit;
            end;
            // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ —Å–ø—Ä–æ–±—É –≤—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–æ–≤—É –∑–º—ñ–Ω—É
          end;
        else
          Log('–ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏: ' + ACashRegisterStatus.ShiftStatus);
        end;

        // –ö–†–ò–¢–ò–ß–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê: –∫–∞—Å–∞ –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—ñ
        if not ACashRegisterStatus.OfflineMode then
        begin
          ShowMessage('–ù–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –∑–º—ñ–Ω—É. –ö–∞—Å–∞ –Ω–µ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—ñ.' + sLineBreak +
                     '–ü–æ—Ç–æ—á–Ω–∏–π —Ä–µ–∂–∏–º: Online. –ü–µ—Ä–µ–≤–µ–¥—ñ—Ç—å –∫–∞—Å—É –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º.');
          Exit;
        end;

        if not ACashRegisterStatus.StayOffline then
        begin
          ShowMessage('–ù–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –∑–º—ñ–Ω—É. –ö–∞—Å–∞ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞ –Ω–∞ –æ—Ñ–ª–∞–π–Ω-—Ä–æ–±–æ—Ç—É.' + sLineBreak +
                     '–ü–∞—Ä–∞–º–µ—Ç—Ä StayOffline = False. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∫–∞—Å—É –Ω–∞ –æ—Ñ–ª–∞–π–Ω-—Ä–æ–±–æ—Ç—É.');
          Exit;
        end;
      end;
    finally
      FreeAndNil(ACashRegisterStatus);
    end;
  end;

  // 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è
  if not FReceiptAPI.CheckConnectivityCurl(Response) then
  begin
    Log('–ù–µ–º–∞—î –∑ º—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º! –û—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ.');
    // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—ñ –±–µ–∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  end;

  // 4. –û—Ç—Ä–∏–º—É—î–º–æ ID –∑–º—ñ–Ω–∏
  ShiftId := FReceiptAPI.LoadShiftFromFile;
  if ShiftId = '' then
    ShiftId := Trim(edtShiftId.Text);

  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∞–ª—ñ–¥–Ω–æ—Å—Ç—ñ ID –∑–º—ñ–Ω–∏
  if (ShiftId <> '') and not ValidateShiftId(ShiftId) then
  begin
    ShowMessage('–ù–µ–¥—ñ–π—Å–Ω–∏–π ID –∑–º—ñ–Ω–∏. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π UUID.');
    Exit;
  end;

  FiscalDate := '';

  btnOpenShiftCurl.Enabled := False;
  StartTime := Now;
  ShiftStatus := nil;

  try
    // 5. –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏ –≤ –û–§–õ–ê–ô–ù-–†–ï–ñ–ò–ú–Ü
    Success := FReceiptAPI.OpenShiftCurl(
      ShiftId,
      edtFiscalCode.Text,
      FiscalDate,
      Response,
      ShiftStatus
    );

    if not Success then
    begin
      Log('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏: ' + Response);

      if Pos('offline mode', LowerCase(Response)) > 0 then
      begin
        ShowMessage('–ü–æ–º–∏–ª–∫–∞ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—É: ' + Copy(Response, 1, 150));
      end
      else
      begin
        ShowMessage('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏: ' + Copy(Response, 1, 200));
      end;
      Exit;
    end;

    if not Assigned(ShiftStatus) then
    begin
      Log('–ü–æ–º–∏–ª–∫–∞: ShiftStatus = nil –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –≤–∏–∫–ª–∏–∫—É OpenShiftCurl');
      ShowMessage('–ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –∑–º—ñ–Ω–∏');
      Exit;
    end;

    // –û–ù–û–í–õ–Æ–Ñ–ú–û ShiftId –∑ –æ—Ç—Ä–∏–º–∞–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    ShiftId := ShiftStatus.Id;
    SynchronizeShiftId(ShiftId);

    Log('–û—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –°—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
    Log('ID –∑–º—ñ–Ω–∏: ' + ShiftId);
    Log('–ù–æ–º–µ—Ä –∑–º—ñ–Ω–∏: ' + IntToStr(ShiftStatus.Serial));

    // –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –Ü–ù–§–û–†–ú–ê–¶–Ü–á –ü–†–û –ë–ê–õ–ê–ù–°
    if Assigned(ShiftStatus.Balance) then
    begin
      Log('–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –±–∞–ª–∞–Ω—Å: ' + Format('%.2f –≥—Ä–Ω', [ShiftStatus.Balance.Initial / 100]));
      Log('–ü–æ—Ç–æ—á–Ω–∏–π –±–∞–ª–∞–Ω—Å: ' + Format('%.2f –≥—Ä–Ω', [ShiftStatus.Balance.Balance / 100]));
      Log('–ì–æ—Ç—ñ–≤–∫–æ–≤—ñ –ø—Ä–æ–¥–∞–∂—ñ: ' + Format('%.2f –≥—Ä–Ω', [ShiftStatus.Balance.CashSales / 100]));
      Log('–ë–µ–∑–≥–æ—Ç—ñ–≤–∫–æ–≤—ñ –ø—Ä–æ–¥–∞–∂—ñ: ' + Format('%.2f –≥—Ä–Ω', [ShiftStatus.Balance.CardSales / 100]));

      // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ
      if Assigned(lblBalance) then
        lblBalance.Caption := Format('–ë–∞–ª–∞–Ω—Å: %.2f –≥—Ä–Ω', [ShiftStatus.Balance.Balance / 100]);
    end;

    // –û–ë–†–û–ë–ö–ê –í–°–Ü–• –ú–û–ñ–õ–ò–í–ò–• –°–¢–ê–¢–£–°–Ü–í –ó–ú–Ü–ù–ò
    case ShiftStatus.Status of
      'OPENED':
      begin
        btnCloseShiftSimpleCurl.Enabled := True;
        Log('–û—Ñ–ª–∞–π–Ω-–∑–º—ñ–Ω—É —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–∫—Ä–∏—Ç–æ!' + sLineBreak +
                   '–ù–æ–º–µ—Ä: ' + IntToStr(ShiftStatus.Serial) + sLineBreak +
                   'ID: ' + ShiftId + sLineBreak +
                   '–ë–∞–ª–∞–Ω—Å: ' + Format('%.2f –≥—Ä–Ω', [ShiftStatus.Balance.Balance / 100]));
        Log('–ß–∞—Å –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è: ' + DateTimeToStr(ShiftStatus.OpenedAt));
      end;

      'CREATED':
      begin
        Log('–ó–∞–ø–∏—Ç –Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –æ—Ñ–ª–∞–π–Ω-–∑–º—ñ–Ω–∏ —É—Å–ø—ñ—à–Ω–∏–π! –û—á—ñ–∫—É—î–º–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è...');

        // –û—á—ñ–∫—É—î–º–æ —Å—Ç–∞—Ç—É—Å OPENED –¥–ª—è –æ—Ñ–ª–∞–π–Ω-–∑–º—ñ–Ω–∏
        FreeAndNil(ShiftStatus);

        if FReceiptAPI.WaitForShiftStatus(ShiftId, 'OPENED', Response, ShiftStatus, 90) then
        begin
          if Assigned(ShiftStatus) then
          begin
            // –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –Ü–ù–§–û–†–ú–ê–¶–Ü–á –ü–†–û –ë–ê–õ–ê–ù–° –ü–Ü–°–õ–Ø –û–ß–Ü–ö–£–í–ê–ù–ù–Ø
            if Assigned(ShiftStatus.Balance) then
            begin
              Log('–ë–∞–ª–∞–Ω—Å –ø—ñ—Å–ª—è –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è: ' + Format('%.2f –≥—Ä–Ω', [ShiftStatus.Balance.Balance / 100]));
              if Assigned(lblBalance) then
                lblBalance.Caption := Format('–ë–∞–ª–∞–Ω—Å: %.2f –≥—Ä–Ω', [ShiftStatus.Balance.Balance / 100]);
            end;

            // –û–ë–†–û–ë–ö–ê –°–¢–ê–¢–£–°–Ü–í –ü–Ü–°–õ–Ø –û–ß–Ü–ö–£–í–ê–ù–ù–Ø
            case ShiftStatus.Status of
              'OPENED':
              begin
                SynchronizeShiftId(ShiftStatus.Id);
                Log('–û—Ñ–ª–∞–π–Ω-–∑–º—ñ–Ω—É —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ!');
                Log('–°—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
                Log('–°–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä: ' + IntToStr(ShiftStatus.Serial));
                Log('–ë–∞–ª–∞–Ω—Å: ' + Format('%.2f –≥—Ä–Ω', [ShiftStatus.Balance.Balance / 100]));
                btnCloseShiftSimpleCurl.Enabled := True;
              end;

              'ERROR':
              begin
                Log('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–º—ñ–Ω–∏: ' + Response);
                ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏. –°—Ç–∞—Ç—É—Å: ERROR' + sLineBreak +
                           '–î–µ—Ç–∞–ª—ñ: ' + Copy(Response, 1, 100));
              end;

              'CLOSED':
              begin
                Log('–ó–º—ñ–Ω—É –∑–∞–∫—Ä–∏—Ç–æ –ø—ñ–¥ —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è');
                ShowMessage('–ó–º—ñ–Ω—É –±—É–ª–æ –∑–∞–∫—Ä–∏—Ç–æ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è');
              end;
            else
              Log('–ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å –ø—ñ—Å–ª—è –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è: ' + ShiftStatus.Status);
              ShowMessage('–ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏: ' + ShiftStatus.Status);
            end;
          end;
        end
        else
        begin
          Log('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –æ—Ñ–ª–∞–π–Ω-–∑–º—ñ–Ω–∏: ' + Response);

          // –î–û–î–ê–¢–ö–û–í–ê –ü–ï–†–ï–í–Ü–†–ö–ê –°–¢–ê–¢–£–°–£ –ü–†–ò –¢–ê–ô–ú–ê–£–¢–Ü
          if FReceiptAPI.GetShiftStatusCurl(ShiftId, Response, ShiftStatus) then
          begin
            if Assigned(ShiftStatus) then
            begin
              // –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –ë–ê–õ–ê–ù–°–£ –ü–†–ò –ü–ï–†–ï–í–Ü–†–¶–Ü –°–¢–ê–¢–£–°–£
              if Assigned(ShiftStatus.Balance) then
              begin
                Log('–ë–∞–ª–∞–Ω—Å –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ —Å—Ç–∞—Ç—É—Å—É: ' + Format('%.2f –≥—Ä–Ω', [ShiftStatus.Balance.Balance / 100]));
              end;

              case ShiftStatus.Status of
                'ERROR':
                  ShowMessage('–¢–∞–π–º–∞—É—Ç –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è. –ó–º—ñ–Ω–∞ –≤ —Å—Ç–∞–Ω—ñ –ø–æ–º–∏–ª–∫–∏: ' + Copy(Response, 1, 100));
                'CLOSED':
                  ShowMessage('–¢–∞–π–º–∞—É—Ç –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è. –ó–º—ñ–Ω—É –±—É–ª–æ –∑–∞–∫—Ä–∏—Ç–æ');
                else
                  ShowMessage('–¢–∞–π–º–∞—É—Ç –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è. –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
              end;
              FreeAndNil(ShiftStatus);
            end;
          end
          else
          begin
            ShowMessage('–¢–∞–π–º–∞—É—Ç –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è: ' + Copy(Response, 1, 100));
          end;
        end;
      end;

      'ERROR':
      begin
        Log('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏. –°—Ç–∞—Ç—É—Å: ERROR');
        ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ –∑–º—ñ–Ω—É. –°—Ç–∞—Ç—É—Å: ERROR' + sLineBreak +
                   '–î–µ—Ç–∞–ª—ñ: ' + Copy(Response, 1, 150));

        // –°–ø—Ä–æ–±–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ –ø–æ–º–∏–ª–∫–∏
        if Pos('emergency', LowerCase(Response)) > 0 then
          ShowMessage('–ê–≤–∞—Ä—ñ–π–Ω–µ –∑–∞–∫—Ä–∏—Ç—Ç—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –∑–º—ñ–Ω–∏');
      end;

      'CLOSED':
      begin
        Log('–ó–º—ñ–Ω—É –∑–∞–∫—Ä–∏—Ç–æ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è');
        ShowMessage('–ó–º—ñ–Ω—É –±—É–ª–æ –∑–∞–∫—Ä–∏—Ç–æ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è');
      end;

    else
      Log('–ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏: ' + ShiftStatus.Status);
      ShowMessage('–ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏: ' + ShiftStatus.Status);
    end;
    UpdateAllStatuses;
  finally
    btnOpenShiftCurl.Enabled := True;
    if Assigned(ShiftStatus) then
      FreeAndNil(ShiftStatus);
    Log('–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: ' + IntToStr(SecondsBetween(Now, StartTime)) + ' —Å–µ–∫');
  end;

 end
 else
 begin
   // –†—É—á–Ω–∏–π –≤–∏–∫–ª–∏–∫ - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ–≤–Ω–∏–π –ø–æ—Ç—ñ–∫
   btnOpenShiftClick(Sender);
 end;
 UpdateAllStatuses;
end;

procedure TFmChek.btnPinCodeLoginClick(Sender: TObject);
var
  Response: string;
  Success: Boolean;
begin
  if not UseCheckboxAPI then
  begin
    ShowMessage('–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª Checkbox API –≤–∏–º–∫–Ω–µ–Ω–æ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö');
    Exit;
  end;

  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–≤–µ–¥–µ–Ω–æ PIN-–∫–æ–¥
  if Trim(edtPinCode.Text) = '' then
  begin
    ShowMessage('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å PIN-–∫–æ–¥');
    Exit;
  end;

  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –ª—ñ—Ü–µ–Ω–∑—ñ–π–Ω–æ–≥–æ –∫–ª—é—á–∞
  if Trim(edtLicenseKey.Text) = '' then
  begin
    ShowMessage('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –ª—ñ—Ü–µ–Ω–∑—ñ–π–Ω–∏–π –∫–ª—é—á');
    Exit;
  end;

  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∂–µ —ñ—Å–Ω—É—î –µ–∫–∑–µ–º–ø–ª—è—Ä API
  if Assigned(FReceiptAPI) then
    FreeAndNil(FReceiptAPI);

  try
    // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä API –∑ –ª—ñ—Ü–µ–Ω–∑—ñ–π–Ω–∏–º –∫–ª—é—á–µ–º
    FReceiptAPI := TReceiptWebAPI.Create(
      edtBaseURL.Text,      // –ë–∞–∑–æ–≤–∏–π URL API
      edtClientName.Text,   // –ù–∞–∑–≤–∞ –∫–ª—ñ—î–Ω—Ç–∞
      edtClientVersion.Text, // –í–µ—Ä—Å—ñ—è –∫–ª—ñ—î–Ω—Ç–∞
      edtLicenseKey.Text,    // –õ—ñ—Ü–µ–Ω–∑—ñ–π–Ω–∏–π –∫–ª—é—á (–û–ë–û–í'–Ø–ó–ö–û–í–û!)
      @Self.Log // –ü–µ—Ä–µ–¥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –º–µ—Ç–æ–¥ Log
    );

    Log('–°—Ç–≤–æ—Ä–µ–Ω–æ –µ–∫–∑–µ–º–ø–ª—è—Ä TReceiptWebAPI –¥–ª—è –≤—Ö–æ–¥—É –∑–∞ PIN-–∫–æ–¥–æ–º');

    // –í–∏–∫–æ–Ω—É—î–º–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é —á–µ—Ä–µ–∑ PIN-–∫–æ–¥
    Success := FReceiptAPI.PinCodeLoginCurl(
      edtPinCode.Text, // PIN-–∫–æ–¥
      Response          // –í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞
    );

    if Success then
    begin
      // –û–Ω–æ–≤–∏—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–∞—Å–∏—Ä–∞
      UpdateCashierInfo;
      FReceiptAPI.HandleAuthState(aaSave);
      Log('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –∑–∞ PIN-–∫–æ–¥–æ–º —É—Å–ø—ñ—à–Ω–∞!');
      Log('–¢–æ–∫–µ–Ω: ' + Copy(FReceiptAPI.AuthToken, 1, 20) + '...');

      // –ê–∫—Ç–∏–≤—É—î–º–æ –∫–Ω–æ–ø–∫–∏, —è–∫—ñ –≤–∏–º–∞–≥–∞—é—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
      btbtnSendReceiptCurl.Enabled := True;
      btnLogoutCurl.Enabled := True;
      btnGetCashRegisterStatusCurl.Enabled := True;
      btnOpenShiftCurl.Enabled := True;
      btnGetShiftStatusCurl.Enabled := True;
      btnCloseShiftSimpleCurl.Enabled := True;
      btnCloseShiftWithReportCurl.Enabled := True;

      // –û—á–∏—â–∞—î–º–æ –ø–æ–ª–µ PIN-–∫–æ–¥—É –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –≤—Ö–æ–¥—É (–¥–ª—è –±–µ–∑–ø–µ–∫–∏)
      edtPinCode.Text := '';

      ShowMessage('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –∑–∞ PIN-–∫–æ–¥–æ–º —É—Å–ø—ñ—à–Ω–∞!');
      UpdateCashierStatus(svOnline, 'PIN');
    end
    else
    begin
      Log('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –∑–∞ PIN-–∫–æ–¥–æ–º: ' + Response);
      ShowMessage('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –∑–∞ PIN-–∫–æ–¥–æ–º: ' + Response);
      UpdateCashierStatus(svError);
    end;
    UpdateAllStatuses;
  except
    on E: Exception do
    begin
      Log('–í–∏–Ω—è—Ç–æ–∫ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –∑–∞ PIN-–∫–æ–¥–æ–º: ' + E.Message);
      ShowMessage('–ü–æ–º–∏–ª–∫–∞: ' + E.Message);
    end;
  end;
end;


procedure TFmChek.btnRecoverShiftClick(Sender: TObject);
var
  Response: string;
  ShiftStatus: TShiftStatus;
begin
  if not ValidateAPIState(False, False) then  // Basic API only
    Exit;

  Log('–°–ø—Ä–æ–±–∞ —Ä—É—á–Ω–æ–≥–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–º—ñ–Ω–∏...');

  if FReceiptAPI.RecoverShift(Response, ShiftStatus) then
  begin
    if Assigned(ShiftStatus) then
    begin
      edtShiftId.Text := ShiftStatus.Id;
      btnCloseShiftSimpleCurl.Enabled := True;
      ShowMessage('–ó–º—ñ–Ω—É –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ: ' + ShiftStatus.Id);
      FreeAndNil(ShiftStatus);
    end;
  end
  else
  begin
    ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑–º—ñ–Ω—É: ' + Response);
  end
end;

procedure TFmChek.btnRefreshCashRegistersClick(Sender: TObject);
begin
  if not ValidateAPIState(False, False, True) then // –ü–æ—Ç—Ä—ñ–±–µ–Ω —Å–ø–∏—Å–æ–∫ –∫–∞—Å
    Exit;
  RefreshCashRegisterList;
end;

procedure TFmChek.btnGetShiftStatusCurlClick(Sender: TObject);
var
  Response: string;
  ShiftStatus: TShiftStatus;
  Success: Boolean;
  ShiftId: string;
begin
  if not ValidateAPIState(True, False) then  // RequireShift = True
    Exit;

  // –û—Ç—Ä–∏–º—É—î–º–æ ID –∑–º—ñ–Ω–∏ (–Ω–µ Serial)
  ShiftId := edtShiftId.Text;

  // –Ø–∫—â–æ –ø–æ–ª–µ –≤–≤–æ–¥—É –ø–æ—Ä–æ–∂–Ω—î, –Ω–∞–º–∞–≥–∞—î–º–æ—Å—å –≤–∑—è—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π ID
  if ShiftId = '' then
  begin
    ShiftId := FReceiptAPI.CurrentShiftId; // –¶–µ –º–∞—î –±—É—Ç–∏ ID, –Ω–µ Serial
    if ShiftId = '' then
      ShiftId := FReceiptAPI.LoadShiftFromFile; // –ú–∞—î –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ ID
    if ShiftId = '' then
    begin
      ShowMessage('–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—ó –∑–º—ñ–Ω–∏.');
      Exit;
    end;
    SynchronizeShiftId(ShiftId); // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –≤—Å—ñ –¥–∂–µ—Ä–µ–ª–∞
  end;

  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ ID, –∞ –Ω–µ Serial
  if not ValidateShiftId(ShiftId) then
  begin
    ShowMessage('–ù–µ–¥—ñ–π—Å–Ω–∏–π ID –∑–º—ñ–Ω–∏');
    Exit;
  end;

  Log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –∑–º—ñ–Ω–∏ —á–µ—Ä–µ–∑ CURL...');
  Log('Shift ID: ' + ShiftId);

  Success := FReceiptAPI.GetShiftStatusCurl(ShiftId, Response, ShiftStatus);

  if Success and Assigned(ShiftStatus) then
  begin
    Log('–°—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏ –æ—Ç—Ä–∏–º–∞–Ω–æ —á–µ—Ä–µ–∑ CURL!');
    Log('ID: ' + ShiftStatus.Id);
    Log('–°—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
    Log('–°–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä: ' + IntToStr(ShiftStatus.Serial));
    Log('Z-–∑–≤—ñ—Ç: ' + ShiftStatus.ZReport);

    if ShiftStatus.Status = 'OPENED' then
    begin
      Log('–ó–º—ñ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –æ: ' + DateTimeToStr(ShiftStatus.OpenedAt));
      // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –∑–º—ñ–Ω–∏
      btnCloseShiftSimpleCurl.Enabled := True;
      btnCloseShiftWithReportCurl.Enabled := True;
    end
    else if ShiftStatus.Status = 'CLOSED' then
    begin
      Log('–ó–º—ñ–Ω–∞ –∑–∞–∫—Ä–∏—Ç–∞ –æ: ' + DateTimeToStr(ShiftStatus.ClosedAt));
      // –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø—Ä–∏—á–∏–Ω—É –∑–∞–∫—Ä–∏—Ç—Ç—è (—è–∫—â–æ —î)
      if ShiftStatus.EmergencyClose then
      begin
        Log('–ê–≤–∞—Ä—ñ–π–Ω–µ –∑–∞–∫—Ä–∏—Ç—Ç—è: ' + ShiftStatus.EmergencyCloseDetails);
      end;

      // –î–µ–∞–∫—Ç–∏–≤—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä–∏—Ç—Ç—è –¥–ª—è –∑–∞–∫—Ä–∏—Ç–æ—ó –∑–º—ñ–Ω–∏
      btnCloseShiftSimpleCurl.Enabled := False;
      btnCloseShiftWithReportCurl.Enabled := False;
    end;

    // –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–∞—Å—É
    if ShiftStatus.CashRegisterId <> '' then
    begin
      Log('ID –∫–∞—Å–∏: ' + ShiftStatus.CashRegisterId);
    end;

    // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ª–µ –≤–≤–æ–¥—É –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º ID
    if ShiftStatus.Id <> '' then
    begin
      SynchronizeShiftId(ShiftStatus.Id);
    end;

    // –ü–æ–∫–∞–∑—É—î–º–æ —Å—Ç–∞—Ç—É—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–≤—ñ
    case ShiftStatus.Status of
      'OPENED':
       begin
        UpdateShiftStatus(svOpened, '‚Ññ' + IntToStr(ShiftStatus.Serial));
        Log('–ó–º—ñ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞' + sLineBreak +
                   '–ù–æ–º–µ—Ä: ' + IntToStr(ShiftStatus.Serial) + sLineBreak +
                   '–í—ñ–¥–∫—Ä–∏—Ç–∞: ' + DateTimeToStr(ShiftStatus.OpenedAt));
       end;
      'CLOSED':
       begin
        UpdateShiftStatus(svClosed, '‚Ññ' + IntToStr(ShiftStatus.Serial));
        Log('–ó–º—ñ–Ω–∞ –∑–∞–∫—Ä–∏—Ç–∞' + sLineBreak +
                   '–ù–æ–º–µ—Ä: ' + IntToStr(ShiftStatus.Serial) + sLineBreak +
                   '–ó–∞–∫—Ä–∏—Ç–∞: ' + DateTimeToStr(ShiftStatus.ClosedAt));
       end
      else
        begin
         UpdateShiftStatus(svError, ShiftStatus.Status);
         Log('–°—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏: ' + ShiftStatus.Status + sLineBreak +
                   '–ù–æ–º–µ—Ä: ' + IntToStr(ShiftStatus.Serial));
        end;
    end;

  end
  else
  begin
    Log('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –∑–º—ñ–Ω–∏ —á–µ—Ä–µ–∑ CURL: ' + Response);

    // –î–µ—Ç–∞–ª—å–Ω—ñ—à–∞ –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
    if Pos('"message":"', Response) > 0 then
      Log('–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É: ' + Response)
    else if Pos('Not Found', Response) > 0 then
      Log('–ó–º—ñ–Ω—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ ID –∑–º—ñ–Ω–∏.')
    else if Pos('Unauthorized', Response) > 0 then
      Log('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π.');

    ShowMessage('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –∑–º—ñ–Ω–∏ —á–µ—Ä–µ–∑ CURL: ' + Copy(Response, 1, 200));
  end;
  UpdateAllStatuses;
  if Assigned(ShiftStatus) then
    FreeAndNil(ShiftStatus);
end;

procedure TFmChek.btnGetXReportClick(Sender: TObject);
var
  LResponse: string;
  LShiftReport: TShiftReport;
  LTextReport: string;
  LReportFile: string;
  LPngFileName: string;
  I: Integer; // –î–æ–¥–∞–Ω–æ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–æ—ó I

  // –§—É–Ω–∫—Ü—ñ—è –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–∞ –ø–µ—Ä–µ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º
  function GenerateXReportText(LShiftReport: TShiftReport): string;
  var
    J: Integer; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ñ–Ω—à—É –∑–º—ñ–Ω–Ω—É –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É
    LText: TStringList;
  begin
    LText := TStringList.Create;
    try
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫
      LText.Add('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      LText.Add('                   –•-–ó–í–Ü–¢');
      LText.Add('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      LText.Add('');

      // –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
      LText.Add('‚ñ∏ ID –∑–≤—ñ—Ç—É: ' + LShiftReport.Id);
      LText.Add('‚ñ∏ –°–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä: ' + IntToStr(LShiftReport.Serial));
      LText.Add('‚ñ∏ –ß–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è: ' + DateTimeToStr(LShiftReport.CreatedAt));
      LText.Add('');

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–µ–∫—ñ–≤
      LText.Add('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ß–ï–ö–Ü–í ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
      LText.Add('–ß–µ–∫—ñ–≤ –ø—Ä–æ–¥–∞–∂—É:        ' + IntToStr(LShiftReport.SellReceiptsCount));
      LText.Add('–ß–µ–∫—ñ–≤ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è:     ' + IntToStr(LShiftReport.ReturnReceiptsCount));
      LText.Add('–ß–µ–∫—ñ–≤ –≤–∏–¥–∞—á—ñ –≥–æ—Ç—ñ–≤–∫–∏: ' + IntToStr(LShiftReport.CashWithdrawalReceiptsCount));
      LText.Add('');

      // –§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –ø—ñ–¥—Å—É–º–∫–∏
      LText.Add('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –§–Ü–ù–ê–ù–°–ò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
      LText.Add('–ü–æ—á–∞—Ç–∫–æ–≤–∞ —Å—É–º–∞:       ' + FormatFloat('0.00', LShiftReport.Initial / 100) + ' –≥—Ä–Ω');
      LText.Add('–ö—ñ–Ω—Ü–µ–≤–∏–π –±–∞–ª–∞–Ω—Å:      ' + FormatFloat('0.00', LShiftReport.Balance / 100) + ' –≥—Ä–Ω');
      LText.Add('–°—É–º–∞ –∑–Ω–∏–∂–æ–∫:          ' + FormatFloat('0.00', LShiftReport.DiscountsSum / 100) + ' –≥—Ä–Ω');
      LText.Add('–°—É–º–∞ –Ω–∞—Ü—ñ–Ω–æ–∫:         ' + FormatFloat('0.00', LShiftReport.ExtraChargeSum / 100) + ' –≥—Ä–Ω');
      LText.Add('');

      // –û–∫—Ä—É–≥–ª–µ–Ω–Ω—è
      LText.Add('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –û–ö–†–£–ì–õ–ï–ù–ù–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
      LText.Add('–ü—Ä–æ–¥–∞–∂—ñ (–≤–≥–æ—Ä—É):      ' + FormatFloat('0.00', LShiftReport.SalesRoundUp / 100) + ' –≥—Ä–Ω');
      LText.Add('–ü—Ä–æ–¥–∞–∂—ñ (–≤–Ω–∏–∑):       ' + FormatFloat('0.00', LShiftReport.SalesRoundDown / 100) + ' –≥—Ä–Ω');
      LText.Add('–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è (–≤–≥–æ—Ä—É):   ' + FormatFloat('0.00', LShiftReport.ReturnsRoundUp / 100) + ' –≥—Ä–Ω');
      LText.Add('–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è (–≤–Ω–∏–∑):    ' + FormatFloat('0.00', LShiftReport.ReturnsRoundDown / 100) + ' –≥—Ä–Ω');
      LText.Add('');

      // –ü–ª–∞—Ç–µ–∂—ñ
      if Length(LShiftReport.Payments) > 0 then
      begin
        LText.Add('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü–õ–ê–¢–ï–ñ–Ü ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
        for J := 0 to High(LShiftReport.Payments) do
        begin
          LText.Add('‚óè ' + LShiftReport.Payments[J].LabelText + ':');
          LText.Add('  –ü—Ä–æ–¥–∞–∂—ñ:    ' + FormatFloat('0.00', LShiftReport.Payments[J].SellSum / 100) + ' –≥—Ä–Ω');
          LText.Add('  –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è: ' + FormatFloat('0.00', LShiftReport.Payments[J].ReturnSum / 100) + ' –≥—Ä–Ω');
          if LShiftReport.Payments[J].ServiceIn > 0 then
            LText.Add('  Service In: ' + FormatFloat('0.00', LShiftReport.Payments[J].ServiceIn / 100) + ' –≥—Ä–Ω');
          if LShiftReport.Payments[J].ServiceOut > 0 then
            LText.Add('  Service Out:' + FormatFloat('0.00', LShiftReport.Payments[J].ServiceOut / 100) + ' –≥—Ä–Ω');
          LText.Add('');
        end;
      end;

      // –ü–æ–¥–∞—Ç–∫–∏
      if Length(LShiftReport.Taxes) > 0 then
      begin
        LText.Add('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü–û–î–ê–¢–ö–ò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
        for J := 0 to High(LShiftReport.Taxes) do
        begin
          if (LShiftReport.Taxes[J].SalesTurnover > 0) or (LShiftReport.Taxes[J].ReturnsTurnover > 0) then
          begin
            LText.Add('‚óè ' + LShiftReport.Taxes[J].LabelText + ' (' + LShiftReport.Taxes[J].Symbol + '):');
            LText.Add('  –°—Ç–∞–≤–∫–∞:     ' + FormatFloat('0.0', LShiftReport.Taxes[J].Rate) + '%');
            LText.Add('  –û–±–æ—Ä–æ—Ç:     ' + FormatFloat('0.00', LShiftReport.Taxes[J].SalesTurnover / 100) + ' –≥—Ä–Ω');
            if LShiftReport.Taxes[J].ReturnsTurnover > 0 then
              LText.Add('  –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è: ' + FormatFloat('0.00', LShiftReport.Taxes[J].ReturnsTurnover / 100) + ' –≥—Ä–Ω');
            LText.Add('');
          end;
        end;
      end;

      LText.Add('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      LText.Add('             –ó–í–Ü–¢ –°–§–û–†–ú–û–í–ê–ù–û –£–°–ü–Ü–®–ù–û');
      LText.Add('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

      Result := LText.Text;
    finally
      LText.Free;
    end;
  end;

begin
  // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –î–ª—è X-–∑–≤—ñ—Ç—É –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω ShiftId - –≤—ñ–Ω —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ—ó –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –∑–º—ñ–Ω–∏
  // –û—Ç—Ä–∏–º—É—î–º–æ –•-–∑–≤—ñ—Ç —á–µ—Ä–µ–∑ API
  if FReceiptAPI.GetShiftXReportCurl('', LResponse, LShiftReport) then // –ü–æ—Ä–æ–∂–Ω—ñ–π ShiftId - –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ—ó –∑–º—ñ–Ω–∏
  begin
    try
      // –í–∏–≤–æ–¥–∏–º–æ –æ—Å–Ω–æ–≤–Ω—ñ –¥–∞–Ω—ñ –∑–≤—ñ—Ç—É
      Log('=== –•-–ó–í–Ü–¢ ===');
      Log('ID –∑–≤—ñ—Ç—É: ' + LShiftReport.Id);
      Log('–°–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä: ' + IntToStr(LShiftReport.Serial));
      Log('–ß–µ–∫—ñ–≤ –ø—Ä–æ–¥–∞–∂—É: ' + IntToStr(LShiftReport.SellReceiptsCount));
      Log('–ß–µ–∫—ñ–≤ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è: ' + IntToStr(LShiftReport.ReturnReceiptsCount));
      Log('–ß–µ–∫—ñ–≤ –≤–∏–¥–∞—á—ñ –≥–æ—Ç—ñ–≤–∫–∏: ' + IntToStr(LShiftReport.CashWithdrawalReceiptsCount));
      Log('–ü–æ—á–∞—Ç–∫–æ–≤–∞ —Å—É–º–∞: ' + FloatToStr(LShiftReport.Initial / 100) + ' –≥—Ä–Ω');
      Log('–ë–∞–ª–∞–Ω—Å: ' + FloatToStr(LShiftReport.Balance / 100) + ' –≥—Ä–Ω');
      Log('–û—Å—Ç–∞–Ω–Ω—ñ–π ID —á–µ–∫–∞: ' + LShiftReport.LastReceiptId);
      Log('–û–∫—Ä—É–≥–ª–µ–Ω–Ω—è –ø—Ä–æ–¥–∞–∂—ñ–≤ —É –±—ñ–ª—å—à—É —Å—Ç–æ—Ä–æ–Ω—É: ' + FloatToStr(LShiftReport.SalesRoundUp / 100) + ' –≥—Ä–Ω');
      Log('–û–∫—Ä—É–≥–ª–µ–Ω–Ω—è –ø—Ä–æ–¥–∞–∂—ñ–≤ —É –º–µ–Ω—à—É —Å—Ç–æ—Ä–æ–Ω—É: ' + FloatToStr(LShiftReport.SalesRoundDown / 100) + ' –≥—Ä–Ω');
      Log('–û–∫—Ä—É–≥–ª–µ–Ω–Ω—è –ø–æ–≤–µ—Ä–Ω–µ–Ω—å —É –±—ñ–ª—å—à—É —Å—Ç–æ—Ä–æ–Ω—É: ' + FloatToStr(LShiftReport.ReturnsRoundUp / 100) + ' –≥—Ä–Ω');
      Log('–û–∫—Ä—É–≥–ª–µ–Ω–Ω—è –ø–æ–≤–µ—Ä–Ω–µ–Ω—å —É –º–µ–Ω—à—É —Å—Ç–æ—Ä–æ–Ω—É: ' + FloatToStr(LShiftReport.ReturnsRoundDown / 100) + ' –≥—Ä–Ω');

      // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –î–æ–¥–∞—î–º–æ –Ω–æ–≤—ñ –ø–æ–ª—è –∑–≥—ñ–¥–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó
      Log('–°—É–º–∞ –∑–Ω–∏–∂–æ–∫: ' + FloatToStr(LShiftReport.DiscountsSum / 100) + ' –≥—Ä–Ω');
      Log('–°—É–º–∞ –Ω–∞—Ü—ñ–Ω–æ–∫: ' + FloatToStr(LShiftReport.ExtraChargeSum / 100) + ' –≥—Ä–Ω');

      Log('–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è: ' + DateTimeToStr(LShiftReport.CreatedAt));

      // –í–∏–≤–æ–¥–∏–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø–ª–∞—Ç–µ–∂—ñ
      if Length(LShiftReport.Payments) > 0 then
      begin
        Log('--- –ü–õ–ê–¢–ï–ñ–Ü ---');
        for I := 0 to High(LShiftReport.Payments) do
        begin
          Log('–ü–ª–∞—Ç—ñ–∂ ' + IntToStr(I+1) + ':');
          Log('  –¢–∏–ø: ' + LShiftReport.Payments[I].PaymentType);
          Log('  –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫: ' + LShiftReport.Payments[I].ProviderType);
          Log('  –ö–æ–¥: ' + IntToStr(LShiftReport.Payments[I].Code));
          Log('  –ù–∞–∑–≤–∞: ' + LShiftReport.Payments[I].LabelText);
          Log('  –°—É–º–∞ –ø—Ä–æ–¥–∞–∂—ñ–≤: ' + FloatToStr(LShiftReport.Payments[I].SellSum / 100) + ' –≥—Ä–Ω');
          Log('  –°—É–º–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω—å: ' + FloatToStr(LShiftReport.Payments[I].ReturnSum / 100) + ' –≥—Ä–Ω');
          Log('  Service In: ' + FloatToStr(LShiftReport.Payments[I].ServiceIn / 100) + ' –≥—Ä–Ω');
          Log('  Service Out: ' + FloatToStr(LShiftReport.Payments[I].ServiceOut / 100) + ' –≥—Ä–Ω');
          Log('  –í–∏–¥–∞—á–∞ –≥–æ—Ç—ñ–≤–∫–∏: ' + FloatToStr(LShiftReport.Payments[I].CashWithdrawal / 100) + ' –≥—Ä–Ω');
          Log('  –ö–æ–º—ñ—Å—ñ—è –≤–∏–¥–∞—á—ñ: ' + FloatToStr(LShiftReport.Payments[I].CashWithdrawalCommission / 100) + ' –≥—Ä–Ω');
        end;
      end
      else
      begin
        Log('--- –ü–õ–ê–¢–ï–ñ–Ü: –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö ---');
      end;

      // –í–∏–≤–æ–¥–∏–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø–æ–¥–∞—Ç–∫–∏
      if Length(LShiftReport.Taxes) > 0 then
      begin
        Log('--- –ü–û–î–ê–¢–ö–ò ---');
        for I := 0 to High(LShiftReport.Taxes) do
        begin
          Log('–ü–æ–¥–∞—Ç–æ–∫ ' + IntToStr(I+1) + ':');
          Log('  ID: ' + LShiftReport.Taxes[I].Id);
          Log('  –ö–æ–¥: ' + IntToStr(LShiftReport.Taxes[I].Code));
          Log('  –ù–∞–∑–≤–∞: ' + LShiftReport.Taxes[I].LabelText);
          Log('  –°–∏–º–≤–æ–ª: ' + LShiftReport.Taxes[I].Symbol);
          Log('  –°—Ç–∞–≤–∫–∞: ' + FloatToStr(LShiftReport.Taxes[I].Rate) + '%');

          Log('  –°—É–º–∞ –ø—Ä–æ–¥–∞–∂—ñ–≤: ' + FloatToStr(LShiftReport.Taxes[I].SellSum / 100) + ' –≥—Ä–Ω');
          Log('  –°—É–º–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω—å: ' + FloatToStr(LShiftReport.Taxes[I].ReturnSum / 100) + ' –≥—Ä–Ω');
          Log('  –û–±–æ—Ä–æ—Ç –ø—Ä–æ–¥–∞–∂—ñ–≤: ' + FloatToStr(LShiftReport.Taxes[I].SalesTurnover / 100) + ' –≥—Ä–Ω');
          Log('  –û–±–æ—Ä–æ—Ç –ø–æ–≤–µ—Ä–Ω–µ–Ω—å: ' + FloatToStr(LShiftReport.Taxes[I].ReturnsTurnover / 100) + ' –≥—Ä–Ω');

          Log('  –ë–µ–∑ –ü–î–í: ' + BoolToStr(LShiftReport.Taxes[I].NoVat, True));
          Log('  –†–æ–∑—à–∏—Ä–µ–Ω–∏–π –∫–æ–¥: ' + LShiftReport.Taxes[I].AdvancedCode);
          Log('  –î–∞—Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è: ' + DateTimeToStr(LShiftReport.Taxes[I].SetupDate));
        end;
      end
      else
      begin
        Log('--- –ü–û–î–ê–¢–ö–ò: –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö ---');
      end;

      Log('=== –ö–Ü–ù–ï–¶–¨ –•-–ó–í–Ü–¢–£ ===');

      // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–µ–∫—Å—Ç–æ–≤—É –≤–µ—Ä—Å—ñ—é –∑–≤—ñ—Ç—É
      LTextReport := GenerateXReportText(LShiftReport);

      // –í–∏–≤–æ–¥–∏–º–æ –≤ –ª–æ–≥
      (*Log('--- –¢–ï–ö–°–¢–û–í–ê –í–ï–†–°–Ü–Ø –•-–ó–í–Ü–¢–£ ---');
      Log(LTextReport);
      Log('--- –ö–Ü–ù–ï–¶–¨ –¢–ï–ö–°–¢–û–í–û–á –í–ï–†–°–Ü–á ---'); *)

      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —É —Ñ–∞–π–ª
      LReportFile := IncludeTrailingPathDelimiter(receiptspath) +
                    'xreport_' + LShiftReport.Id + '_' +
                    FormatDateTime('yyyy-mm-dd_hh-nn-ss', Now) + '.txt';

      with TStringList.Create do
      try
        Text := LTextReport;
        SaveToFile(LReportFile);
        Log('‚úÖ –¢–µ–∫—Å—Ç–æ–≤–∏–π –∑–≤—ñ—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ: ' + ExtractFileName(LReportFile));
      finally
        Free;
      end;


      // === –í–ê–†–Ü–ê–ù–¢ 2: –û—Ñ—ñ—Ü—ñ–π–Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–∞ –≤–µ—Ä—Å—ñ—è –∑ API ===
      FReceiptAPI.ReceiptsDirectory := receiptspath;
      FReceiptAPI.TempDirectory := temppath;
      if FReceiptAPI.GetSummaryReportText(LShiftReport.Id, LResponse,rtXReport, 42) then // width=42
      begin
        Log('--- –û–§–Ü–¶–Ü–ô–ù–ê –¢–ï–ö–°–¢–û–í–ê –í–ï–†–°–Ü–Ø –•-–ó–í–Ü–¢–£ ---');
        Log(LResponse);
        Log('--- –ö–Ü–ù–ï–¶–¨ –û–§–Ü–¶–Ü–ô–ù–û–á –í–ï–†–°–Ü–á ---');
      end
      else
      begin
        Log('‚ö†Ô∏è –û—Ñ—ñ—Ü—ñ–π–Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–∞ –≤–µ—Ä—Å—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ' + FReceiptAPI.LastError);
        Log('‚ÑπÔ∏è –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤–ª–∞—Å–Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–∞ –≤–µ—Ä—Å—ñ—è');
      end;

      // === –í–ê–†–Ü–ê–ù–¢ 3: PNG –≤–µ—Ä—Å—ñ—è –∑–≤—ñ—Ç—É ===
      LPngFileName := IncludeTrailingPathDelimiter(receiptspath) +
                    'xreport_' + LShiftReport.Id + '_' +
                    FormatDateTime('yyyy-mm-dd_hh-nn-ss', Now) + '.png';
      if FReceiptAPI.GetSummaryReportPNG(LShiftReport.Id, LPngFileName,rtXReport, 30, 58) then // width=30, paper_width=58
      begin
        Log('‚úÖ PNG –∑–≤—ñ—Ç –æ—Ç—Ä–∏–º–∞–Ω–æ: ' + ExtractFileName(LPngFileName));
        ShowCheck(LPngFileName);
        // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ
        // Image1.Picture.LoadFromFile(LPngFileName);
      end
      else
      begin
        Log('‚ö†Ô∏è PNG –≤–µ—Ä—Å—ñ—è –∑–≤—ñ—Ç—É –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ' + FReceiptAPI.LastError);
      end;

    finally
      if Assigned(LShiftReport) then
        LShiftReport.Free;
    end;
  end
  else
  begin
    Log('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –•-–∑–≤—ñ—Ç—É: ' + LResponse);
  end;
end;

procedure TFmChek.btnGoOfflineClick(Sender: TObject);
var
  Response: string;
  Success: Boolean;
begin
  // –ó–ê–ú–Ü–ù–ê: –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ü—ñ–π –∑ –∫–∞—Å–æ—é
  if not ValidateAPIState(False, True) then  // RequireCashRegister = True
    Exit;

  // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å - –ø–æ—á–∞—Ç–æ–∫ –æ–ø–µ—Ä–∞—Ü—ñ—ó
  btnGoOffline.Enabled := False;
  Screen.Cursor := crHourGlass;

  try
    try
      Log('–°–ø—Ä–æ–±–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –∫–∞—Å–∏ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º...');
      Log('ID –∫–∞—Å–∏: ' + edtCashRegisterId.Text); // ‚ö†Ô∏è –î–û–î–ê–ù–û –õ–û–ì–£–í–ê–ù–ù–Ø ID ‚úÖ

      Success := FReceiptAPI.GoOfflineCurl(Response);

      if Success then
      begin
        Log('‚úÖ –ö–∞—Å—É —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º!');
        Log('–í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞: ' + Copy(Response, 1, 200));
        {ShowMessage('–ö–∞—Å—É —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º!');}
        btnGetCashRegisterStatusCurl.Click;
      end
      else
      begin
        Log('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º: ' + Response);
        if Pos('"message":"', Response) > 0 then
          Log('–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É: ' + Response)
        else if Pos('Not Found', Response) > 0 then
          Log('–ö–∞—Å—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ ID –∫–∞—Å–∏.')
        else if Pos('Unauthorized', Response) > 0 then
          Log('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π.');

        ShowMessage('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º: ' + Copy(Response, 1, 200));
      end;
    except
      on E: Exception do
      begin
        Log('‚ùå –í–∏–Ω—è—Ç–æ–∫ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º: ' + E.Message);
        Log('–¢–∏–ø –ø–æ–º–∏–ª–∫–∏: ' + E.ClassName);
        ShowMessage('–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞: ' + E.Message);
      end;
    end;
  finally
    btnGoOffline.Enabled := True;
    Screen.Cursor := crDefault;
  end;
end;

procedure TFmChek.btnGoOnlineClick(Sender: TObject);
var
  Response: string;
  Success: Boolean;
begin
  if not ValidateAPIState(False, True) then  // RequireCashRegister = True
    Exit;

  // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å - –ø–æ—á–∞—Ç–æ–∫ –æ–ø–µ—Ä–∞—Ü—ñ—ó
  btnGoOnline.Enabled := False;
  Screen.Cursor := crHourGlass;

  try
    try
      Log('–°–ø—Ä–æ–±–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –∫–∞—Å–∏ –≤ –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º...');
      Log('ID –∫–∞—Å–∏: ' + edtCashRegisterId.Text);

      Success := FReceiptAPI.GoOnlineCurl(Response);


      if Success and (Pos('"status":"ok"', Response) > 0)then
      begin
        Log('‚úÖ –ö–∞—Å—É —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º!');
        Log('–í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞: ' + Copy(Response, 1, 200));
        {ShowMessage('–ö–∞—Å—É —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º!');}
        //btnGetCashRegisterStatusCurl.Click;
      end
      else
      begin
        Log('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –≤ –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º: ' + Response);
        if Pos('"message":"', Response) > 0 then
          Log('–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É: ' + Response)
        else if Pos('Not Found', Response) > 0 then
          Log('–ö–∞—Å—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ ID –∫–∞—Å–∏.')
        else if Pos('Unauthorized', Response) > 0 then
          Log('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π.');

        ShowMessage('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –≤ –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º: ' + Copy(Response, 1, 200));
      end;
    except
      on E: Exception do
      begin
        Log('‚ùå –í–∏–Ω—è—Ç–æ–∫ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –≤ –æ–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º: ' + E.Message);
        Log('–¢–∏–ø –ø–æ–º–∏–ª–∫–∏: ' + E.ClassName);
        ShowMessage('–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞: ' + E.Message);
      end;
    end;
  finally
    btnGoOnline.Enabled := True;
    Screen.Cursor := crDefault;
  end;
end;

procedure TFmChek.btnInitializeCashRegisterClick(Sender: TObject);
var
  Response: string;
begin
  if not UseCheckboxAPI then
  begin
    ShowMessage('–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª Checkbox API –≤–∏–º–∫–Ω–µ–Ω–æ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö');
    Exit;
  end;
  if not Assigned(FReceiptAPI) then
  begin
    Log('API –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ!');
    Exit;
  end;

  // –°–ø–æ—Å—ñ–± 1: –ü–æ—à—É–∫ –∑–∞ —Ñ—ñ—Å–∫–∞–ª—å–Ω–∏–º –Ω–æ–º–µ—Ä–æ–º
  if FReceiptAPI.InitializeCashRegister(edtFiscalCode.Text, Response) then
  begin
    Log('–ö–∞—Å—É —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ: ' + FReceiptAPI.CurrentCashRegisterId);
    edtCashRegisterId.Text := FReceiptAPI.CurrentCashRegisterId;
    SaveCashRegisterId(FReceiptAPI.CurrentCashRegisterId); // –î–û–î–ê–ù–û: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è
    UpdateCashRegisterStatus(svReady);
  end
  else
  begin
    Log('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Å–∏: ' + Response);

    // –°–ø–æ—Å—ñ–± 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä –ø–µ—Ä—à–æ—ó –∫–∞—Å–∏
    if FReceiptAPI.InitializeFirstCashRegister(Response) then
    begin
      Log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±—Ä–∞–Ω–æ –∫–∞—Å—É: ' + FReceiptAPI.CurrentCashRegisterId);
      edtCashRegisterId.Text := FReceiptAPI.CurrentCashRegisterId;
      SaveCashRegisterId(FReceiptAPI.CurrentCashRegisterId); // –î–û–î–ê–ù–û: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è
      UpdateCashRegisterStatus(svReady);
    end
    else
    begin
      Log('–ù–µ –≤–¥–∞–ª–æ—Å—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫–∞—Å—É: ' + Response);
      ShowMessage('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Å–∏: ' + Response);
    end;
  end;
  UpdateAllStatuses;
end;


procedure TFmChek.btnCloseShiftSimpleCurlClick(Sender: TObject);
var
  Response: string;
  ShiftStatus: TShiftStatus;
  Success: Boolean;
  ShiftId: string;
begin
  // –ó–ê–ú–Ü–ù–ê: –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ü—ñ–π –∑—ñ –∑–º—ñ–Ω–æ—é
  if not ValidateAPIState(True, False) then  // RequireShift = True
    Exit;

  // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –û—Ç—Ä–∏–º—É—î–º–æ ID –∑–º—ñ–Ω–∏
  ShiftId := edtShiftId.Text; // –°–ø–µ—Ä—à—É –¥–∏–≤–∏–º–æ—Å—å —É –ø–æ–ª–µ –≤–≤–æ–¥—É

  // –Ø–∫—â–æ –ø–æ–ª–µ –≤–≤–æ–¥—É –ø–æ—Ä–æ–∂–Ω—î, –Ω–∞–º–∞–≥–∞—î–º–æ—Å—å –≤–∑—è—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π ID
  if ShiftId = '' then
  begin
    ShiftId := FReceiptAPI.CurrentShiftId;
    if ShiftId = '' then
      ShiftId := FReceiptAPI.LoadShiftFromFile; // –î–æ–¥–∞—Ç–∏ —á–∏—Ç–∞–Ω–Ω—è –∑ —Ñ–∞–π–ª—É
    if ShiftId = '' then
    begin
      ShowMessage('–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—ó –∑–º—ñ–Ω–∏ –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è');
      Exit;
    end;
    SynchronizeShiftId(ShiftId); // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –≤—Å—ñ –¥–∂–µ—Ä–µ–ª–∞
  end;

  if not ValidateShiftId(ShiftId) then
  begin
    ShowMessage('–ù–µ–¥—ñ–π—Å–Ω–∏–π ID –∑–º—ñ–Ω–∏');
    Exit;
  end;

  Log('–ü—Ä–æ—Å—Ç–µ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏ —á–µ—Ä–µ–∑ CURL...');
  Log('Shift ID: ' + ShiftId);

  // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –í–∏–¥–∞–ª–µ–Ω–æ –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä CashRegisterId
  Success := FReceiptAPI.CloseShiftSimpleCurl(ShiftId, Response, ShiftStatus);

  if Success and Assigned(ShiftStatus) then
  begin
    UpdateShiftStatus(svClosed);
    Log('–ó–∞–ø–∏—Ç –Ω–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏ —É—Å–ø—ñ—à–Ω–∏–π!');
    Log('–ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
    Log('ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –∑–∞–∫—Ä–∏—Ç—Ç—è: ' + ShiftStatus.ClosingTransactionId);

    // –û—á—ñ–∫—É—î–º–æ —Å—Ç–∞—Ç—É—Å CLOSED
    FreeAndNil(ShiftStatus);
    if FReceiptAPI.WaitForShiftStatus(ShiftId, 'CLOSED', Response, ShiftStatus) then
    begin
      if Assigned(ShiftStatus) then
      begin
        Log('–ó–º—ñ–Ω—É —É—Å–ø—ñ—à–Ω–æ –∑–∞–∫—Ä–∏—Ç–æ!');
        Log('–°—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
        Log('Z-–∑–≤—ñ—Ç: ' + ShiftStatus.ZReport);
        Log('–°–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä: ' + IntToStr(ShiftStatus.Serial));
        Log('–ß–∞—Å –∑–∞–∫—Ä–∏—Ç—Ç—è: ' + DateTimeToStr(ShiftStatus.ClosedAt));

        // –û—Ç—Ä–∏–º—É—î–º–æ –¥–µ—Ç–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç
        Log('–û—Ç—Ä–∏–º—É—î–º–æ –¥–µ—Ç–∞–ª—å–Ω–∏–π Z-–∑–≤—ñ—Ç...');
        // –¢—É—Ç –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–ª–∏–∫ GetShiftReportCurl –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤–Ω–æ–≥–æ –∑–≤—ñ—Ç—É

        // –î–µ–∞–∫—Ç–∏–≤—É—î–º–æ –∫–Ω–æ–ø–∫–∏
        btnCloseShiftSimpleCurl.Enabled := False;
        btnCloseShiftWithReportCurl.Enabled := False;
        ClearShiftState;
      end;
    end
    else
    begin
      Log('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–∫—Ä–∏—Ç–∏ –∑–º—ñ–Ω—É. –û—Å—Ç–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å: ' + Response);
      ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–∫—Ä–∏—Ç–∏ –∑–º—ñ–Ω—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
    end;

  end
  else
  begin
    Log('–ü–æ–º–∏–ª–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏: ' + Response);
    ShowMessage('–ü–æ–º–∏–ª–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏: ' + Response);
  end;
  UpdateAllStatuses;
  if Assigned(ShiftStatus) then
    FreeAndNil(ShiftStatus);
end;



procedure TFmChek.btnCloseShiftWithReportCurlClick(Sender: TObject);
var
  Response, ZReportResponse: string;
  ShiftStatus: TShiftStatus;
  Success: Boolean;
  ShiftId, ZReportId: string;
  StartTime: TDateTime;
begin
  UpdateShiftStatus(svProcessing);
  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É API —Ç–∞ –∑–º—ñ–Ω–∏
  if not ValidateAPIState(True, False) then  // RequireShift = True
    Exit;

  // –û—Ç—Ä–∏–º–∞–Ω–Ω—è ID –∑–º—ñ–Ω–∏ (–∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –ø—Ä–æ—Å—Ç–æ–º—É –∑–∞–∫—Ä–∏—Ç—Ç—é)
  ShiftId := edtShiftId.Text;
  if ShiftId = '' then
  begin
    ShiftId := FReceiptAPI.CurrentShiftId;
    if ShiftId = '' then
      ShiftId := FReceiptAPI.LoadShiftFromFile;
    if ShiftId = '' then
    begin
      ShowMessage('–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—ó –∑–º—ñ–Ω–∏ –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è');
      Exit;
    end;
    SynchronizeShiftId(ShiftId);
  end;

  if not ValidateShiftId(ShiftId) then
  begin
    ShowMessage('–ù–µ–¥—ñ–π—Å–Ω–∏–π ID –∑–º—ñ–Ω–∏');
    Exit;
  end;

  // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  if MessageDlg('–ó–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏ –∑ Z-–∑–≤—ñ—Ç–æ–º',
      '–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∑–∞–∫—Ä–∏—Ç–∏ –∑–º—ñ–Ω—É —Ç–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π Z-–∑–≤—ñ—Ç?' + sLineBreak +
      '–¶—è –æ–ø–µ—Ä–∞—Ü—ñ—è –∑–∞–π–º–µ –±—ñ–ª—å—à–µ —á–∞—Å—É, –∞–ª–µ –Ω–∞–¥–∞—Å—Ç—å –ø–æ–≤–Ω—É —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—É –∑–≤—ñ—Ç–Ω—ñ—Å—Ç—å.',
      mtConfirmation, [mbYes, mbNo], 0) <> mrYes then
  begin
    Exit;
  end;

  Log('=== –ü–û–ß–ê–¢–û–ö –ó–ê–ö–†–ò–¢–¢–Ø –ó–ú–Ü–ù–ò –ó Z-–ó–í–Ü–¢–û–ú ===');
  Log('Shift ID: ' + ShiftId);
  StartTime := Now;

  btnCloseShiftWithReportCurl.Enabled := False;
  Screen.Cursor := crHourGlass;
  ShiftStatus := nil;

  try // –î–û–î–ê–ù–û: try –¥–ª—è –±–ª–æ–∫—É finally
    // –ö–†–û–ö 1: –ó–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏ (–∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –ø—Ä–æ—Å—Ç–æ–º—É –∑–∞–∫—Ä–∏—Ç—Ç—é)
    Log('–ö—Ä–æ–∫ 1: –ó–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏...');
    FReceiptAPI.ReceiptsDirectory := receiptspath;
    FReceiptAPI.TempDirectory := temppath;
    Success := FReceiptAPI.CloseShiftSimpleCurl(ShiftId, Response, ShiftStatus);

    if not Success then
    begin
      Log('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏: ' + Response);
      ShowMessage('–ü–æ–º–∏–ª–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏: ' + Copy(Response, 1, 200));
      Exit;
    end;

    if not Assigned(ShiftStatus) then
    begin
      Log('‚ùå –ü–æ–º–∏–ª–∫–∞: ShiftStatus = nil –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –≤–∏–∫–ª–∏–∫—É');
      ShowMessage('–ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –∑–º—ñ–Ω–∏');
      Exit;
    end;

    // –ö–†–û–ö 2: –û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å—É CLOSED
    Log('–ö—Ä–æ–∫ 2: –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∑–∞–∫—Ä–∏—Ç—Ç—è...');
    FreeAndNil(ShiftStatus);

    if not FReceiptAPI.WaitForShiftStatus(ShiftId, 'CLOSED', Response, ShiftStatus, 120) then // 120 —Å–µ–∫ —Ç–∞–π–º–∞—É—Ç
    begin
      Log('‚ùå –¢–∞–π–º–∞—É—Ç –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏: ' + Response);
      ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –∑–∞–∫—Ä–∏—Ç—Ç—è –∑–º—ñ–Ω–∏ –≤—á–∞—Å–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.');
      Exit;
    end;

    if not Assigned(ShiftStatus) then
    begin
      Log('‚ùå –ü–æ–º–∏–ª–∫–∞: ShiftStatus = nil –ø—ñ—Å–ª—è –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è');
      ShowMessage('–ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏');
      Exit;
    end;

    // –ö–†–û–ö 3: –û—Ç—Ä–∏–º–∞–Ω–Ω—è Z-–∑–≤—ñ—Ç—É
    Log('–ö—Ä–æ–∫ 3: –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ Z-–∑–≤—ñ—Ç—É...');

    // –û—Ç—Ä–∏–º—É—î–º–æ ID Z-–∑–≤—ñ—Ç—É –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    ZReportId := ExtractZReportIdFromResponse(Response);

    if ZReportId = '' then
    begin
      // –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏ –≤ Response, –ø—Ä–æ–±—É—î–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑ ShiftStatus
      if Assigned(ShiftStatus) and (ShiftStatus.ZReport <> '') then
      begin
        ZReportId := ShiftStatus.ZReport;
        Log('–û—Ç—Ä–∏–º–∞–Ω–æ ZReportId –∑ ShiftStatus: ' + ZReportId);
      end
      else
      begin
        Log('‚ö†Ô∏è Z-–∑–≤—ñ—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ. –°–ø—Ä–æ–±—É—î–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π –∑–≤—ñ—Ç...');
        // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –ø–æ—à—É–∫—É –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ Z-–∑–≤—ñ—Ç—É –¥–ª—è —Ü—ñ—î—ó –∑–º—ñ–Ω–∏
      end;
    end;

    // –ö–†–û–ö 4: –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤ Z-–∑–≤—ñ—Ç—É
    if ZReportId <> '' then
    begin
      Log('–û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ Z-–∑–≤—ñ—Ç—É ID: ' + ZReportId);

      // 4.1 JSON –≤–µ—Ä—Å—ñ—è
      if FReceiptAPI.GetZReportCurl(ZReportId, ZReportResponse) then
      begin
        Log('‚úÖ –î–µ—Ç–∞–ª—å–Ω–∏–π Z-–∑–≤—ñ—Ç –æ—Ç—Ä–∏–º–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
        ParseAndShowZReport(ZReportResponse);
      end
      else
      begin
        Log('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π Z-–∑–≤—ñ—Ç: ' + FReceiptAPI.LastError);
      end;

      // 4.2 –¢–µ–∫—Å—Ç–æ–≤–∞ –≤–µ—Ä—Å—ñ—è
      GetZReportTextAndSave(ZReportId);

      // 4.3 PNG –≤–µ—Ä—Å—ñ—è
      GetZReportPNGAndSave(ZReportId);

    end
    else
    begin
      Log('‚ö†Ô∏è ID Z-–∑–≤—ñ—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –î–µ—Ç–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π.');
      ShowMessage('–ó–º—ñ–Ω—É —É—Å–ø—ñ—à–Ω–æ –∑–∞–∫—Ä–∏—Ç–æ, –∞–ª–µ –¥–µ—Ç–∞–ª—å–Ω–∏–π Z-–∑–≤—ñ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π.');
    end;

    // –ö–†–û–ö 5: –§—ñ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è
    Log('‚úÖ –ó–º—ñ–Ω—É —É—Å–ø—ñ—à–Ω–æ –∑–∞–∫—Ä–∏—Ç–æ –∑ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è–º Z-–∑–≤—ñ—Ç—É!');
    Log('–°–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä: ' + IntToStr(ShiftStatus.Serial));
    Log('–ß–∞—Å –∑–∞–∫—Ä–∏—Ç—Ç—è: ' + DateTimeToStr(ShiftStatus.ClosedAt));

    if Assigned(ShiftStatus.Balance) then
    begin
      Log('–§—ñ–Ω–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å: ' + Format('%.2f –≥—Ä–Ω', [ShiftStatus.Balance.Balance / 100]));
    end;

    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
    btnCloseShiftSimpleCurl.Enabled := False;
    btnCloseShiftWithReportCurl.Enabled := False;
    ClearShiftState;

    Log('–ó–º—ñ–Ω—É —É—Å–ø—ñ—à–Ω–æ –∑–∞–∫—Ä–∏—Ç–æ!' + sLineBreak +
               'Z-–∑–≤—ñ—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö.' + sLineBreak +
               '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–∞–ø–∫—É: ' + receiptspath);
    UpdateShiftStatus(svClosed);
  except
    on E: Exception do
    begin
      Log('üí• –í–∏–Ω—è—Ç–æ–∫ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ –∑–º—ñ–Ω–∏ –∑ Z-–∑–≤—ñ—Ç–æ–º: ' + E.Message);
      ShowMessage('–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: ' + E.Message);
    end;
  end; // –ó–ê–ö–†–ò–¢–û: try –±–ª–æ–∫
  UpdateAllStatuses;
  // –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è - —Ç–µ–ø–µ—Ä —Ü–µ —á–∞—Å—Ç–∏–Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–ª–æ–∫—É
  if Assigned(ShiftStatus) then
    FreeAndNil(ShiftStatus);

  btnCloseShiftWithReportCurl.Enabled := True;
  Screen.Cursor := crDefault;

  Log('=== –ó–ê–í–ï–†–®–ï–ù–ù–Ø –ó–ê–ö–†–ò–¢–¢–Ø –ó–ú–Ü–ù–ò –ó Z-–ó–í–Ü–¢–û–ú ===');
  Log('–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: ' + IntToStr(SecondsBetween(Now, StartTime)) + ' —Å–µ–∫');
end;


// –î–û–î–ê–Ñ–ú–û –ù–û–í–£ –ü–†–û–¶–ï–î–£–†–£ –î–õ–Ø –ü–ê–†–°–ò–ù–ì–£ –¢–ê –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø Z-–ó–í–Ü–¢–£
procedure TFmChek.ParseAndShowZReport(const AZReportJSON: string);
var
  JsonParser: TJSONParser;
  JsonData: TJSONObject;
  ZReportInfo: string;
begin
  try
    JsonParser := TJSONParser.Create(AZReportJSON, [joUTF8]);
    try
      JsonData := JsonParser.Parse as TJSONObject;

      // –§–æ—Ä–º—É—î–º–æ –∑—Ä–æ–∑—É–º—ñ–ª—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ Z-–∑–≤—ñ—Ç
      ZReportInfo := 'Z-–∑–≤—ñ—Ç —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!' + sLineBreak +
                    'ID: ' + JsonData.Get('id', '') + sLineBreak +
                    '–°–µ—Ä—ñ–π–Ω–∏–π –Ω–æ–º–µ—Ä: ' + IntToStr(JsonData.Get('serial', 0)) + sLineBreak +
                    '–§—ñ—Å–∫–∞–ª—å–Ω–∏–π –∫–æ–¥: ' + JsonData.Get('fiscal_code', '') + sLineBreak +
                    'ID –∑–º—ñ–Ω–∏: ' + JsonData.Get('shift_id', '');

      // –î–æ–¥–∞—Ç–∫–æ–≤–æ –º–æ–∂–Ω–∞ –ø–∞—Ä—Å–∏—Ç–∏ payments, taxes —Ç–æ—â–æ
      if JsonData.Find('payments') <> nil then
        ZReportInfo := ZReportInfo + sLineBreak + '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–ª–∞—Ç–µ–∂—ñ–≤: ' +
          IntToStr(JsonData.Arrays['payments'].Count);

      if JsonData.Find('taxes') <> nil then
        ZReportInfo := ZReportInfo + sLineBreak + '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–¥–∞—Ç–∫—ñ–≤: ' +
          IntToStr(JsonData.Arrays['taxes'].Count);

      {ShowMessage(ZReportInfo);}
      Log('Z-–∑–≤—ñ—Ç –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–æ: ' + Copy(ZReportInfo, 1, 100));

    finally
      JsonData.Free;
    end;
  except
    on E: Exception do
    begin
      Log('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É Z-–∑–≤—ñ—Ç—É: ' + E.Message);
      ShowMessage('Z-–∑–≤—ñ—Ç –æ—Ç—Ä–∏–º–∞–Ω–æ, –∞–ª–µ –≤–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –∞–Ω–∞–ª—ñ–∑—É: ' + E.Message);
    end;
  end;
end;

procedure TFmChek.FormShow(Sender: TObject);
var
  nsch, rkv, vr,i: integer;
  Response: string;
  ShiftStatus: TShiftStatus;
  CashRegisterStatus: TCashRegisterStatus;
  ShiftId: string;
  CashRegisterId: string;
  PreviousUseCheckboxAPI: Boolean;
  AuthSuccess: Boolean;
  AuthResponse: string;
  TempCurrentKlient,TempCurrentSchet:integer;
begin
  DMMag.readconf;
  IniPropStorage1.IniFileName := ExtractFilePath(ParamStr(0))+'magazin.ini';
  IniPropStorage1.IniSection:='PATH';
  reppath:=IniPropStorage1.ReadString('ReportPath','');
  logpath:=IniPropStorage1.ReadString('LogPath','');
  temppath:=IniPropStorage1.ReadString('TempPath','');
  receiptspath:=IniPropStorage1.ReadString('ReceiptsPath','');
  IniPropStorage1.IniSection:='SECURE';
  level:=IniPropStorage1.ReadInteger('Level',0)=1;
  IniPropStorage1.IniSection:='OPTIONS';
  fmndata.DateEdit1.ReadOnly:=IniPropStorage1.ReadInteger('EditDate',0)=0;
  DMMag.pereschcen:=IniPropStorage1.ReadInteger('Pereschetcen',0)=1;
  if IniPropStorage1.ReadInteger('CreateChkBoxLogs',0)=1 then createlogs:=true else createlogs:=false;
  // ‚úÖ –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –õ–û–ì-–§–ê–ô–õ–£ (—è–∫—â–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ)
  if createlogs then  InitializeLogFile;

  TempCurrentKlient:=IniPropStorage1.ReadInteger('CheckStore',0);
  if TempCurrentKlient>0 then
  begin
    label1.Caption:=DMMag.ZaprosString('NAZVA','select nazva from klient where kod='+inttostr(TempCurrentKlient));
    DMMag.QKl.SQL.Clear;
    DMMag.QKl.SQL.Add('select * from klient where kod='+inttostr(TempCurrentKlient));
  end
  else label4.Caption:='–ù–µ –∑–∞–¥–∞–Ω–æ –º—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —á–µ–∫—ñ–≤ (–Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è)!';

  IniPropStorage1.IniSection:='CHECKBOX';

  // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è
  PreviousUseCheckboxAPI := UseCheckboxAPI;
  UseCheckboxAPI:=IniPropStorage1.ReadInteger('UseCheckboxAPI',0)=1;
  GoodsTaxGroup:=IniPropStorage1.ReadInteger('GoodsTaxGroup',3);
  edtUsername.Text:=IniPropStorage1.ReadString('Username','test_cwmtmpukq');
  edtPassword.Text:=IniPropStorage1.ReadString('Password','test_cwmtmpukq');
  edtClientName.Text:=IniPropStorage1.ReadString('ClientName','–ú–∞–≥–∞–∑–∏–Ω—á–∏–∫');
  edtClientVersion.Text:=IniPropStorage1.ReadString('ClientVersion','1.0.0.1123');
  edtBaseURL.Text:=IniPropStorage1.ReadString('BaseURL','https://api.checkbox.ua');
  edtLicenseKey.Text:=IniPropStorage1.ReadString('LicenseKey','test91a62701a16859b94c3419fe');
  edtFiscalCode.Text:=IniPropStorage1.ReadString('FiscalCode','');
  edtCashRegisterId.Text:=IniPropStorage1.ReadString('CashRegisterId','');
  edtPinCode.Text:=IniPropStorage1.ReadString('Pin','');
  //rbPassword.Checked := IniPropStorage1.ReadInteger('PinLogin', 0) = 0;
  Pinlogin := IniPropStorage1.ReadInteger('PinLogin', 0)=1;
  if not PinLogin then
    rbPassword.Checked := True
  else
    rbPinCode.Checked := True;
  FCashierNameFromIni := IniPropStorage1.ReadString('CashierName', '–¢–µ—Å—Ç–æ–≤–∏–π –∫–∞—Å–∏—Ä');
  FDepartamentFromIni := IniPropStorage1.ReadString('Departament', '–¢–µ—Å—Ç–æ–≤–∏–π –≤—ñ–¥–¥—ñ–ª');

  FCurrentBalance := -1; // –ü–æ—á–∞—Ç–∫–æ–≤–µ –Ω–µ–¥—ñ–π—Å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
  fseAmount.Value:=0;
  {-----------------------}
  TempCurrentSchet:=0;
  DMMag.TrMag.StartTransaction;
  DMMag.SQLQ.SQL.Clear;
  DMMag.SQLQ.SQL.Add('select kod from schet where klient='+inttostr(TempCurrentKlient)+' and data_vv='+#39+FormatDateTime('dd.mm.yyyy',Date)+#39);
  DMMag.SQLQ.Active:=true;
  if DMMag.SQLQ.FieldByName('KOD').IsNull then
  begin
    DMMag.SQLQ.Active:=false;
    DMMag.TrMag.Commit;
    if (TempCurrentKlient>0) then
    begin
      vr:=DMMag.Zapros('VID_RAS','select VID_RAS from klient where kod='+inttostr(TempCurrentKlient));
      nsch:=DMMag.Zapros('max','select max(nomer) from schet')+1;
      rkv:=DMMag.Zapros('rekvizit','select rekvizit from klient where kod='+inttostr(TempCurrentKlient));
      DMMag.LaunchQuery(DMMag.SQLQ,DMMag.TrMag,
         'insert into schet(klient,data_vv,nomer,rekvizit,vid_ras,nazva,sch_summa,nak_summa,nak_summa_prih,nak_fin_rez,priznak,kr_prizn) '+
          'values('+inttostr(TempCurrentKlient)+','+
          #39+FormatDateTime('dd.mm.yyyy',Date)+#39+','+
          inttostr(nsch)+','+
          inttostr(rkv)+','+
          inttostr(vr)+','+
          #39+Label1.Caption+#39+','+
          '0,0,0,0,0,0)');
      DMMag.TrMag.StartTransaction;
      DMMag.SQLQ.SQL.Clear;
      DMMag.SQLQ.SQL.Add('select kod from schet where klient='+inttostr(TempCurrentKlient)+' and data_vv='+#39+FormatDateTime('dd.mm.yyyy',Date)+#39);
      DMMag.SQLQ.Active:=true;
    end
    else messagedlg('–û–ø–µ—Ä–∞—Ü—ñ—è –Ω–µ–º–æ–∂–ª–∏–≤–∞(–∫–ª—ñ—î–Ω—Ç?) !',mtError,[mbOk],0);
  end;
  TempCurrentSchet:=DMMag.SQLQ.FieldByName('KOD').AsInteger;
  DMMag.SQLQ.Active:=false;

  {============}
  DMMag.SQLQ.SQL.Clear;
  DMMag.SQLQ.SQL.Add('select s.nomer,s.data_vv,p.nal_kod as nal_kod,p.svid as psvid,p.nazva as pnazva,p.nazshort as pnazshort');
  DMMag.SQLQ.SQL.Add('from schet s,rekvizit r,prodavec p');
  DMMag.SQLQ.SQL.Add('where s.kod='+inttostr(TempCurrentSchet));
  DMMag.SQLQ.SQL.Add('and s.rekvizit=r.kod and r.prodavec=p.kod');
  DMMag.SQLQ.Active:=true;

  if DMMag.SQLQ.FieldByName('nomer').IsNull then nomer:= ''
  else nomer:= DMMag.SQLQ.FieldByName('nomer').asstring;

  if DMMag.SQLQ.FieldByName('data_vv').IsNull then datavv:= '"____"________________________20____—Ä.'
  else datavv:= DecDate(DMMag.SQLQ.FieldByName('data_vv').AsDateTime);

  if DMMag.SQLQ.FieldByName('nal_kod').IsNull then nalkod:= ''
  else nalkod:=DMMag.SQLQ.FieldByName('nal_kod').AsString;

  if DMMag.SQLQ.FieldByName('psvid').IsNull then psvid:= ''
  else psvid:=DMMag.SQLQ.FieldByName('psvid').AsString;

  if DMMag.SQLQ.FieldByName('pnazva').IsNull then pnazva:= ''
  else pnazva:=DMMag.SQLQ.FieldByName('pnazva').AsString;

  if DMMag.SQLQ.FieldByName('pnazshort').IsNull then pnazshort:= ''
  else pnazshort:=DMMag.SQLQ.FieldByName('pnazshort').AsString;

  DMMag.SQLQ.Active:=false;
  {===========}

  DMMag.TrMag.Commit;

  // –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ú–ï–ù–ï–î–ñ–ï–†–ê –ë–î –ü–Ü–°–õ–Ø –û–¢–†–ò–ú–ê–ù–ù–Ø SCHET
  if Assigned(FDBManager) then
    FreeAndNil(FDBManager);
  FDBManager := TChekDBManager.Create(DMMag, @Self.Log, TempCurrentSchet);
  FDBManager.CurrentSchet:= TempCurrentSchet;
  FDBManager.CurrentKlient:= TempCurrentKlient;

  Log('‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä –ë–î —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –∑ schet=' + IntToStr(FDBManager.CurrentSchet));

  DMMag.QChek.SQL.Clear;
  DMMag.QChek.SQL.Add('select * from chek where schet='+inttostr(FDBManager.CurrentSchet)+' order by kod');
  {-------------------------------}

  DMMag.schb1:=true;
  DMMag.schb3:=false;
  DmMag.frk:=0;
  DmMag.ssort:=2;

  FDBManager.OpnCon;
  DMMag.QChek.Last;

  // 2. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ª–æ–≥—É
  memLog.Lines.Clear;
  Log('–ó–∞—Å—Ç–æ—Å—É–Ω–æ–∫ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
  chkUseCheckboxAPI.Checked := UseCheckboxAPI;
  ChangeCheckboxAPIFunctionality(UseCheckboxAPI);

  // === –ù–û–í–ò–ô –ö–û–î: –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ö–ê–°–ò ===
  if UseCheckboxAPI then
  begin
    // –û–ù–û–í–õ–Æ–Ñ–ú–û –°–¢–ê–¢–£–°–ò –ù–ê –ü–û–ß–ê–¢–ö–£ –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–á
    UpdateAPIStatus(svProcessing, '–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è...');
    UpdateCashierStatus(svUnknown);
    UpdateCashRegisterStatus(svUnknown);
    UpdateShiftStatus(svUnknown);

    Log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É Checkbox API...');

    // ‚≠ê‚≠ê –°–ü–†–û–©–ï–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–∞—à—É –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ—é ‚≠ê‚≠ê
    if ValidateAPIState(False, False) then  // Basic check only
    begin
      Log('API —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ');

      // –û–ù–û–í–õ–Æ–Ñ–ú–û –°–¢–ê–¢–£–° API
      UpdateAPIStatus(svOnline);

      // –û–Ω–æ–≤–∏—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–∞—Å–∏—Ä–∞
      UpdateCashierInfo;

      // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Å–∏
      LoadCashRegisterPreferences;

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Å–∏, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
      if FReceiptAPI.CurrentCashRegisterId = '' then
      begin
        Log('–°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤–∏–±–æ—Ä—É –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ—ó –∫–∞—Å–∏...');
        // –û–ù–û–í–õ–Æ–Ñ–ú–û –°–¢–ê–¢–£–° –ö–ê–°–ò
        UpdateCashRegisterStatus(svProcessing, '–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä...');

        if InitializeOptimalCashRegister(Response) then
        begin
          Log('–ö–∞—Å—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±—Ä–∞–Ω–æ: ' + Copy(FReceiptAPI.CurrentCashRegisterId, 1, 8) + '...');
          SaveCashRegisterPreferences;

          // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–∞—Å –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
          RefreshCashRegisterList;
        end
        else
        begin
          Log('–ù–µ –≤–¥–∞–ª–æ—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±—Ä–∞—Ç–∏ –∫–∞—Å—É: ' + Response);
          // –û–ù–û–í–õ–Æ–Ñ–ú–û –°–¢–ê–¢–£–° –ö–ê–°–ò –ü–†–ò –ü–û–ú–ò–õ–¶–Ü
          UpdateCashRegisterStatus(svError, '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–∞—Ç–∏');

          // –ü—Ä–æ–ø–æ–Ω—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –≤–∏–±—Ä–∞—Ç–∏ –≤—Ä—É—á–Ω—É
          RefreshCashRegisterList;

          if Length(FCashRegisters) > 0 then
          begin
            ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±—Ä–∞—Ç–∏ –∫–∞—Å—É.' + sLineBreak +
                       '–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –∫–∞—Å—É –≤—Ä—É—á–Ω—É –∑—ñ —Å–ø–∏—Å–∫—É.');
          end
          else
          begin
            ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –∫–∞—Å. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑ º—î–¥–Ω–∞–Ω–Ω—è.');
          end;
        end;
      end
      else
      begin
        Log('–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω—É –∫–∞—Å—É: ' + Copy(FReceiptAPI.CurrentCashRegisterId, 1, 8) + '...');
        // –û–ù–û–í–õ–Æ–Ñ–ú–û –°–¢–ê–¢–£–° –ö–ê–°–ò
        UpdateCashRegisterStatus(svReady, '–ó–±–µ—Ä–µ–∂–µ–Ω–∞ –∫–∞—Å–∞');

        // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–∞—Å —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        RefreshCashRegisterList;

        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø–æ—Ç–æ—á–Ω—É –∫–∞—Å—É
        if Length(FCashRegisters) > 0 then
        begin
          for i := 0 to High(FCashRegisters) do
          begin
            if FCashRegisters[i].Id = FReceiptAPI.CurrentCashRegisterId then
            begin
              Break;
            end;
          end;
        end;
      end;

      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ID –∫–∞—Å–∏
      if FReceiptAPI.CurrentCashRegisterId = '' then
      begin
        Log('‚ö†Ô∏è –£–í–ê–ì–ê: ID –∫–∞—Å–∏ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –û–ø–µ—Ä–∞—Ü—ñ—ó –∑ –≥–æ—Ç—ñ–≤–∫–æ—é –±—É–¥—É—Ç—å –Ω–µ–º–æ–∂–ª–∏–≤—ñ.');
        UpdateCashRegisterStatus(svError, 'ID –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
      end
      else
      begin
        Log('‚úÖ ID –∫–∞—Å–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ' + Copy(FReceiptAPI.CurrentCashRegisterId, 1, 8) + '...');
      end;
    end
    else
    begin
      Log('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ API –∞–±–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è');
      UpdateAPIStatus(svError, '–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó');
      UpdateCashierStatus(svError, '–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó');
    end;

    // 6. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Ñ–∞–π–ª—É —Å—Ç–∞–Ω—É –∑–º—ñ–Ω–∏
    ShiftId := FReceiptAPI.LoadShiftFromFile;
    if ShiftId <> '' then
    begin
      Log('–ó–Ω–∞–π–¥–µ–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω—É –∑–º—ñ–Ω—É: ' + Copy(ShiftId, 1, 8) + '...');
      // –û–ù–û–í–õ–Æ–Ñ–ú–û –°–¢–ê–¢–£–° –ó–ú–Ü–ù–ò
      UpdateShiftStatus(svProcessing, '–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...');

        // –°–ø—Ä–æ–±–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
        if FReceiptAPI.GetShiftStatusCurl(ShiftId, AuthResponse, ShiftStatus) and
           Assigned(ShiftStatus) then
        begin
          try
            if ShiftStatus.Status = 'OPENED' then
            begin
              // –£—Å–ø—ñ—à–Ω–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è
              SynchronizeShiftId(ShiftStatus.Id);
              btnCloseShiftSimpleCurl.Enabled := True;

              // –û–ù–û–í–õ–Æ–Ñ–ú–û –°–¢–ê–¢–£–° –ó–ú–Ü–ù–ò
              UpdateShiftStatus(svOpened, '‚Ññ' + IntToStr(ShiftStatus.Serial));

              Log('–ó–º—ñ–Ω—É —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ: ' + ShiftStatus.Id + sLineBreak +
                         '–ù–æ–º–µ—Ä: ' + IntToStr(ShiftStatus.Serial) + sLineBreak +
                         '–í—ñ–¥–∫—Ä–∏—Ç–∞: ' + DateTimeToStr(ShiftStatus.OpenedAt));

              // –û–Ω–æ–≤–ª—é—î–º–æ –±–∞–ª–∞–Ω—Å –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ—ó –∑–º—ñ–Ω–∏
              if Assigned(ShiftStatus.Balance) then
              begin
                FCurrentBalance := ShiftStatus.Balance.Balance;
                UpdateCashBalance;
                Log(Format('–ë–∞–ª–∞–Ω—Å –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ—ó –∑–º—ñ–Ω–∏: %.2f –≥—Ä–Ω', [FCurrentBalance / 100]));
              end;
            end
            else
            begin
              // –ó–º—ñ–Ω–∞ –≤–∂–µ –∑–∞–∫—Ä–∏—Ç–∞ –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∞
              Log('–ó–±–µ—Ä–µ–∂–µ–Ω–∞ –∑–º—ñ–Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞. –°—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
              // –û–ù–û–í–õ–Æ–Ñ–ú–û –°–¢–ê–¢–£–° –ó–ú–Ü–ù–ò
              UpdateShiftStatus(svClosed, '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞');
              ClearShiftStateFile;
              ShowMessage('–ó–±–µ—Ä–µ–∂–µ–Ω–∞ –∑–º—ñ–Ω–∞ –≤–∂–µ –∑–∞–∫—Ä–∏—Ç–∞ –∞–±–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞. –°—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
            end;
          finally
            FreeAndNil(ShiftStatus);
          end;
        end
        else
        begin
          // –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å—É
          Log('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏: ' + AuthResponse);
          // –û–ù–û–í–õ–Æ–Ñ–ú–û –°–¢–ê–¢–£–° –ó–ú–Ü–ù–ò
          UpdateShiftStatus(svError, '–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏');

          if MessageDlg('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏',
              '–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ—ó –∑–º—ñ–Ω–∏.' + sLineBreak +
              '–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:' + sLineBreak +
              '- –í—Ç—Ä–∞—á–µ–Ω–æ –∑–≤''—è–∑–æ–∫ –∑ —Å–µ—Ä–≤–µ—Ä–æ–º' + sLineBreak +
              '- –ó–º—ñ–Ω–∞ –±—É–ª–∞ –≤–∏–¥–∞–ª–µ–Ω–∞' + sLineBreak +
              '- –ü—Ä–æ–±–ª–µ–º–∏ –∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—î—é' + sLineBreak + sLineBreak +
              '–í–∏–¥–∞–ª–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞–Ω?',
              mtWarning, [mbYes, mbNo], 0) = mrYes then
          begin
            ClearShiftStateFile;
            Log('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∏–¥–∞–ª–∏–≤ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞–Ω –∑–º—ñ–Ω–∏');
          end
          else
          begin
            Log('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–±–µ—Ä—ñ–≥ —Å—Ç–∞–Ω –∑–º—ñ–Ω–∏ –¥–ª—è –ø–æ–¥–∞–ª—å—à–∏—Ö —Å–ø—Ä–æ–±');
          end;
        end;
    end
    else
    begin
      Log('–ó–±–µ—Ä–µ–∂–µ–Ω–∞ –∑–º—ñ–Ω–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
      // –û–ù–û–í–õ–Æ–Ñ–ú–û –°–¢–ê–¢–£–° –ó–ú–Ü–ù–ò
      UpdateShiftStatus(svClosed, '–ù–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
    end;

    // –ê–∫—Ç–∏–≤—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ —Å—Ç–∞–Ω—É
    if (FReceiptAPI.CurrentShiftId <> '') then
    begin
      btnCloseShiftSimpleCurl.Enabled := True;
      Log('–Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑—ñ –∑–º—ñ–Ω–æ—é');
    end;
   UpdateAllStatuses;
  end;
  // === –ö–Ü–ù–ï–¶–¨ –ù–û–í–û–ì–û –ö–û–î–£ ===
  LoadCashRegisterPreferences;
  if not ValidateAPIState(False, False, True) then // –ü–æ—Ç—Ä—ñ–±–µ–Ω —Å–ø–∏—Å–æ–∫ –∫–∞—Å
      Exit;
  RefreshCashRegisterList;  // –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫
  // –ó–Ω–∞–π—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π ID —É —Å–ø–∏—Å–∫—É
  for i := 0 to High(FCashRegisters) do
  begin
    if FCashRegisters[i].Id = edtCashRegisterId.Text then
    begin
      cmbCashRegisters.ItemIndex := i;
      cmbCashRegistersChange(nil);  // –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –≤–∏–±—ñ—Ä
      Break;
    end;
  end;

  Log('–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ñ–æ—Ä–º–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');


  if Assigned(FReceiptAPI) then
  begin
    Log('=== –î–ï–¢–ê–õ–¨–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê –¢–û–ö–ï–ù–ê ===');
    Log('API assigned: ‚úÖ');
    Log('IsTokenValid: ' + BoolToStr(FReceiptAPI.IsTokenValid, True));
    Log('AuthToken available: ' + BoolToStr(FReceiptAPI.AuthToken <> '', True));
    Log('AuthToken length: ' + IntToStr(Length(FReceiptAPI.AuthToken)));
    Log('================================');
  end
  else
  begin
    Log('=== –î–ï–¢–ê–õ–¨–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê –¢–û–ö–ï–ù–ê ===');
    Log('API assigned: ‚ùå');
    Log('================================');
  end;
  CheckPendingFiscalizations;

  UpdateAllStatuses;
end;


procedure TFmChek.frReport1GetValue(const ParName: String;
  var ParValue: Variant);
begin
 if ParName = 'nomer' then ParValue:= nomer
 else if ParName = 'datavv' then ParValue:= datavv
 else if ParName = 'nalkod' then ParValue:= nalkod
 else if ParName = 'psvid' then ParValue:= psvid
 else if ParName = 'pnazshort' then ParValue:=pnazshort
 else if ParName = 'pnazva' then ParValue:=pnazva
 else  if ParName = 'sump' then
 begin
  if DMMag.QChekSUMMA.IsNull then
  ParValue:= ''
  else
  ParValue:= suma_prop(floattostrf(round(DMMag.QChekSUMMA.Asfloat*100)/100,ffNumber,10,2));
 end;
end;


procedure TFmChek.Log(const AMessage: string);
var
  LineText: string;
begin
  // –û–±—Ä–æ–±–∫–∞ –≤–∏–≤–æ–¥—É –≤ memLog (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
  if (Length(AMessage) > 0) and (AMessage[1] = '.') then
  begin
    LineText := FormatDateTime('hh:nn:ss', Now) + ' - ' + '‚ö° ' + Copy(AMessage, 2, MaxInt);
    memLog.Lines.Add(LineText);
    memLog.Lines.Add('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    memLog.Lines.Add(''); // –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫
  end
  else
  begin
    LineText := FormatDateTime('hh:nn:ss', Now) + ' - ' + AMessage;
    memLog.Lines.Add(LineText);
  end;

  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ –∫—ñ–Ω—Ü—è
  memLog.SelStart := Length(memLog.Text);

  // –ó–∞–ø–∏—Å —É —Ñ–∞–π–ª –¢–Ü–õ–¨–ö–ò —è–∫—â–æ createlogs = True
  if createlogs then
    WriteLogToFile(LineText);
end;

procedure TFmChek.btnCheckConnectivityClick(Sender: TObject);
var
  Response: string;
  JsonData: TJSONObject;
  JsonParser: TJSONParser;
  CashierName: string;
begin
  if not ValidateAPIState(False, False) then  // Basic API only
    Exit;

  Application.ProcessMessages; // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å

  if FReceiptAPI.CheckConnectivityCurl(Response) then
  begin
    Log('–ó º—î–¥–Ω–∞–Ω–Ω—è —É—Å–ø—ñ—à–Ω–µ: ' + Copy(Response, 1, 200));
    UpdateAPIStatus(svOnline);

    // –°–ø—Ä–æ–±–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ —ñ–º'—è –∫–∞—Å–∏—Ä–∞ –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    CashierName := '–ö–∞—Å–∏—Ä';
    try
      JsonParser := TJSONParser.Create(Response, [joUTF8]);
      JsonData := JsonParser.Parse as TJSONObject;
      try
        if JsonData.Find('full_name') <> nil then
          CashierName := JsonData.Get('full_name', '–ö–∞—Å–∏—Ä');
      finally
        JsonData.Free;
      end;
    except
      // –Ø–∫—â–æ –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ –≤–¥–∞–≤—Å—è, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    end;

    ShowMessage('–ó º—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º Checkbox —É—Å–ø—ñ—à–Ω–µ!' + sLineBreak +
                '–ö–∞—Å–∏—Ä: ' + CashierName);
  end
  else
  begin
    Log('–ü–æ–º–∏–ª–∫–∞ –∑ º—î–¥–Ω–∞–Ω–Ω—è: ' + Response);
    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å - –ø–æ–º–∏–ª–∫–∞
    UpdateAPIStatus(svOffline);
    ShowMessage('–ü–æ–º–∏–ª–∫–∞ –∑ º—î–¥–Ω–∞–Ω–Ω—è: ' + Response);
  end;
end;

procedure TFmChek.btnGetPrinterStatusClick(Sender: TObject);
var
  Response: string;
begin
  if not ValidateAPIState(False, False) then  // Basic API only
    Exit;
 if FReceiptAPI.GetPrinterStatusCurl(Response) then
    Log('–°—Ç–∞—Ç—É—Å –ø—Ä–∏–Ω—Ç–µ—Ä–∞: ' + Copy(Response, 1, 200))
  else
    Log('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–∞: ' + Response);
end;

procedure TFmChek.btnGetFiscalMemoryStatusClick(Sender: TObject);
var
  Response: string;
begin
  if not ValidateAPIState(False, False) then  // Basic API only
    Exit;
 if FReceiptAPI.GetFiscalMemoryStatusCurl(Response) then
    Log('–°—Ç–∞—Ç—É—Å —Ñ—ñ—Å–∫–∞–ª—å–Ω–æ—ó –ø–∞–º º—è—Ç—ñ: ' + Copy(Response, 1, 200))
  else
    Log('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ñ—ñ—Å–∫–∞–ª—å–Ω–æ—ó –ø–∞–º º—è—Ç—ñ: ' + Response);
end;

procedure TFmChek.btnProcessOfflineReceiptsClick(Sender: TObject);
begin
  if not ValidateAPIState(False, False) then  // Basic API only
    Exit;
 if FReceiptAPI.ProcessOfflineReceipts then
    Log('–û—Ñ–ª–∞–π–Ω-—á–µ–∫–∏ –æ–±—Ä–æ–±–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ')
  else
    Log('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –æ—Ñ–ª–∞–π–Ω-—á–µ–∫—ñ–≤');
end;

// –°–ø—Ä–æ—â–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è - –ø—Ä–æ—Å—Ç–æ –≤–∏–¥–∞–ª—è—î–º–æ —Ñ–∞–π–ª
procedure TFmChek.ClearShiftStateFile;
var
  ConfigDir: string;
begin
  ConfigDir := GetAppConfigDir(False);
  if FileExists(ConfigDir + 'shift_state.ini') then
  begin
    DeleteFile(ConfigDir + 'shift_state.ini');
    Log('–§–∞–π–ª —Å—Ç–∞–Ω—É –∑–º—ñ–Ω–∏ –≤–∏–¥–∞–ª–µ–Ω–æ');
  end;
end;


function TFmChek.ValidateShiftId(const AShiftId: string): Boolean;
begin
  Result := (AShiftId <> '') and (Length(AShiftId) = 36); // UUID –º–∞—î 36 —Å–∏–º–≤–æ–ª—ñ–≤
  if not Result then
    Log('–ù–µ–¥—ñ–π—Å–Ω–∏–π ID –∑–º—ñ–Ω–∏: ' + AShiftId);
end;

procedure TFmChek.SynchronizeShiftId(const AShiftId: string);
begin
  // –î–û–î–ê–ù–û: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–∏–π —Ä—è–¥–æ–∫
  if AShiftId = '' then
  begin
    ClearShiftState;
    Exit;
  end;

  if not ValidateShiftId(AShiftId) then
  begin
    Log('–°–ø—Ä–æ–±–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –Ω–µ–¥—ñ–π—Å–Ω–æ–≥–æ ID –∑–º—ñ–Ω–∏: ' + AShiftId);
    Exit;
  end;

  if Assigned(FReceiptAPI) then
  begin
    FReceiptAPI.CurrentShiftId := AShiftId;
    FReceiptAPI.SaveShiftToFile(AShiftId);
  end;

  // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —á–∞—Å—Ç–∏–Ω—É ID –¥–ª—è –±–µ–∑–ø–µ–∫–∏
  edtShiftId.Text := AShiftId;
  edtShiftId.Hint := 'ID: ' + AShiftId + ' (–≤–∏–¥–∏–º—ñ –ª–∏—à–µ –ø–µ—Ä—à—ñ 8 —Å–∏–º–≤–æ–ª—ñ–≤)';

  Log('ID –∑–º—ñ–Ω–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ: ' + Copy(AShiftId, 1, 8) + '...');
end;



procedure TFmChek.ClearShiftState;
begin
  if Assigned(FReceiptAPI) then
  begin
    FReceiptAPI.CurrentShiftId := '';
    FReceiptAPI.SaveShiftToFile(''); // –û—á–∏—â–∞—î–º–æ —Ñ–∞–π–ª
  end;
  edtShiftId.Text := '';
  ClearShiftStateFile; // –î–æ–¥–∞–π—Ç–µ —Ü–µ–π –≤–∏–∫–ª–∏–∫
  btnCloseShiftSimpleCurl.Enabled := False;
  Log('–°—Ç–∞–Ω –∑–º—ñ–Ω–∏ –æ—á–∏—â–µ–Ω–æ');
end;


procedure TFmChek.SaveSettings;
begin
  // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Checkbox API
  IniPropStorage1.IniSection:='CHECKBOX';
  if edtPinCode.Text <> '' then IniPropStorage1.WriteString('Pin', edtPinCode.Text);
  IniPropStorage1.WriteString('Username', edtUsername.Text);
  IniPropStorage1.WriteString('Password', edtPassword.Text);
  IniPropStorage1.WriteString('ClientName', edtClientName.Text);
  IniPropStorage1.WriteString('ClientVersion', edtClientVersion.Text);
  IniPropStorage1.WriteString('BaseURL', edtBaseURL.Text);
  IniPropStorage1.WriteString('LicenseKey', edtLicenseKey.Text);
  IniPropStorage1.WriteString('FiscalCode', edtFiscalCode.Text);
  IniPropStorage1.WriteString('CashRegisterId', edtCashRegisterId.Text);
  if rbPassword.Checked then
  begin
    IniPropStorage1.WriteInteger('PinLogin', 0);
    PinLogin := False;
  end
  else if rbPinCode.Checked then
  begin
    IniPropStorage1.WriteInteger('PinLogin', 1);
    PinLogin := True;
  end;

  Log('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
end;

procedure TFmChek.SaveCashRegisterId(const ACashRegisterId: string);
begin
  if ACashRegisterId <> '' then
  begin
    edtCashRegisterId.Text := ACashRegisterId;
    IniPropStorage1.IniSection:='CHECKBOX';
    IniPropStorage1.WriteString('CashRegisterId', ACashRegisterId);
    Log('ID –∫–∞—Å–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó: ' + Copy(ACashRegisterId, 1, 8) + '...');
  end;
end;

procedure TFmChek.SaveFiscalCode(const AFiscalCode: string);
begin
  if AFiscalCode <> '' then
  begin
    edtFiscalCode.Text := AFiscalCode;
    IniPropStorage1.IniSection:='CHECKBOX';
    IniPropStorage1.WriteString('FiscalCode', AFiscalCode);
    Log('–§—ñ—Å–∫–∞–ª—å–Ω–∏–π –Ω–æ–º–µ—Ä –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó: ' + AFiscalCode);
  end;
end;

procedure TFmChek.edtFiscalCodeChange(Sender: TObject);
begin
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –∑–º—ñ–Ω–∏ —Ñ—ñ—Å–∫–∞–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
  if edtFiscalCode.Text <> '' then
  begin
    IniPropStorage1.IniSection:='CHECKBOX';
    IniPropStorage1.WriteString('FiscalCode', edtFiscalCode.Text);
  end;
end;

procedure TFmChek.edtCashRegisterIdChange(Sender: TObject);
begin
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –∑–º—ñ–Ω–∏ ID –∫–∞—Å–∏
  if edtCashRegisterId.Text <> '' then
  begin
    IniPropStorage1.IniSection:='CHECKBOX';
    IniPropStorage1.WriteString('CashRegisterId', edtCashRegisterId.Text);
  end;
end;

// –û–Ω–æ–≤—ñ—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—É –¥–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ PageControl
procedure TFmChek.PageControl1Change(Sender: TObject);
begin
  try
    if PageControl1.ActivePage = tsCash then
    begin
      Application.ProcessMessages;

      if not (csLoading in ComponentState) and not (csDestroying in ComponentState) then
      begin
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –≤—ñ–¥–∫—Ä–∏—Ç–∞ –∑–º—ñ–Ω–∞ –ø–µ—Ä–µ–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º –±–∞–ª–∞–Ω—Å—É
        if Assigned(FReceiptAPI) and (FReceiptAPI.CurrentShiftId <> '') then
        begin
          UpdateBalanceAfterOperation; // –¢–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω—É –ø—Ä–æ—Ü–µ–¥—É—Ä—É
        end
        else
        begin
          // –Ø–∫—â–æ –∑–º—ñ–Ω–∏ –Ω–µ–º–∞—î, –ø—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
          FCurrentBalance := -1;
          UpdateCashBalance;
          Log('–ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –∑–º—ñ–Ω–∏ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –±–∞–ª–∞–Ω—Å—É');
        end;
      end;
      UpdateAllStatuses;
    end;
  except
    on E: Exception do
    begin
      Log('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –±–∞–ª–∞–Ω—Å—É: ' + E.Message);
      FCurrentBalance := -1;
      UpdateCashBalance;
    end;
  end;
end;








procedure TFmChek.rbPasswordClick(Sender: TObject);
begin
  PinLogin := False;
  // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  lblPassword.Enabled := True;
  edtPassword.Enabled := True;
  lblUsername.Enabled := True;
  edtUsername.Enabled := True;

  lblPinCode.Enabled := False;
  edtPinCode.Enabled := False;
  btnPinCodeLogin.Enabled := False;
end;


procedure TFmChek.rbPinCodeClick(Sender: TObject);
begin
  PinLogin := True;
  // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  lblPassword.Enabled := False;
  edtPassword.Enabled := False;
  lblUsername.Enabled := False;
  edtUsername.Enabled := False;

  lblPinCode.Enabled := True;
  edtPinCode.Enabled := True;
  btnPinCodeLogin.Enabled := True;
end;


procedure TFmChek.tsCashShow(Sender: TObject);
begin
  try
    Application.ProcessMessages;
    UpdateAllStatuses;
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –∑–º—ñ–Ω–∏
    if Assigned(FReceiptAPI) and (FReceiptAPI.CurrentShiftId <> '') then
    begin
      UpdateBalanceAfterOperation; // –¢–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω—É –ø—Ä–æ—Ü–µ–¥—É—Ä—É
    end
    else
    begin
      FCurrentBalance := -1;
      UpdateCashBalance;
      Log('–í—ñ–¥–∫—Ä–∏—Ç–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≥–æ—Ç—ñ–≤–∫–∏, –∞–ª–µ –∑–º—ñ–Ω–∞ –Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞');
    end;

  except
    on E: Exception do
    begin
      Log('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –≥–æ—Ç—ñ–≤–∫–∏: ' + E.Message);
      FCurrentBalance := -1;
      UpdateCashBalance;
    end;
  end;
end;


procedure TFmChek.UpdateBalanceAfterOperation;
var
  Response: string;
  ShiftStatus: TShiftStatus;
  Success: Boolean;
begin
  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∑–º—ñ–Ω–Ω—ñ
  ShiftStatus := nil;

  try
    // 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó API —Ç–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∑–º—ñ–Ω–∏
    if not Assigned(FReceiptAPI) or (FReceiptAPI.CurrentShiftId = '') then
    begin
      Log('API –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –∞–±–æ –∑–º—ñ–Ω–∞ –Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞! –ù–µ–º–æ–∂–ª–∏–≤–æ –æ–Ω–æ–≤–∏—Ç–∏ –±–∞–ª–∞–Ω—Å');
      FCurrentBalance := -1;
      UpdateCashBalance;
      Exit;
    end;

    Log('–û–Ω–æ–≤–ª–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É –ø—ñ—Å–ª—è –æ–ø–µ—Ä–∞—Ü—ñ—ó...');

    // 2. –û—Ç—Ä–∏–º—É—î–º–æ —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É
    Success := FReceiptAPI.GetShiftStatusCurl(FReceiptAPI.CurrentShiftId, Response, ShiftStatus);

    if Success and Assigned(ShiftStatus) then
    begin
      try
        // –ü–ï–†–ï–í–Ü–†–ö–ê: —á–∏ —ñ—Å–Ω—É—î –æ–±'—î–∫—Ç Balance
        if Assigned(ShiftStatus.Balance) then
        begin
          // –û–Ω–æ–≤–ª—é—î–º–æ –±–∞–ª–∞–Ω—Å –∑ –¥–∞–Ω–∏—Ö –∑–º—ñ–Ω–∏
          FCurrentBalance := ShiftStatus.Balance.Balance;
          FReceiptAPI.CurrentBalance := FCurrentBalance; // –¢–µ–ø–µ—Ä —Ü–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ!

          Log(Format('–ë–∞–ª–∞–Ω—Å —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ: %.2f –≥—Ä–Ω', [FCurrentBalance / 100]));
        end
        else
        begin
          Log('–ü–æ–º–∏–ª–∫–∞: –æ–± º—î–∫—Ç Balance –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –≤ ShiftStatus');
          FCurrentBalance := -1;
        end;

        // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        UpdateCashBalance;

      finally
        FreeAndNil(ShiftStatus);
      end;
    end
    else
    begin
      Log('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –∑–º—ñ–Ω–∏: ' + Response);
      FCurrentBalance := -1;
      UpdateCashBalance;
    end;

  except
    on E: Exception do
    begin
      Log('–í–∏–Ω—è—Ç–æ–∫ –≤ UpdateBalanceAfterOperation: ' + E.Message);
      FCurrentBalance := -1;
      UpdateCashBalance;
      if Assigned(ShiftStatus) then
        FreeAndNil(ShiftStatus);
    end;
  end;
  UpdateAllStatuses;
end;


// –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –±–∞–ª–∞–Ω—Å—É
function TFmChek.CalculateLocalBalance: Integer;
begin
  // –¢—É—Ç –º–æ–∂–Ω–∞ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É
  // –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ—Å—Ç–æ—Ä—ñ—ó –æ–ø–µ—Ä–∞—Ü—ñ–π
  Result := FCurrentBalance; // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è —è–∫ fallback
end;


procedure TFmChek.UpdateCashBalance;
begin
  if not Assigned(FReceiptAPI) or (FReceiptAPI.CurrentShiftId = '') then
  begin
    lblBalance.Caption := '–ó–∞–ª–∏—à–æ–∫ –∫–∞—Å–∏: --- –≥—Ä–Ω';
    lblBalance.Font.Color := clGray;
    Exit;
  end;

  // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
  if FCurrentBalance >= 0 then
  begin
    lblBalance.Caption := Format('–ó–∞–ª–∏—à–æ–∫ –∫–∞—Å–∏: %.2f –≥—Ä–Ω', [FCurrentBalance / 100]);

    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∫–æ–ª—å–æ—Ä–∏
    if FCurrentBalance = 0 then
      lblBalance.Font.Color := clBlue
    else if FCurrentBalance > 0 then
      lblBalance.Font.Color := clGreen
    else
      lblBalance.Font.Color := clRed;
  end
  else
  begin
    lblBalance.Caption := '–ó–∞–ª–∏—à–æ–∫ –∫–∞—Å–∏: –æ–Ω–æ–≤–ª–µ–Ω–Ω—è...';
    lblBalance.Font.Color := clBlue;
  end;
end;


procedure TFmChek.ChangeCheckboxAPIFunctionality(Functionality: Boolean);
begin
  Log('–û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É: UseCheckboxAPI=' + BoolToStr(Functionality, True));

  // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤–∏–¥–∏–º—ñ—Å—Ç—å –≤–∫–ª–∞–¥–æ–∫
  tsConnection.TabVisible := Functionality;
  tsOperations.TabVisible := Functionality;
  tsLog.TabVisible := Functionality;
  tsCash.TabVisible := Functionality;

  // –ê–∫—Ç–∏–≤—É—î–º–æ/–¥–µ–∞–∫—Ç–∏–≤—É—î–º–æ –∫–Ω–æ–ø–∫–∏
  btnCheckConnectivity.Enabled := Functionality;
  btnLoginCurl.Enabled := Functionality;
  btnGetCashRegisterStatusCurl.Enabled := Functionality;
  btnInitializeCashRegister.Enabled := Functionality;
  btnFindCashRegister.Enabled := Functionality;
  btnGetPrinterStatus.Enabled := Functionality;
  btnGetFiscalMemoryStatus.Enabled := Functionality;
  btnSaveSettings.Enabled := Functionality;

  // –ö–Ω–æ–ø–∫–∏, —è–∫—ñ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
  btnLogoutCurl.Enabled := Functionality;
  btnOpenShiftCurl.Enabled := Functionality;
  btnGetShiftStatusCurl.Enabled := Functionality;
  btnCloseShiftSimpleCurl.Enabled := Functionality;
  btnCloseShiftWithReportCurl.Enabled := Functionality;
  btnGoOnline.Enabled := Functionality;
  btnGoOffline.Enabled := Functionality;
  btnForsedShiftClose.Enabled := Functionality;
  btnRecoverShift.Enabled := Functionality;
  btnProcessOfflineReceipts.Enabled := Functionality;
  btbtnSendReceiptCurl.Enabled := Functionality;
  btnCashIn.Enabled := Functionality;
  btnCashOut.Enabled := Functionality;

  // –ê–∫—Ç–∏–≤—É—î–º–æ/–¥–µ–∞–∫—Ç–∏–≤—É—î–º–æ –ø–æ–ª—è –≤–≤–æ–¥—É
  edtBaseURL.Enabled := Functionality;
  edtUsername.Enabled := Functionality;
  edtPassword.Enabled := Functionality;
  edtClientName.Enabled := Functionality;
  edtClientVersion.Enabled := Functionality;
  edtLicenseKey.Enabled := Functionality;
  edtFiscalCode.Enabled := Functionality;
  edtCashRegisterId.Enabled := Functionality;
  edtShiftId.Enabled := Functionality;
  fseAmount.Enabled := Functionality;
  chkSkipClientNameCheck.Enabled := Functionality;

  // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å–∏
  if Functionality then
  begin
    if Assigned(FReceiptAPI) and FReceiptAPI.IsTokenValid then
    begin
      UpdateCashierStatus(svOnline);

      if IsShiftOpen then
      begin
        UpdateShiftStatus(svOpened);
      end
      else
      begin
        UpdateShiftStatus(svClosed);
      end;

      // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –∫–∞—Å–∏, —è–∫—â–æ –≤–æ–Ω–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞
      if FReceiptAPI.CurrentCashRegisterId <> '' then
        UpdateCashRegisterStatus(svReady)
      else
        UpdateCashRegisterStatus(svUnknown);
    end
    else
    begin
      // API –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ, –∞–ª–µ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ
      UpdateAPIStatus(svReady);
      UpdateCashierStatus(svUnknown);
      UpdateCashRegisterStatus(svUnknown);
      UpdateShiftStatus(svUnknown);
    end;

    Log('–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª Checkbox API –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ');
  end
  else
  begin
    // API –≤–∏–º–∫–Ω–µ–Ω–æ - —Å–∫–∏–¥–∞—î–º–æ –≤—Å—ñ —Å—Ç–∞—Ç—É—Å–∏
    UpdateAPIStatus(svDisabled);
    UpdateCashierStatus(svUnknown);
    UpdateCashRegisterStatus(svUnknown);
    UpdateShiftStatus(svUnknown);

    Log('–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª Checkbox API –≤–∏–º–∫–Ω–µ–Ω–æ');

    // –û—á–∏—â–∞—î–º–æ –ø–æ–≤'—è–∑–∞–Ω—ñ –ø–æ–ª—è –ø—Ä–∏ –≤–∏–º–∫–Ω–µ–Ω–Ω—ñ
    lblBalance.Caption := '–ó–∞–ª–∏—à–æ–∫ –∫–∞—Å–∏: --- –≥—Ä–Ω';
    lblBalance.Font.Color := clGray;
  end;

  Application.ProcessMessages;
end;


function TFmChek.IsShiftOpen: Boolean;
var
  ShiftStatus: TShiftStatus;
  Response: string;
begin
  Result := False;

  if not Assigned(FReceiptAPI) or (FReceiptAPI.CurrentShiftId = '') then
    Exit;

  if FReceiptAPI.GetShiftStatusCurl(FReceiptAPI.CurrentShiftId, Response, ShiftStatus) and
     Assigned(ShiftStatus) then
  begin
    try
      Result := (ShiftStatus.Status = 'OPENED');
    finally
      FreeAndNil(ShiftStatus);
    end;
  end;
end;


function TFmChek.CheckAndRenewAuth: Boolean;
var
  Response: string;
  AuthSuccess: Boolean;
begin
  Result := True;

  if not Assigned(FReceiptAPI) then
  begin
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è API
    FReceiptAPI := TReceiptWebAPI.Create(
      edtBaseURL.Text,
      edtClientName.Text,
      edtClientVersion.Text,
      edtLicenseKey.Text,
      @Self.Log
    );
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ—ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
    FReceiptAPI.HandleAuthState(aaLoad);
  end;

  // –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –¥—ñ–π—Å–Ω–∏–π - –≤—Å–µ OK
  if FReceiptAPI.IsTokenValid then
    Exit;

  // –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π —ñ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è - –≤—ñ–¥—Ä–∞–∑—É –æ—á–∏—Å—Ç–∏—Ç–∏ —Ñ–∞–π–ª
  if (Trim(edtPinCode.Text) = '') and (Trim(edtUsername.Text) = '') and (Trim(edtPassword.Text) = '') then
  begin
    Log('–¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π —ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è - –æ—á–∏—â–µ–Ω–Ω—è —Ñ–∞–π–ª—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó');
    FReceiptAPI.HandleAuthState(aaClear);
    Result := False;
    Exit;
  end;

  Log('–¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π, —Å–ø—Ä–æ–±–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...');
  AuthSuccess := False;

  // –°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –∑–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏
  if PinLogin and (Trim(edtPinCode.Text) <> '') then
  begin
    AuthSuccess := FReceiptAPI.PinCodeLoginCurl(edtPinCode.Text, Response);
    if AuthSuccess then
      edtPinCode.Text := ''; // –û—á–∏—Å—Ç–∏—Ç–∏ –¥–ª—è –±–µ–∑–ø–µ–∫–∏
  end;

  if not AuthSuccess and (Trim(edtUsername.Text) <> '') and (Trim(edtPassword.Text) <> '') then
  begin
    AuthSuccess := FReceiptAPI.LoginCurl(edtUsername.Text, edtPassword.Text, Response);
  end;

  if AuthSuccess then
  begin
    Log('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ');
    // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è
    FReceiptAPI.HandleAuthState(aaSave);
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Å–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
    if FReceiptAPI.CurrentCashRegisterId = '' then
    begin
      FReceiptAPI.InitializeFirstCashRegister(Response);
    end;
  end
  else
  begin
    Log('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é: ' + Response);
    // –û—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –ø—Ä–∏ –Ω–µ–≤–¥–∞–ª—ñ–π —Å–ø—Ä–æ–±—ñ
    FReceiptAPI.HandleAuthState(aaClear);
  end;

  Result := AuthSuccess;
end;

// –û–∫—Ä–µ–º–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ü—ñ–π, —â–æ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–µ–∫–∞
function TFmChek.ValidateCheckForFiscalization: Boolean;
begin
  Result := False;

  if DMMag.QChek.IsEmpty or DMMag.QChekKOD.IsNull then
  begin
    ShowMessage('–ù–µ –≤–∏–±—Ä–∞–Ω–æ —á–µ–∫ –¥–ª—è —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó');
    Exit;
  end;

  // –î–û–î–ê–ù–û: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –ø–æ–ª—ñ–≤
  if DMMag.QChekFISCAL_STATUS.IsNull then
  begin
    ShowMessage('–í—ñ–¥—Å—É—Ç–Ω—ñ–π —Å—Ç–∞—Ç—É—Å —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó –¥–ª—è —á–µ–∫–∞');
    Exit;
  end;

  if not DMMag.QChekFISCAL_STATUS.IsNull and
     (DMMag.QChekFISCAL_STATUS.AsString = 'NON_FISCAL') then
  begin
    ShowMessage('–¶–µ —Å–ª—É–∂–±–æ–≤–∏–π —á–µ–∫ - —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è');
    Exit;
  end;

  Result := True;
end;

function TFmChek.ValidateAPIState(RequireShift: Boolean = False;
                                 RequireCashRegister: Boolean = False;
                                 RequireCashRegisterList: Boolean = False): Boolean;
var
  ErrorMessage: string;
begin
  Result := False;

  // 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ—Å—Ç—ñ Checkbox API
  if not UseCheckboxAPI then
  begin
    UpdateAPIStatus(svDisabled);
    ShowMessage('–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª Checkbox API –≤–∏–º–∫–Ω–µ–Ω–æ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö');
    Exit;
  end;

  // 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó API
  if not Assigned(FReceiptAPI) then
  begin
    Log('API –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ!');

    // –°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
    try
      FReceiptAPI := TReceiptWebAPI.Create(
        edtBaseURL.Text,
        edtClientName.Text,
        edtClientVersion.Text,
        edtLicenseKey.Text,
        @Self.Log
      );
      Log('API –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
      UpdateAPIStatus(svReady);
    except
      on E: Exception do
      begin
        UpdateAPIStatus(svError);
        ShowMessage('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó API: ' + E.Message);
        Exit;
      end;
    end;
  end;

  // 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
  if not CheckAndRenewAuth then
  begin
    UpdateCashierStatus(svError);
    ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.');
    Exit;
  end;

  // 4. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—ñ–π—Å–Ω–æ—Å—Ç—ñ —Ç–æ–∫–µ–Ω–∞
  if not FReceiptAPI.IsTokenValid then
  begin
    UpdateCashierStatus(svError);
    ShowMessage('–¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –°–ø—Ä–æ–±—É–π—Ç–µ —É–≤—ñ–π—Ç–∏ –∑–Ω–æ–≤—É.');
    Exit;
  end;

  // 5. –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑–∞ –ø–æ—Ç—Ä–µ–±–æ—é
  if RequireCashRegister and (FReceiptAPI.CurrentCashRegisterId = '') then
  begin
    UpdateCashRegisterStatus(svError);
    ShowMessage('ID –∫–∞—Å–∏ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–π—Ç–µ –∫–∞—Å—É.');
    Exit;
  end;

  if RequireShift and (FReceiptAPI.CurrentShiftId = '') then
  begin
    UpdateShiftStatus(svClosed);
    ShowMessage('–ó–º—ñ–Ω–∞ –Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞. –°–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥–∫—Ä–∏–π—Ç–µ –∑–º—ñ–Ω—É.');
    Exit;
  end;

  // 6. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–ø–∏—Å–∫—É –∫–∞—Å (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
  if RequireCashRegisterList and (Length(FCashRegisters) = 0) then
  begin
    Log('–°–ø–∏—Å–æ–∫ –∫–∞—Å –ø–æ—Ä–æ–∂–Ω—ñ–π, –Ω–∞–º–∞–≥–∞—î–º–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏...');
    RefreshCashRegisterList;  // –í–∏–∫–ª–∏–∫–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É
    if Length(FCashRegisters) = 0 then
    begin
      UpdateCashRegisterStatus(svError);
      ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –∫–∞—Å. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑ º—î–¥–Ω–∞–Ω–Ω—è –∑ Checkbox.');
      Exit;
    end;
  end;

  // –Ø–∫—â–æ –≤—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ
  UpdateAPIStatus(svOnline);
  UpdateCashierStatus(svOnline);

  // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –∫–∞—Å–∏, —è–∫—â–æ –≤–æ–Ω–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
  if FReceiptAPI.CurrentCashRegisterId <> '' then
    UpdateCashRegisterStatus(svReady);

  // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏, —è–∫—â–æ –≤–æ–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞
  if FReceiptAPI.CurrentShiftId <> '' then
    UpdateShiftStatus(svOpened);

  Result := True;
end;


procedure TFmChek.LoadCashRegisterPreferences;
begin
  IniPropStorage1.IniSection := 'CHECKBOX';

  FPreferTestCashRegister := IniPropStorage1.ReadInteger('PreferTestCashRegister', 1) = 1;
  chkPreferTestCashRegister.Checked := FPreferTestCashRegister;

  // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π ID –∫–∞—Å–∏
  edtCashRegisterId.Text := IniPropStorage1.ReadString('DefaultCashRegisterId', '');

  Log('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Å–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: PreferTest=' +
      BoolToStr(FPreferTestCashRegister, True));
end;

procedure TFmChek.SaveCashRegisterPreferences;
begin
  IniPropStorage1.IniSection := 'CHECKBOX';

  IniPropStorage1.WriteInteger('PreferTestCashRegister',
    Ord(chkPreferTestCashRegister.Checked));

  if edtCashRegisterId.Text <> '' then
    IniPropStorage1.WriteString('DefaultCashRegisterId', edtCashRegisterId.Text);

  FPreferTestCashRegister := chkPreferTestCashRegister.Checked;

  Log('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Å–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
end;

function TFmChek.InitializeOptimalCashRegister(var Response: string): Boolean;
var
  i, BestIndex: Integer;
  FoundByFiscal, FoundByPreference: Boolean;
  JsonParser: TJSONParser;
  JsonRoot: TJSONObject;
  JsonData: TJSONArray;
  JsonObj, BranchObj: TJSONObject;
begin
  Result := False;
  SetLength(FCashRegisters, 0); // –û—á–∏—Å—Ç–∏—Ç–∏ –º–∞—Å–∏–≤

  // –î–û–î–ê–ù–û: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –Ω–∞ –ø–æ—á–∞—Ç–∫—É
  UpdateCashRegisterStatus(svProcessing, '–ü–æ—à—É–∫ –∫–∞—Å–∏...');

  if not ValidateAPIState(False, False, True) then
  begin
    // –î–û–î–ê–ù–û: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
    UpdateCashRegisterStatus(svError, '–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ API');
    Exit;
  end;

  BestIndex := -1;
  FoundByFiscal := False;
  FoundByPreference := False;

  if not FReceiptAPI.GetCashRegistersListCurl(Response, FCashRegisters) then
  begin
    Log('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É –∫–∞—Å: ' + Response);
    // –î–û–î–ê–ù–û: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
    UpdateCashRegisterStatus(svError, '–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É');
    Exit;
  end;

  JsonParser := TJSONParser.Create(Response, [joUTF8]);
  try
    JsonRoot := JsonParser.Parse as TJSONObject;
    try
      if JsonRoot.Find('results') <> nil then
      begin
        JsonData := JsonRoot.Get('results', TJSONArray(nil));
        if Assigned(JsonData) then
        begin
          SetLength(FCashRegisters, JsonData.Count);
          for i := 0 to JsonData.Count - 1 do
          begin
            if JsonData.Items[i].JSONType = jtObject then
            begin
              try
                JsonObj := JsonData.Objects[i];
                FCashRegisters[i] := TCashRegister.Create;
                FCashRegisters[i].Id := JsonObj.Get('id', '');
                FCashRegisters[i].FiscalNumber := JsonObj.Get('fiscal_number', '');
                FCashRegisters[i].Active := JsonObj.Get('active', False);
                FCashRegisters[i].Number := JsonObj.Get('number', '');
                FCashRegisters[i].IsTest := JsonObj.Get('is_test', False);

                if (JsonObj.Find('branch') <> nil) and
                   (JsonObj.Items[JsonObj.IndexOfName('branch')].JSONType = jtObject) then
                begin
                  BranchObj := JsonObj.Objects['branch'];
                  FCashRegisters[i].Address := BranchObj.Get('address', '');
                end
                else
                  FCashRegisters[i].Address := JsonObj.Get('address', '');
              except
                on E: Exception do
                begin
                  Log('InitializeOptimalCashRegister: –ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É –∫–∞—Å–∏ #' + IntToStr(i) + ': ' + E.Message +
                      ' (JSON: ' + JsonObj.AsJSON + ')');
                  if Assigned(FCashRegisters[i]) then
                    FreeAndNil(FCashRegisters[i]);
                  FCashRegisters[i] := nil;
                end;
              end;
            end;
          end;
          Log('–û—Ç—Ä–∏–º–∞–Ω–æ —Å–ø–∏—Å–æ–∫ –∫–∞—Å: ' + IntToStr(Length(FCashRegisters)) + ' —à—Ç.');

          // –î–û–î–ê–ù–û: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —Å–ø–∏—Å–∫—É
          UpdateCashRegisterStatus(svProcessing, Format('–ó–Ω–∞–π–¥–µ–Ω–æ %d –∫–∞—Å', [Length(FCashRegisters)]));
        end
        else
        begin
          Log('–ü–æ–ª–µ "results" –Ω–µ —î –º–∞—Å–∏–≤–æ–º');
          // –î–û–î–ê–ù–û: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
          UpdateCashRegisterStatus(svError, '–ü–æ–º–∏–ª–∫–∞ —Ñ–æ—Ä–º–∞—Ç—É –¥–∞–Ω–∏—Ö');
          Exit;
        end;
      end
      else
      begin
        Log('–ü–æ–ª–µ "results" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ JSON');
        // –î–û–î–ê–ù–û: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
        UpdateCashRegisterStatus(svError, '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ');
        Exit;
      end;
    finally
      JsonRoot.Free;
    end;
  except
    on E: Exception do
    begin
      Log('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É: ' + E.Message);
      // –î–û–î–ê–ù–û: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
      UpdateCashRegisterStatus(svError, '–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö');
      for i := 0 to High(FCashRegisters) do
        if Assigned(FCashRegisters[i]) then
          FreeAndNil(FCashRegisters[i]);
      SetLength(FCashRegisters, 0);
      Exit;
    end;
  end;

  // –î–û–î–ê–ù–û: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ –ø–æ—à—É–∫—É –∫–∞—Å–∏
  UpdateCashRegisterStatus(svProcessing, '–í–∏–±—ñ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ—ó –∫–∞—Å–∏...');

  for i := 0 to High(FCashRegisters) do
  begin
    if (edtFiscalCode.Text <> '') and
       (FCashRegisters[i].FiscalNumber = edtFiscalCode.Text) then
    begin
      BestIndex := i;
      FoundByFiscal := True;
      Log('–ó–Ω–∞–π–¥–µ–Ω–æ –∫–∞—Å—É –∑–∞ —Ñ—ñ—Å–∫–∞–ª—å–Ω–∏–º –Ω–æ–º–µ—Ä–æ–º: ' + FCashRegisters[i].FiscalNumber);
      Break;
    end;

    if not FoundByFiscal then
    begin
      if FPreferTestCashRegister and FCashRegisters[i].IsTest and FCashRegisters[i].Active then
      begin
        BestIndex := i;
        FoundByPreference := True;
        Log('–ó–Ω–∞–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤—É –∫–∞—Å—É –∑–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–æ–º: ' + FCashRegisters[i].FiscalNumber);
      end
      else if not FPreferTestCashRegister and not FCashRegisters[i].IsTest and FCashRegisters[i].Active then
      begin
        BestIndex := i;
        FoundByPreference := True;
        Log('–ó–Ω–∞–π–¥–µ–Ω–æ —Ä–æ–±–æ—á—É –∫–∞—Å—É –∑–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–æ–º: ' + FCashRegisters[i].FiscalNumber);
      end;
    end;

    if (BestIndex = -1) and FCashRegisters[i].Active then
    begin
      BestIndex := i;
      Log('–û–±—Ä–∞–Ω–æ –ø–µ—Ä—à—É –∞–∫—Ç–∏–≤–Ω—É –∫–∞—Å—É: ' + FCashRegisters[i].FiscalNumber);
    end;
  end;

  if BestIndex >= 0 then
  begin
    FReceiptAPI.CurrentCashRegisterId := FCashRegisters[BestIndex].Id;
    edtCashRegisterId.Text := FCashRegisters[BestIndex].Id;
    // –í–ò–î–ê–õ–ï–ù–û: UpdateCashRegisterDisplay(FCashRegisters[BestIndex]); - —Ü–µ–π –º–µ—Ç–æ–¥ –±—ñ–ª—å—à–µ –Ω–µ —ñ—Å–Ω—É—î
    cmbCashRegisters.ItemIndex := BestIndex;
    Result := True;

    // –î–û–î–ê–ù–û: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ —É—Å–ø—ñ—Ö—É
    UpdateCashRegisterStatus(svReady,
      Format('%s (%s)', [
        FCashRegisters[BestIndex].FiscalNumber,
        IfThen(FCashRegisters[BestIndex].IsTest, '–¢–µ—Å—Ç–æ–≤–∞', '–†–æ–±–æ—á–∞')
      ])
    );

    Log('–ö–∞—Å—É —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ: ' + FCashRegisters[BestIndex].FiscalNumber);
  end
  else
  begin
    Log('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –ø—ñ–¥—Ö–æ–¥—è—â—É –∫–∞—Å—É');
    // –í–ò–î–ê–õ–ï–ù–û: UpdateCashRegisterDisplay(nil); - —Ü–µ–π –º–µ—Ç–æ–¥ –±—ñ–ª—å—à–µ –Ω–µ —ñ—Å–Ω—É—î

    // –î–û–î–ê–ù–û: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –∫–∞—Å
    if Length(FCashRegisters) = 0 then
      UpdateCashRegisterStatus(svError, '–ö–∞—Å–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ')
    else
      UpdateCashRegisterStatus(svError, '–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–∞—Å');

    // –î–û–î–ê–ù–û: –û—á–∏—â–µ–Ω–Ω—è –ø–æ–ª—è –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
    edtCashRegisterId.Text := '';
  end;
end;


procedure TFmChek.RefreshCashRegisterList;
var
  Response: string;
  i: Integer;
  JsonParser: TJSONParser;
  JsonRoot: TJSONObject;
  JsonData: TJSONArray;
  JsonObj: TJSONObject;
  BranchObj: TJSONObject;
begin
  if not ValidateAPIState(False, False) then
    Exit;

  cmbCashRegisters.Clear;

  if not FReceiptAPI.GetCashRegistersListCurl(Response, FCashRegisters) then
  begin
    Log('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∫–∞—Å: ' + Response);
    ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –∫–∞—Å: ' + Copy(Response, 1, 100));
    Exit;
  end;

  JsonParser := TJSONParser.Create(Response, [joUTF8]);
  try
    JsonRoot := JsonParser.Parse as TJSONObject;
    try
      if JsonRoot.Find('results') <> nil then
      begin
        JsonData := JsonRoot.Get('results', TJSONArray(nil));
        if Assigned(JsonData) then
        begin
          SetLength(FCashRegisters, JsonData.Count);
          for i := 0 to JsonData.Count - 1 do
          begin
            try
              JsonObj := JsonData.Objects[i];
              FCashRegisters[i] := TCashRegister.Create;
              FCashRegisters[i].Id := JsonObj.Get('id', '');
              FCashRegisters[i].FiscalNumber := JsonObj.Get('fiscal_number', '');
              FCashRegisters[i].Active := JsonObj.Get('active', False);
              FCashRegisters[i].Number := JsonObj.Get('number', '');
              FCashRegisters[i].IsTest := JsonObj.Get('is_test', False);

              if (JsonObj.Find('branch') <> nil) and
                 (JsonObj.Items[JsonObj.IndexOfName('branch')].JSONType = jtObject) then
              begin
                BranchObj := JsonObj.Objects['branch'];
                FCashRegisters[i].Address := BranchObj.Get('address', '');
              end
              else
                FCashRegisters[i].Address := JsonObj.Get('address', '');
            except
              on E: Exception do
              begin
                UpdateCashRegisterStatus(svError);
                Log('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É –∫–∞—Å–∏ #' + IntToStr(i) + ': ' + E.Message +
                    ' (JSON: ' + JsonObj.AsJSON + ')');
                if Assigned(FCashRegisters[i]) then
                  FreeAndNil(FCashRegisters[i]);
                FCashRegisters[i] := nil;
              end;
            end;
          end;

          for i := 0 to High(FCashRegisters) do
          begin
            cmbCashRegisters.Items.Add(
              Format('%s: %s (%s) %s', [
                FCashRegisters[i].Number,
                FCashRegisters[i].FiscalNumber,
                IfThen(FCashRegisters[i].IsTest, '–¢–µ—Å—Ç–æ–≤–∞', '–†–æ–±–æ—á–∞'),
                IfThen(FCashRegisters[i].Active, '', '[–ù–ï–ê–ö–¢–ò–í–ù–ê]')
              ])
            );
          end;

          for i := 0 to High(FCashRegisters) do
          begin
            if FCashRegisters[i].Id = edtCashRegisterId.Text then
            begin
              cmbCashRegisters.ItemIndex := i;
              Break;
            end;
          end;

          Log('–°–ø–∏—Å–æ–∫ –∫–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–æ: ' + IntToStr(Length(FCashRegisters)) + ' –∫–∞—Å');
        end
        else
          Log('–ü–æ–ª–µ "results" –Ω–µ —î –º–∞—Å–∏–≤–æ–º');
      end
      else
        Log('–ü–æ–ª–µ "results" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ JSON');
    finally
      JsonRoot.Free;
    end;
  finally
    JsonParser.Free;
  end;
end;


procedure TFmChek.InitializeLogFile;
var
  SessionNumber: Integer;
begin
  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∑–∞–≥–∞–ª—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–µ—Å—Ç–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è
  if not createlogs then
    Exit;

  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
  if not DirectoryExists(logpath) then
    ForceDirectories(logpath);

  // –ó—á–∏—Ç—É—î–º–æ —Ç–∞ –æ–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Å–µ—Å—ñ–π
  FSessionCounter := IniPropStorage1.ReadInteger('SessionCounter', 0) + 1;
  IniPropStorage1.WriteInteger('SessionCounter', FSessionCounter);

  // –°—Ç–≤–æ—Ä—é—î–º–æ —ñ–º'—è —Ñ–∞–π–ª—É –∑ –Ω–æ–º–µ—Ä–æ–º —Å–µ—Å—ñ—ó (—è–∫ –≤ —Å—Ç–∞—Ä–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ + –Ω–æ–º–µ—Ä)
  FCurrentLogFileName := logpath + '/' + FormatDateTime('yyyy-mm-dd', Now) +
                        '_chk_box_log_' + IntToStr(FSessionCounter) + '.txt';

  // –ó–∞–ø–∏—Å—É—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ—Å—ñ—ó
  WriteLogToFile('=== –ù–û–í–ê –°–ï–°–Ü–Ø ===');
  WriteLogToFile('–ß–∞—Å –ø–æ—á–∞—Ç–∫—É: ' + DateTimeToStr(Now));
  WriteLogToFile('–ù–æ–º–µ—Ä —Å–µ—Å—ñ—ó: ' + IntToStr(FSessionCounter));
  WriteLogToFile('–§–∞–π–ª –ª–æ–≥—É: ' + ExtractFileName(FCurrentLogFileName));
  WriteLogToFile('================' + sLineBreak);
end;

procedure TFmChek.WriteLogToFile(const AMessage: string);
var
  LogFile: TextFile;
begin
  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∑–∞–≥–∞–ª—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–µ—Å—Ç–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è
  if not createlogs then
    Exit;

  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —Ñ–∞–π–ª –ª–æ–≥—É
  if FCurrentLogFileName = '' then
  begin
    // –Ø–∫—â–æ —Ñ–∞–π–ª —â–µ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ, —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –π–æ–≥–æ
    InitializeLogFile;

    // –Ø–∫—â–æ –≤—Å–µ —â–µ –ø–æ—Ä–æ–∂–Ω—ñ–π, –≤–∏—Ö–æ–¥–∏–º–æ
    if FCurrentLogFileName = '' then
      Exit;
  end;

  try
    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —Ñ–∞–π–ª –¥–ª—è –¥–æ–ø–∏—Å—É–≤–∞–Ω–Ω—è
    AssignFile(LogFile, FCurrentLogFileName);
    if FileExists(FCurrentLogFileName) then
      Append(LogFile)
    else
      Rewrite(LogFile);

    // –ó–∞–ø–∏—Å—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    WriteLn(LogFile, AMessage);

    // –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä—è–¥–∫–∏ –¥–ª—è —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    if (Length(AMessage) > 0) and (AMessage[1] = '.') then
    begin
      WriteLn(LogFile, '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      WriteLn(LogFile, ''); // –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫
    end;

    CloseFile(LogFile);
  except
    on E: Exception do
    begin
      // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –∑–∞–ø–∏—Å—É –≤ —Ñ–∞–π–ª
      memLog.Lines.Add('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Å—É –≤ –ª–æ–≥-—Ñ–∞–π–ª: ' + E.Message);
    end;
  end;
end;

function TFmChek.RetryFiscalization(Receipt: TReceipt; MaxRetries: Integer): Boolean;
var
  i: Integer;
  Response: string;
  ReceiptResponse: TReceiptResponse;
begin
  Result := False;
  for i := 1 to MaxRetries do
  begin
    Log('–°–ø—Ä–æ–∫–∞ —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó ' + IntToStr(i) + ' –∑ ' + IntToStr(MaxRetries));

    if FReceiptAPI.SendReceiptCurl(Receipt, Response, ReceiptResponse) then
    begin
      Result := True;
      FreeAndNil(ReceiptResponse);
      Break;
    end
    else
    begin
      Log('–ü–æ–º–∏–ª–∫–∞ —Å–ø—Ä–æ–±–∏ ' + IntToStr(i) + ': ' + Response);
      Sleep(2000); // –ó–∞—á–µ–∫–∞—Ç–∏ 2 —Å–µ–∫—É–Ω–¥–∏ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ—é —Å–ø—Ä–æ–±–æ—é
    end;
  end;
end;

procedure TFmChek.ProcessPendingFiscalizations;
begin
  // –û–±—Ä–æ–±–∫–∞ —á–µ–∫—ñ–≤, —è–∫—ñ –Ω–µ –≤–¥–∞–ª–æ—Å—è —Ñ—ñ—Å–∫–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—ñ
  if FReceiptAPI.ProcessOfflineReceipts then
    Log('–û—Ñ–ª–∞–π–Ω-—á–µ–∫–∏ —É—Å–ø—ñ—à–Ω–æ –æ–±—Ä–æ–±–ª–µ–Ω–æ')
  else
    Log('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ –æ—Ñ–ª–∞–π–Ω-—á–µ–∫–∏');
end;

function TFmChek.ValidateReceiptData: Boolean;
begin
  Result := False;

  if DMMag.QNData.RecordCount = 0 then
  begin
    ShowMessage('–ß–µ–∫ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤');
    Exit;
  end;

  if DMMag.QChekSUMMA.AsFloat <= 0 then
  begin
    ShowMessage('–°—É–º–∞ —á–µ–∫–∞ –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0');
    Exit;
  end;

  // –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏...
  Result := True;
end;

procedure TFmChek.UpdateFiscalStatus(CheckID: Integer; Status: string;
  FiscalData: string = ''; ErrorText: string = '');
begin
  FDBManager.UpdateFiscalStatus(CheckID, Status, FiscalData, ErrorText);
end;

procedure TFmChek.MarkCheckAsPrinted(CheckID: Integer);
begin
  FDBManager.MarkCheckAsPrinted(CheckID);
end;


//--------------------------------------------------------------------------------------------------------------------------
// –ú–µ—Ç–æ–¥–∏ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –ë–î –≤ –º–æ–¥—É–ª—ñ Chek
procedure TFmChek.HandleSuccessfulFiscalization(ACheckID: Integer;
  AReceipt: TReceipt; AReceiptResponse: TReceiptResponse);
var
  FiscalCode: string;
  WasFiscalized: Boolean;
  TempResponse: string;
  MaxWaitTime: Integer;
begin
  FiscalCode := AReceiptResponse.FiscalCode;

  // –Ø–∫—â–æ —á–µ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π, –∞–ª–µ —â–µ –Ω–µ –º–∞—î —Ñ—ñ—Å–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥—É
  if (AReceiptResponse.Status in [rsCreated, rsPending]) and (FiscalCode = '') then
  begin
    Log('–ß–µ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π, –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó...');

    // –û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Ñ—ñ—Å–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥—É
    MaxWaitTime := 30; // —Å–µ–∫—É–Ω–¥
    WasFiscalized := WaitForReceiptFiscalization(AReceiptResponse.Id, MaxWaitTime);

    if WasFiscalized then
    begin
      // –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å —á–µ–∫–∞
      if FReceiptAPI.GetReceiptStatusCurl(AReceiptResponse.Id, TempResponse, AReceiptResponse) then
      begin
        FiscalCode := AReceiptResponse.FiscalCode;
        if FiscalCode <> '' then
          Log('–û—Ç—Ä–∏–º–∞–Ω–æ —Ñ—ñ—Å–∫–∞–ª—å–Ω–∏–π –∫–æ–¥: ' + FiscalCode)
        else
          Log('–§—ñ—Å–∫–∞–ª—å–Ω–∏–π –∫–æ–¥ –≤—Å–µ —â–µ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –ø—ñ—Å–ª—è –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è');
      end;
    end;
  end;

  // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤ –ë–î
  if FiscalCode <> '' then
  begin
   // –£ HandleSuccessfulFiscalization –¥–æ–¥–∞–π—Ç–µ:
   Log('HandleSuccessfulFiscalization: ');
   Log('-ReceiptResponse.Id: ' + AReceiptResponse.Id);
   Log('-ReceiptResponse.FiscalCode: ' + AReceiptResponse.FiscalCode);
   Log('-CurrentShiftId: ' + FReceiptAPI.CurrentShiftId);
   Log('-CurrentCashRegisterId: ' + FReceiptAPI.CurrentCashRegisterId);

   FDBManager.UpdateFiscalStatusInDB(ACheckID, 'DONE',
     Format('{"id":"%s","fiscal_code":"%s","serial":%d,"status":"%s","created_at":"%s","total_sum":%d}', [
       AReceiptResponse.Id,
       FiscalCode,
       AReceiptResponse.Serial,
       ReceiptStatusToString(AReceiptResponse.Status),
       FormatDateTime('yyyy-mm-dd hh:nn:ss', Now),
       AReceipt.TotalSum
     ]), '',
     AReceiptResponse.Id,      // FISCAL_ID
     FiscalCode,               // FISCAL_CODE
     AReceiptResponse.Serial,  // FISCAL_SERIAL
     FReceiptAPI.CurrentShiftId,        // SHIFT_ID
     FReceiptAPI.CurrentCashRegisterId  // CASH_REGISTER_ID
   );

    Log('‚úÖ –ß–µ–∫ —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ñ—ñ—Å–∫–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π: ' + FiscalCode);
  end
  else
  begin
    // –Ø–∫—â–æ —Ñ—ñ—Å–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥—É –Ω–µ–º–∞—î, –∞–ª–µ —á–µ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π
    FDBManager.UpdateFiscalStatusInDB(ACheckID, 'PENDING',
      Format('{"id":"%s","status":"%s","created_at":"%s"}', [
        AReceiptResponse.Id,
        ReceiptStatusToString(AReceiptResponse.Status),
        FormatDateTime('yyyy-mm-dd hh:nn:ss', Now)
      ]), '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Ñ—ñ—Å–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥—É',
      AReceiptResponse.Id,      // FISCAL_ID
      '',                       // FISCAL_CODE (–ø–æ—Ä–æ–∂–Ω—ñ–π)
      AReceiptResponse.Serial,  // FISCAL_SERIAL
      FReceiptAPI.CurrentShiftId,
      FReceiptAPI.CurrentCashRegisterId
    );

    Log('‚ö†Ô∏è –ß–µ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π, –∞–ª–µ —Ñ—ñ—Å–∫–∞–ª—å–Ω–∏–π –∫–æ–¥ —â–µ –Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ');
  end;
end;


procedure TFmChek.HandleFailedFiscalization(ACheckID: Integer; const AResponse: string);
var
  ReceiptResponse: TReceiptResponse;
begin
  ReceiptResponse := TReceiptResponse.Create;
  try
    ReceiptResponse.ParseFromJSON(AResponse, FReceiptAPI);
    Log('–§—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—è —á–µ–∫–∞ ' + IntToStr(ACheckID) + ' –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—è: ' + ReceiptResponse.ErrorMessage + ' | Raw: ' + Copy(AResponse, 1, 200));
    FDBManager.UpdateFiscalStatusInDB(ACheckID, 'ERROR', '', ReceiptResponse.ErrorMessage);
    UpdateAPIStatus(svError);
  finally
    ReceiptResponse.Free;
  end;
end;

procedure TFmChek.HandleFiscalizationException(ACheckID: Integer; E: Exception);
begin
  FDBManager.HandleFiscalizationException(ACheckID, E);
  UpdateAPIStatus(svError);
end;

// –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –æ—Ñ–ª–∞–π–Ω-–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è (–∑–∞–≥–ª—É—à–∫–∞)
procedure TFmChek.SaveReceiptToOfflineQueue(CheckID: Integer);
begin
  try
    // –¢—É—Ç –º–æ–∂–µ –±—É—Ç–∏ –ª–æ–≥—ñ–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —á–µ–∫–∞ –≤ –æ—Ñ–ª–∞–π–Ω-—á–µ—Ä–≥—É
    // –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞–ø–∏—Å –≤ –æ–∫—Ä–µ–º—É —Ç–∞–±–ª–∏—Ü—é –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ—ó –æ–±—Ä–æ–±–∫–∏
    DMMag.SQLQ.SQL.Text :=
      'INSERT INTO OFFLINE_RECEIPTS_QUEUE (CHECK_ID, CREATED_AT, STATUS) ' +
      'VALUES (:CHECK_ID, CURRENT_TIMESTAMP, ''PENDING'')';
    DMMag.SQLQ.ParamByName('CHECK_ID').AsInteger := CheckID;
    DMMag.SQLQ.ExecSQL;

    Log('–ß–µ–∫ ' + IntToStr(CheckID) + ' –¥–æ–¥–∞–Ω–æ –¥–æ –æ—Ñ–ª–∞–π–Ω-—á–µ—Ä–≥–∏');
  except
    on E: Exception do
    begin
      Log('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –æ—Ñ–ª–∞–π–Ω-—á–µ—Ä–≥—É: ' + E.Message);
    end;
  end;
end;

function TFmChek.ShouldRetryFiscalization(ACheckID: Integer; const AResponse: string; CurrentRetry: Integer): Boolean;
begin
  // –ú–∞–∫—Å–∏–º—É–º 3 —Å–ø—Ä–æ–±–∏ –¥–ª—è –º–µ—Ä–µ–∂–µ–≤–∏—Ö –ø–æ–º–∏–ª–æ–∫, 1 —Å–ø—Ä–æ–±–∞ –¥–ª—è –ø–æ–º–∏–ª–æ–∫ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
  if IsNetworkError(AResponse) then
    Result := CurrentRetry < 3
  else if (Pos('–≤–∞–ª—ñ–¥–∞—Ü—ñ—ó', AResponse) > 0) or (Pos('validation', LowerCase(AResponse)) > 0) then
    Result := CurrentRetry < 1  // –î–ª—è –ø–æ–º–∏–ª–æ–∫ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó - —Ç—ñ–ª—å–∫–∏ 1 —Å–ø—Ä–æ–±–∞
  else if (Pos('shift', LowerCase(AResponse)) > 0) or (Pos('offline', LowerCase(AResponse)) > 0) then
    Result := CurrentRetry < 1  // –î–ª—è –ø—Ä–æ–±–ª–µ–º –∑—ñ –∑–º—ñ–Ω–æ—é/–æ—Ñ–ª–∞–π–Ω–æ–º - —Ç—ñ–ª—å–∫–∏ 1 —Å–ø—Ä–æ–±–∞
  else
    Result := CurrentRetry < 2; // –î–ª—è —ñ–Ω—à–∏—Ö –ø–æ–º–∏–ª–æ–∫ - –º–∞–∫—Å–∏–º—É–º 2 —Å–ø—Ä–æ–±–∏

  if not Result then
    Log('–î–æ—Å—è–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–± –¥–ª—è —Ü—å–æ–≥–æ —Ç–∏–ø—É –ø–æ–º–∏–ª–∫–∏. –ü–æ—Ç–æ—á–Ω—ñ —Å–ø—Ä–æ–±–∏: ' + IntToStr(CurrentRetry));
end;

function TFmChek.IsNetworkError(const AResponse: string): Boolean;
begin
  Result := (Pos('timeout', LowerCase(AResponse)) > 0) or
            (Pos('network', LowerCase(AResponse)) > 0) or
            (Pos('connection', LowerCase(AResponse)) > 0) or
            (Pos('connect', LowerCase(AResponse)) > 0) or
            (Pos('host', LowerCase(AResponse)) > 0) or
            (Pos('unreachable', LowerCase(AResponse)) > 0);
end;


//------------------------------------------------------------------

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —á–µ–∫–∞ –≤ —Å–ª—É–∂–±–æ–≤–∏–π
procedure TFmChek.ConvertToNonFiscalCheck(CheckID: Integer);
begin
  if MessageDlg('–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è —á–µ–∫–∞ –≤ —Å–ª—É–∂–±–æ–≤–∏–π',
      '–¶–µ–π —á–µ–∫ –±—ñ–ª—å—à–µ –Ω–µ –±—É–¥–µ —Ñ—ñ—Å–∫–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?',
      mtWarning, [mbYes, mbNo], 0) = mrYes then
  begin
    DMMag.SQLQ.SQL.Text :=
      'UPDATE CHEK SET FISCAL_STATUS = ''NON_FISCAL'' WHERE KOD = :CHECK_ID';
    DMMag.SQLQ.ParamByName('CHECK_ID').AsInteger := CheckID;
    DMMag.SQLQ.ExecSQL;

    Log('–ß–µ–∫ ' + IntToStr(CheckID) + ' –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤–∞–Ω–æ –≤ —Å–ª—É–∂–±–æ–≤–∏–π');
    ShowMessage('–ß–µ–∫ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤–∞–Ω–æ –≤ —Å–ª—É–∂–±–æ–≤–∏–π');
  end;
end;

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è —Å–ª—É–∂–±–æ–≤–æ–≥–æ —á–µ–∫–∞ –Ω–∞–∑–∞–¥ —É —Ñ—ñ—Å–∫–∞–ª—å–Ω–∏–π
procedure TFmChek.ConvertToFiscalCheck(CheckID: Integer);
begin
  DMMag.SQLQ.SQL.Text :=
    'UPDATE CHEK SET FISCAL_STATUS = ''PENDING'' WHERE KOD = :CHECK_ID';
  DMMag.SQLQ.ParamByName('CHECK_ID').AsInteger := CheckID;
  DMMag.SQLQ.ExecSQL;

  Log('–°–ª—É–∂–±–æ–≤–∏–π —á–µ–∫ ' + IntToStr(CheckID) + ' –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤–∞–Ω–æ –Ω–∞–∑–∞–¥ —É —Ñ—ñ—Å–∫–∞–ª—å–Ω–∏–π');
  ShowMessage('–ß–µ–∫ —Ç–µ–ø–µ—Ä –æ—á—ñ–∫—É—î —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó');
end;



procedure TFmChek.FillMandatoryReceiptFields(Receipt: TReceipt; CheckID: Integer);
begin
  Receipt.Id := FReceiptAPI.GenerateUUID;
  Log('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ Receipt.Id —á–µ—Ä–µ–∑ API: ' + Receipt.Id);

  //Receipt.CashierName := pnazshort;
  //Receipt.Departament := pnazva;
  Receipt.CashierName := FCashierNameFromIni;
  Receipt.Departament := FDepartamentFromIni;
  Receipt.OrderId := '';

  FillGoodsFromDatabase(Receipt, CheckID);

  Receipt.TotalSum := CalculateTotalSum(Receipt.Goods);
  Receipt.Sum := Receipt.TotalSum;

  Log('–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞ –ø—ñ—Å–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É: ' + FloatToStrF(Receipt.TotalSum/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');

  FillPaymentsFromDatabase(Receipt, CheckID);

  Receipt.Rounding := False;

  Log('–ó–∞–ø–æ–≤–Ω–µ–Ω–æ –æ–±–æ–≤ º—è–∑–∫–æ–≤—ñ –ø–æ–ª—è —á–µ–∫–∞. OrderId: "' + Receipt.OrderId + '"');
end;


procedure TFmChek.FillGoodsFromDatabase(Receipt: TReceipt; CheckID: Integer);
var
  i: Integer;
  Good: TGood;
  GoodItem: TGoodItem;
  TaxGroup: Integer;
begin
  SetLength(Receipt.Goods, 0);

  DMMag.QNData.First;
  i := 0;
  while not DMMag.QNData.Eof do
  begin
    // –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø–æ–¥–∞—Ç–∫–æ–≤—É –≥—Ä—É–ø—É –¥–ª—è —Ç–æ–≤–∞—Ä—É
    TaxGroup := DetermineTaxGroupForProduct(DMMag.QNData.FieldByName('TOVAR').AsString);

    // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–æ–≤–∞—Ä
    Good := TGood.Create;
    try
      Good.Code := DMMag.QNData.FieldByName('TOVAR').AsString;
      Good.Name := DMMag.QNData.FieldByName('NAZVA').AsString;
      Good.Price := Round(DMMag.QNData.FieldByName('CENA').AsFloat * 100);
      Good.Barcode := DMMag.QNData.FieldByName('TOVAR').AsString;

      // –î–æ–¥–∞—î–º–æ –ø–æ–¥–∞—Ç–∫–∏ –¥–ª—è —Ç–æ–≤–∞—Ä—É
      SetLength(Good.Tax, 1);
      Good.Tax[0] := TaxGroup;

      // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é —Ç–æ–≤–∞—Ä—É
      GoodItem := TGoodItem.Create;
      try
        GoodItem.Good := Good;

        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ GoodId —á–µ—Ä–µ–∑ API —Ñ—É–Ω–∫—Ü—ñ—é
        GoodItem.GoodId := FReceiptAPI.GenerateUUID;

        GoodItem.Quantity := Round(DMMag.QNData.FieldByName('KOL').AsFloat * 1000);
        GoodItem.Sum := Round(DMMag.QNData.FieldByName('SUMMA').AsFloat * 100);
        GoodItem.TotalSum := GoodItem.Sum;
        GoodItem.IsReturn := False;
        GoodItem.IsWinningsPayout := False;

        // –î–æ–¥–∞—î–º–æ –ø–æ–¥–∞—Ç–∫–∏ –¥–ª—è –ø–æ–∑–∏—Ü—ñ—ó —Ç–æ–≤–∞—Ä—É
        SetLength(GoodItem.Taxes, 1);
        GoodItem.Taxes[0] := CreateTaxByGroup(TaxGroup);

        // –î–æ–¥–∞—î–º–æ –¥–æ –º–∞—Å–∏–≤—É
        SetLength(Receipt.Goods, Length(Receipt.Goods) + 1);
        Receipt.Goods[High(Receipt.Goods)] := GoodItem;

        Log(Format('–î–æ–¥–∞–Ω–æ —Ç–æ–≤–∞—Ä: %s (–ø–æ–¥–∞—Ç–æ–∫ %d) x %.3f = %.2f –≥—Ä–Ω, GoodId: %s', [
          DMMag.QNData.FieldByName('NAZVA').AsString,
          TaxGroup,
          DMMag.QNData.FieldByName('KOL').AsFloat,
          GoodItem.TotalSum / 100,
          Copy(GoodItem.GoodId, 1, 8) + '...'
        ]));

      except
        on E: Exception do
        begin
          Log('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è GoodItem: ' + E.Message);
          FreeAndNil(GoodItem);
          raise;
        end;
      end;

    except
      on E: Exception do
      begin
        Log('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Good: ' + E.Message);
        FreeAndNil(Good);
        raise;
      end;
    end;

    DMMag.QNData.Next;
    Inc(i);
  end;

  if Length(Receipt.Goods) = 0 then
  begin
    Log('–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: —á–µ–∫ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤!');
    raise Exception.Create('–ß–µ–∫ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó');
  end;

  Log('–£—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ ' + IntToStr(Length(Receipt.Goods)) + ' —Ç–æ–≤–∞—Ä—ñ–≤ –¥–æ —á–µ–∫–∞');
end;


function TFmChek.DetermineTaxGroupForProduct(ProductCode: string): Integer;
begin
  // –¢—É—Ç –º–æ–∂–µ –±—É—Ç–∏ –ª–æ–≥—ñ–∫–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ–¥–∞—Ç–∫–æ–≤–æ—ó –≥—Ä—É–ø–∏ –∑–∞ –∫–æ–¥–æ–º —Ç–æ–≤–∞—Ä—É
  // –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –∞–±–æ –∑–∞ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –±—ñ–∑–Ω–µ—Å—É

  // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ 3-—é –≥—Ä—É–ø—É (0% –±–µ–∑ –ü–î–í)
  Result := GoodsTaxGroup;   //Result := 3;

  // –ü—Ä–∏–∫–ª–∞–¥ –ª–æ–≥—ñ–∫–∏:
  {
  if IsExportedProduct(ProductCode) then
    Result := 3 // 0% –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É
  else if IsMedicalProduct(ProductCode) then
    Result := 4 // –ó–≤—ñ–ª—å–Ω–µ–Ω—ñ –≤—ñ–¥ –ü–î–í
  else if IsReducedRateProduct(ProductCode) then
    Result := 2 // –ü—ñ–ª—å–≥–æ–≤–∞ —Å—Ç–∞–≤–∫–∞ 7%
  else
    Result := 1 // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ —Å—Ç–∞–≤–∫–∞ 20%
  }
end;


procedure TFmChek.FillPaymentsFromDatabase(Receipt: TReceipt; CheckID: Integer);

 function PaymentTypeToString(PaymentType: TPaymentType): string;
 begin
   if PaymentType = ptCash then
     Result := 'CASH'
   else if PaymentType = ptCashless then
     Result := 'CASHLESS'
   else
     Result := 'UNKNOWN (' + IntToStr(Ord(PaymentType)) + ')';
 end;

var
  CashAmount, CardAmount: Integer;
  PaymentType: string;
  i: integer;
  OriginalPaymentType: string;
begin
  SetLength(Receipt.Payments, 0);

  // –î–ï–¢–ê–õ–¨–ù–ï –õ–û–ì–£–í–ê–ù–ù–Ø –ü–û–ß–ê–¢–ö–£ –ú–ï–¢–û–î–£
  Log('=== FillPaymentsFromDatabase ===');
  Log('CheckID: ' + IntToStr(CheckID));
  Log('–ü–æ—á–∞—Ç–æ–∫ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –æ–ø–ª–∞—Ç–∏ –∑ –ë–î');

  // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –ø—Ä–æ –æ–ø–ª–∞—Ç—É –∑ —Ç–∞–±–ª–∏—Ü—ñ CHEK
  DMMag.SQLQ.SQL.Text :=
    'SELECT PAYMENT_TYPE, CASH_AMOUNT, CARD_AMOUNT ' +
    'FROM CHEK WHERE KOD = :CHECK_ID';
  DMMag.SQLQ.ParamByName('CHECK_ID').AsInteger := CheckID;

  try
    DMMag.SQLQ.Open;

    // –ó–ê–ü–ò–°–£–Ñ–ú–û –ü–û–ß–ê–¢–ö–û–í–Ü –î–ê–ù–Ü –î–õ–Ø –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ò
    OriginalPaymentType := DMMag.SQLQ.FieldByName('PAYMENT_TYPE').AsString;
    CashAmount := Round(DMMag.SQLQ.FieldByName('CASH_AMOUNT').AsFloat * 100);
    CardAmount := Round(DMMag.SQLQ.FieldByName('CARD_AMOUNT').AsFloat * 100);

    // –î–ï–¢–ê–õ–¨–ù–ï –õ–û–ì–£–í–ê–ù–ù–Ø –û–¢–†–ò–ú–ê–ù–ò–• –î–ê–ù–ò–•
    Log('--- –î–ê–ù–Ü –ó –ë–ê–ó–ò –î–ê–ù–ò–• ---');
    Log('PAYMENT_TYPE: ' + OriginalPaymentType);
    Log('CASH_AMOUNT: ' + FloatToStrF(DMMag.SQLQ.FieldByName('CASH_AMOUNT').AsFloat, ffNumber, 10, 2) + ' –≥—Ä–Ω');
    Log('CARD_AMOUNT: ' + FloatToStrF(DMMag.SQLQ.FieldByName('CARD_AMOUNT').AsFloat, ffNumber, 10, 2) + ' –≥—Ä–Ω');
    Log('CASH_AMOUNT (–∫–æ–ø): ' + IntToStr(CashAmount));
    Log('CARD_AMOUNT (–∫–æ–ø): ' + IntToStr(CardAmount));
    Log('--- –ö–Ü–ù–ï–¶–¨ –î–ê–ù–ò–• –ó –ë–î ---');

    PaymentType := OriginalPaymentType;

    // –õ–æ–≥ –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ª–æ–≥—ñ–∫–∏ –≤–∏–±–æ—Ä—É
    Log('–û–±—Ä–æ–±–∫–∞ —Ç–∏–ø—É –æ–ø–ª–∞—Ç–∏: ' + PaymentType);
    Log('CashAmount > 0: ' + BoolToStr(CashAmount > 0, True));
    Log('CardAmount > 0: ' + BoolToStr(CardAmount > 0, True));

    // –°–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó
    case PaymentType of
      'CASH':
        begin
          Log('–û–±—Ä–æ–±–∫–∞ CASH –æ–ø–ª–∞—Ç–∏');
          if CashAmount > 0 then
          begin
            SetLength(Receipt.Payments, 1);
            // –ì–æ—Ç—ñ–≤–∫–æ–≤–∞ –æ–ø–ª–∞—Ç–∞ - —Ç–∏–ø "CASH"
            Receipt.Payments[0] := FReceiptAPI.CreatePayment(ptCash, CashAmount);
            Receipt.Payments[0].LabelText := '–ì–æ—Ç—ñ–≤–∫–∞';
            Receipt.Payments[0].Code := 0; // –ö–æ–¥ –¥–ª—è –≥–æ—Ç—ñ–≤–∫–∏

            Log('‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ –≥–æ—Ç—ñ–≤–∫–æ–≤—É –æ–ø–ª–∞—Ç—É: ' + FloatToStrF(CashAmount/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');
            Log('Payment Type: ' + PaymentTypeToString(Receipt.Payments[0].PaymentType));
            Log('Label: ' + Receipt.Payments[0].LabelText);
            Log('Code: ' + IntToStr(Receipt.Payments[0].Code));
            Log('Value: ' + IntToStr(Receipt.Payments[0].Value) + ' –∫–æ–ø');
          end
          else
          begin
            Log('‚ö†Ô∏è –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: CASH —Ç–∏–ø, –∞–ª–µ CashAmount <= 0');
          end;
        end;

      'CARD':
        begin
          Log('–û–±—Ä–æ–±–∫–∞ CARD –æ–ø–ª–∞—Ç–∏');
          if CardAmount > 0 then
          begin
            SetLength(Receipt.Payments, 1);
            // –ë–µ–∑–≥–æ—Ç—ñ–≤–∫–æ–≤–∞ –æ–ø–ª–∞—Ç–∞ - —Ç–∏–ø "CASHLESS"
            Receipt.Payments[0] := FReceiptAPI.CreatePayment(ptCashless, CardAmount);
            Receipt.Payments[0].LabelText := '–ö–∞—Ä—Ç–∫–∞';
            Receipt.Payments[0].Code := 1; // –ö–æ–¥ –¥–ª—è –±–µ–∑–≥–æ—Ç—ñ–≤–∫–æ–≤–æ—ó –æ–ø–ª–∞—Ç–∏

            Log('‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ –∫–∞—Ä—Ç–∫–æ–≤—É –æ–ø–ª–∞—Ç—É: ' + FloatToStrF(CardAmount/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');
            Log('Payment Type: ' + PaymentTypeToString(Receipt.Payments[0].PaymentType));
            Log('Label: ' + Receipt.Payments[0].LabelText);
            Log('Code: ' + IntToStr(Receipt.Payments[0].Code));
            Log('Value: ' + IntToStr(Receipt.Payments[0].Value) + ' –∫–æ–ø');
          end
          else
          begin
            Log('‚ö†Ô∏è –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: CARD —Ç–∏–ø, –∞–ª–µ CardAmount <= 0');
          end;
        end;

      'MIXED':
        begin
          Log('–û–±—Ä–æ–±–∫–∞ MIXED –æ–ø–ª–∞—Ç–∏');
          // –ó–º—ñ—à–∞–Ω–∞ –æ–ø–ª–∞—Ç–∞ - —Å—Ç–≤–æ—Ä—é—î–º–æ –¥–≤–∞ –ø–ª–∞—Ç–µ–∂—ñ
          SetLength(Receipt.Payments, 2);

          // –ì–æ—Ç—ñ–≤–∫–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞
          Receipt.Payments[0] := FReceiptAPI.CreatePayment(ptCash, CashAmount);
          Receipt.Payments[0].LabelText := '–ì–æ—Ç—ñ–≤–∫–∞';
          Receipt.Payments[0].Code := 0;

          // –ö–∞—Ä—Ç–∫–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞
          Receipt.Payments[1] := FReceiptAPI.CreatePayment(ptCashless, CardAmount);
          Receipt.Payments[1].LabelText := '–ö–∞—Ä—Ç–∫–∞';
          Receipt.Payments[1].Code := 1;

          Log('‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ –∑–º—ñ—à–∞–Ω—É –æ–ø–ª–∞—Ç—É:');
          Log('  –ì–æ—Ç—ñ–≤–∫–∞=' + FloatToStrF(CashAmount/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');
          Log('  –ö–∞—Ä—Ç–∫–∞=' + FloatToStrF(CardAmount/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');
          Log('  Payment[0] Type: ' + PaymentTypeToString(Receipt.Payments[0].PaymentType));
          Log('  Payment[1] Type: ' + PaymentTypeToString(Receipt.Payments[1].PaymentType));
        end;

      else
        begin
          Log('‚ùå –ù–ï–í–Ü–î–û–ú–ò–ô –¢–ò–ü –û–ü–õ–ê–¢–ò: ' + PaymentType);
          Log('–î–æ—Å—Ç—É–ø–Ω—ñ —Ç–∏–ø–∏: CASH, CARD, MIXED');

          // –ê–≤–∞—Ä—ñ–π–Ω–∞ –æ–±—Ä–æ–±–∫–∞ - —Å—Ç–≤–æ—Ä—é—î–º–æ –æ–ø–ª–∞—Ç—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
          if (CashAmount > 0) or (CardAmount > 0) then
          begin
            SetLength(Receipt.Payments, 1);
            if CashAmount > 0 then
            begin
              Receipt.Payments[0] := FReceiptAPI.CreatePayment(ptCash, CashAmount);
              Receipt.Payments[0].LabelText := '–ì–æ—Ç—ñ–≤–∫–∞ (–∞–≤—Ç–æ)';
              Receipt.Payments[0].Code := 0;
              Log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±—Ä–∞–Ω–æ CASH: ' + FloatToStrF(CashAmount/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');
            end
            else
            begin
              Receipt.Payments[0] := FReceiptAPI.CreatePayment(ptCashless, CardAmount);
              Receipt.Payments[0].LabelText := '–ö–∞—Ä—Ç–∫–∞ (–∞–≤—Ç–æ)';
              Receipt.Payments[0].Code := 1;
              Log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±—Ä–∞–Ω–æ CARD: ' + FloatToStrF(CardAmount/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');
            end;
          end;
        end;
    end;

    // –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Å—É–º–∫—ñ–≤ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–ª–∞—Ç–µ–∂—ñ–≤
    Log('--- –ü–Ü–î–°–£–ú–ö–ò –°–¢–í–û–†–ï–ù–ò–• –ü–õ–ê–¢–ï–ñ–Ü–í ---');
    Log('–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–ª–∞—Ç–µ–∂—ñ–≤: ' + IntToStr(Length(Receipt.Payments)));
    for i := 0 to High(Receipt.Payments) do
    begin
      if Assigned(Receipt.Payments[i]) then
      begin
        Log('–ü–ª–∞—Ç—ñ–∂[' + IntToStr(i) + ']:');
        Log('  Type: ' + PaymentTypeToString(Receipt.Payments[i].PaymentType));
        Log('  Label: ' + Receipt.Payments[i].LabelText);
        Log('  Code: ' + IntToStr(Receipt.Payments[i].Code));
        Log('  Value: ' + IntToStr(Receipt.Payments[i].Value) + ' –∫–æ–ø');
      end
      else
      begin
        Log('‚ùå –ü–ª–∞—Ç—ñ–∂[' + IntToStr(i) + ']: –ù–ï –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–û–í–ê–ù–û!');
      end;
    end;

  except
    on E: Exception do
    begin
      Log('üí• –í–ò–ù–Ø–¢–û–ö —É FillPaymentsFromDatabase:');
      Log('–ü–æ–º–∏–ª–∫–∞: ' + E.Message);
      Log('–ö–ª–∞—Å: ' + E.ClassName);
      raise; // –ü–µ—Ä–µ–¥–∞—î–º–æ –≤–∏–Ω—è—Ç–æ–∫ –¥–∞–ª—ñ
    end;
  end;

  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—É–º
  Log('--- –ü–ï–†–ï–í–Ü–†–ö–ê –°–£–ú ---');
  Receipt.TotalPayment := 0;
  for i := 0 to High(Receipt.Payments) do
  begin
    if Assigned(Receipt.Payments[i]) then
    begin
      Receipt.TotalPayment := Receipt.TotalPayment + Receipt.Payments[i].Value;
      Log('–î–æ–¥–∞–Ω–æ –ø–ª–∞—Ç—ñ–∂[' + IntToStr(i) + ']: ' + IntToStr(Receipt.Payments[i].Value) + ' –∫–æ–ø');
    end
    else
    begin
      Log('‚ùå –ü—Ä–æ–ø—É—â–µ–Ω–æ –Ω–µ—ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –ø–ª–∞—Ç—ñ–∂[' + IntToStr(i) + ']');
    end;
  end;

  Receipt.Rest := Receipt.TotalPayment - Receipt.TotalSum;

  Log('--- –§–Ü–ù–ê–õ–¨–ù–Ü –°–£–ú–ò ---');
  Log('TotalSum (—Ç–æ–≤–∞—Ä–∏): ' + IntToStr(Receipt.TotalSum) + ' –∫–æ–ø');
  Log('TotalPayment (–æ–ø–ª–∞—Ç–∞): ' + IntToStr(Receipt.TotalPayment) + ' –∫–æ–ø');
  Log('Rest (—Ä–µ—à—Ç–∞): ' + IntToStr(Receipt.Rest) + ' –∫–æ–ø');
  Log('TotalSum (–≥—Ä–Ω): ' + FloatToStrF(Receipt.TotalSum/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');
  Log('TotalPayment (–≥—Ä–Ω): ' + FloatToStrF(Receipt.TotalPayment/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');
  Log('Rest (–≥—Ä–Ω): ' + FloatToStrF(Receipt.Rest/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');

  // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ—Ä–µ–∫—Ç–Ω–æ—Å—Ç—ñ
  if Receipt.TotalPayment < Receipt.TotalSum then
  begin
    Log('‚ö†Ô∏è –£–í–ê–ì–ê: –°—É–º–∞ –æ–ø–ª–∞—Ç–∏ –º–µ–Ω—à–∞ –∑–∞ —Å—É–º—É —Ç–æ–≤–∞—Ä—ñ–≤!');
    Log('–†—ñ–∑–Ω–∏—Ü—è: ' + IntToStr(Receipt.TotalSum - Receipt.TotalPayment) + ' –∫–æ–ø');
  end
  else if Receipt.TotalPayment > Receipt.TotalSum then
  begin
    Log('‚ÑπÔ∏è –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è: –†–µ—à—Ç–∞ –∫–ª—ñ—î–Ω—Ç—É: ' + IntToStr(Receipt.Rest) + ' –∫–æ–ø');
  end;

  Log('=== –ö–Ü–ù–ï–¶–¨ FillPaymentsFromDatabase ===');
end;

function TFmChek.ValidateReceiptStructure(Receipt: TReceipt): Boolean;
var
  ErrorMessages: TStringList;
begin
  ErrorMessages := TStringList.Create;
  try
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
    if Receipt.Id = '' then
      ErrorMessages.Add('–í—ñ–¥—Å—É—Ç–Ω—ñ–π ID —á–µ–∫–∞');

    if Receipt.CashierName = '' then
      ErrorMessages.Add('–í—ñ–¥—Å—É—Ç–Ω—î —ñ–º º—è –∫–∞—Å–∏—Ä–∞');

    if Receipt.Departament = '' then
      ErrorMessages.Add('–í—ñ–¥—Å—É—Ç–Ω—ñ–π –≤—ñ–¥–¥—ñ–ª');

    if Length(Receipt.Goods) = 0 then
      ErrorMessages.Add('–ß–µ–∫ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤');

    if Length(Receipt.Payments) = 0 then
      ErrorMessages.Add('–ß–µ–∫ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å –æ–ø–ª–∞—Ç');

    if Receipt.TotalSum <= 0 then
      ErrorMessages.Add('–°—É–º–∞ —á–µ–∫–∞ –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0');

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ—Ä–µ–∫—Ç–Ω–æ—Å—Ç—ñ —Ç–æ–≤–∞—Ä—ñ–≤
    if not ValidateGoods(Receipt.Goods) then
      ErrorMessages.Add('–ó–Ω–∞–π–¥–µ–Ω–æ –ø–æ–º–∏–ª–∫–∏ –≤ —Ç–æ–≤–∞—Ä–∞—Ö');

    Result := ErrorMessages.Count = 0;

    if not Result then
    begin
      ShowMessage('–ü–æ–º–∏–ª–∫–∏ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ —á–µ–∫–∞:' + sLineBreak +
                 ErrorMessages.Text);
      Log('–ü–æ–º–∏–ª–∫–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —á–µ–∫–∞: ' + ErrorMessages.Text);
    end
    else
    begin
      Log('–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —á–µ–∫–∞ —É—Å–ø—ñ—à–Ω–æ –ø—Ä–æ–π—à–ª–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é');
    end;

  finally
    ErrorMessages.Free;
  end;
end;

function TFmChek.ValidateGoods(Goods: array of TGoodItem): Boolean;
var
  i: Integer;
begin
  Result := True;

  for i := 0 to High(Goods) do
  begin
    if not Assigned(Goods[i]) then
    begin
      Log('–ü–æ–º–∏–ª–∫–∞: —Ç–æ–≤–∞—Ä ' + IntToStr(i) + ' –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π');
      Result := False;
      Continue;
    end;

    if not Assigned(Goods[i].Good) then
    begin
      Log('–ü–æ–º–∏–ª–∫–∞: –æ–± º—î–∫—Ç —Ç–æ–≤–∞—Ä—É ' + IntToStr(i) + ' –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π');
      Result := False;
      Continue;
    end;

    if Goods[i].Good.Code = '' then
    begin
      Log('–ü–æ–º–∏–ª–∫–∞: —Ç–æ–≤–∞—Ä ' + IntToStr(i) + ' –Ω–µ –º–∞—î –∫–æ–¥—É');
      Result := False;
    end;

    if Goods[i].Good.Name = '' then
    begin
      Log('–ü–æ–º–∏–ª–∫–∞: —Ç–æ–≤–∞—Ä ' + IntToStr(i) + ' –Ω–µ –º–∞—î –Ω–∞–∑–≤–∏');
      Result := False;
    end;

    if Goods[i].Good.Price <= 0 then
    begin
      Log('–ü–æ–º–∏–ª–∫–∞: —Ç–æ–≤–∞—Ä ' + IntToStr(i) + ' –º–∞—î –Ω—É–ª—å–æ–≤—É –∞–±–æ –≤—ñ–¥ º—î–º–Ω—É —Ü—ñ–Ω—É');
      Result := False;
    end;

    if Goods[i].Quantity <= 0 then
    begin
      Log('–ü–æ–º–∏–ª–∫–∞: —Ç–æ–≤–∞—Ä ' + IntToStr(i) + ' –º–∞—î –Ω—É–ª—å–æ–≤—É –∞–±–æ –≤—ñ–¥ º—î–º–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å');
      Result := False;
    end;

    if Goods[i].TotalSum <= 0 then
    begin
      Log('–ü–æ–º–∏–ª–∫–∞: —Ç–æ–≤–∞—Ä ' + IntToStr(i) + ' –º–∞—î –Ω—É–ª—å–æ–≤—É –∞–±–æ –≤—ñ–¥ º—î–º–Ω—É –∑–∞–≥–∞–ª—å–Ω—É —Å—É–º—É');
      Result := False;
    end;
  end;
end;

function TFmChek.CalculateTotalSum(Goods: array of TGoodItem): Integer;
var
  i: Integer;
begin
  Result := 0;

  for i := 0 to High(Goods) do
  begin
    if Assigned(Goods[i]) then
    begin
      Log(Format('–¢–æ–≤–∞—Ä %d: %s - –∫—ñ–ª—å–∫—ñ—Å—Ç—å: %.3f, —Ü—ñ–Ω–∞: %.2f, —Å—É–º–∞: %.2f', [
        i,
        Goods[i].Good.Name,
        Goods[i].Quantity / 1000,
        Goods[i].Good.Price / 100,
        Goods[i].TotalSum / 100
      ]));
      Result := Result + Goods[i].TotalSum;
    end;
  end;

  Log('–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞ —á–µ–∫–∞: ' + FloatToStrF(Result/100, ffNumber, 10, 2) + ' –≥—Ä–Ω');
end;

function TFmChek.ExceptionToString(E: Exception): string;
begin
  Result := 'Exception: ' + E.ClassName + ' - ' + E.Message;
end;


function TFmChek.CreateTaxByGroup(TaxGroup: Integer): TTax;
begin
  Result := TTax.Create;

  case TaxGroup of
    1: begin // –ü–î–í 20% (–∑–≤–∏—á–∞–π–Ω–∞ —Å—Ç–∞–≤–∫–∞)
      Result.Code := 1;
      Result.LabelText := '–ü–î–í 20%';
      Result.Symbol := 'üü¢';
      Result.Rate := 20.0;
      Result.ExtraRate := 0.0;
      Result.Included := True;
      Result.NoVat := False;
      Result.AdvancedCode := 'VAT';
    end;

    2: begin // –ü–î–í 7% (–ø—ñ–ª—å–≥–æ–≤–∞ —Å—Ç–∞–≤–∫–∞)
      Result.Code := 2;
      Result.LabelText := '–ü–î–í 7%';
      Result.Symbol := 'üü†';
      Result.Rate := 7.0;
      Result.ExtraRate := 0.0;
      Result.Included := True;
      Result.NoVat := False;
      Result.AdvancedCode := 'VAT_REDUCED';
    end;

    3: begin // 0% –±–µ–∑ –ü–î–í (3-—Ç—è –≥—Ä—É–ø–∞)
      Result.Code := 3;
      Result.LabelText := '–ü–î–í 0%';
      Result.Symbol := 'üü°';
      Result.Rate := 0.0;
      Result.ExtraRate := 0.0;
      Result.Included := False;
      Result.NoVat := True;
      Result.AdvancedCode := 'NO_VAT';
    end;

    4: begin // –ë–µ–∑ –ü–î–í (–∑–≤—ñ–ª—å–Ω–µ–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó)
      Result.Code := 4;
      Result.LabelText := '–ë–µ–∑ –ü–î–í';
      Result.Symbol := '‚ö™';
      Result.Rate := 0.0;
      Result.ExtraRate := 0.0;
      Result.Included := False;
      Result.NoVat := True;
      Result.AdvancedCode := 'EXEMPT';
    end;

    else // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º - 3-—Ç—è –≥—Ä—É–ø–∞ (0% –±–µ–∑ –ü–î–í)
      Result.Code := 3;
      Result.LabelText := '–ü–î–í 0%';
      Result.Symbol := 'üü°';
      Result.Rate := 0.0;
      Result.ExtraRate := 0.0;
      Result.Included := False;
      Result.NoVat := True;
      Result.AdvancedCode := 'NO_VAT';
  end;

  // ‚ö†Ô∏è –í–ò–ü–†–ê–í–õ–ï–ù–û: –Ø–≤–Ω–æ set Value=0 –¥–ª—è rate=0, –∞–ª–µ –¥–ª—è –∑–∞–≥–∞–ª—å–Ω–æ—Å—Ç—ñ –¥–æ–¥–∞—Ç–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ (—è–∫—â–æ APrice –ø–µ—Ä–µ–¥–∞–Ω–æ, –∞–ª–µ —Ç—É—Ç –Ω–µ–º–∞—î ‚Äî set 0)
  Result.Value := 0;
  Result.ExtraValue := 0;

  Log(Format('–°—Ç–≤–æ—Ä–µ–Ω–æ –ø–æ–¥–∞—Ç–æ–∫: –≥—Ä—É–ø–∞ %d (%s)', [TaxGroup, Result.LabelText]));
end;

function TFmChek.ReceiptStatusToString(Status: TReceiptStatus): string;
begin
  case Status of
    rsCreated: Result := 'CREATED';
    rsDone: Result := 'DONE';
    rsError: Result := 'ERROR';
    rsPending: Result := 'PENDING';
    rsDelivered: Result := 'DELIVERED';
  else
    Result := 'UNKNOWN';
  end;
end;


function TFmChek.IsShiftReadyForFiscalization: Boolean;
var
  Response: string;
  ShiftStatus: TShiftStatus;
begin
  Result := False;

  if not Assigned(FReceiptAPI) or (FReceiptAPI.CurrentShiftId = '') then
  begin
    ShowMessage('–ó–º—ñ–Ω–∞ –Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞! –°–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥–∫—Ä–∏–π—Ç–µ –∑–º—ñ–Ω—É.');
    Exit;
  end;

  if FReceiptAPI.GetShiftStatusCurl(FReceiptAPI.CurrentShiftId, Response, ShiftStatus) and
     Assigned(ShiftStatus) then
  begin
    try
      Result := (ShiftStatus.Status = 'OPENED') and
                (ShiftStatus.ZReport = '') and // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ Z-–∑–≤—ñ—Ç –Ω–µ –∑—Ä–æ–±–ª–µ–Ω–∏–π
                (not ShiftStatus.EmergencyClose);

      if not Result then
      begin
        ShowMessage('–ó–º—ñ–Ω–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞ –¥–ª—è —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó! –°—Ç–∞—Ç—É—Å: ' + ShiftStatus.Status);
      end;
    finally
      FreeAndNil(ShiftStatus);
    end;
  end
  else
  begin
    ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–∏: ' + Response);
  end;
end;

function TFmChek.WaitForReceiptFiscalization(const AReceiptId: string;
  TimeoutSeconds: Integer = 30): Boolean;
var
  StartTime: TDateTime;
  Response: string;
  ReceiptStatus: TReceiptResponse;
  Status: string;
begin
  Result := False;
  StartTime := Now;
  ReceiptStatus := nil;

  try
    while SecondsBetween(Now, StartTime) < TimeoutSeconds do
    begin
      if FReceiptAPI.GetReceiptStatusCurl(AReceiptId, Response, ReceiptStatus) and
         Assigned(ReceiptStatus) then
      begin
        Status := ReceiptStatusToString(ReceiptStatus.Status);
        Log('–°—Ç–∞—Ç—É—Å —á–µ–∫–∞ ' + AReceiptId + ': ' + Status);

        if Status = 'DONE' then
        begin
          Result := True;
          Log('–ß–µ–∫ —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ñ—ñ—Å–∫–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π: ' + ReceiptStatus.FiscalCode);
          Break;
        end
        else if Status = 'ERROR' then
        begin
          Log('–ü–æ–º–∏–ª–∫–∞ —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó: ' + ReceiptStatus.ErrorMessage);
          Break;
        end;

        // –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–æ—é –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é
        Sleep(2000);
      end
      else
      begin
        Log('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å —á–µ–∫–∞: ' + Response);
        Sleep(3000);
      end;

      FreeAndNil(ReceiptStatus);
    end;

    if not Result then
    begin
      Log('–¢–∞–π–º–∞—É—Ç –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó –¥–ª—è —á–µ–∫–∞: ' + AReceiptId);
    end;

  finally
    if Assigned(ReceiptStatus) then
      FreeAndNil(ReceiptStatus);
  end;
end;

function TFmChek.IsCashRegisterOnline: Boolean;
var
  Response: string;
  CashRegisterStatus: TCashRegisterStatus;
begin
  Result := False;

  if not Assigned(FReceiptAPI) or (FReceiptAPI.CurrentCashRegisterId = '') then
  begin
    ShowMessage('–ö–∞—Å–∞ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞!');
    Exit;
  end;

  if FReceiptAPI.GetCashRegisterStatusCurl(FReceiptAPI.CurrentCashRegisterId,
     Response, CashRegisterStatus) and Assigned(CashRegisterStatus) then
  begin
    try
      Result := not CashRegisterStatus.OfflineMode;

      if not Result then
      begin
        ShowMessage('–ö–∞—Å–∞ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—ñ! –§—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–µ–º–æ–∂–ª–∏–≤–∞.');
        Log('–ö–∞—Å–∞ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—ñ: ' + CashRegisterStatus.FiscalNumber);
      end
      else
      begin
        Log('–ö–∞—Å–∞ –≤ –æ–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º—ñ: ' + CashRegisterStatus.FiscalNumber);
      end;
    finally
      FreeAndNil(CashRegisterStatus);
    end;
  end
  else
  begin
    ShowMessage('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∫–∞—Å–∏: ' + Response);
  end;
end;

procedure TFmChek.CheckPendingFiscalizations;
var
  PendingChecks: TStringList;
  i, CheckID: Integer;
  Response: string;
  ReceiptResponse: TReceiptResponse;
  FiscalId: string;
  ValidChecksCount: Integer;
begin
  if not Assigned(FReceiptAPI) or not FReceiptAPI.IsTokenValid then
  begin
    Log('API –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–µ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤—ñ–¥–∫–ª–∞–¥–µ–Ω–∏—Ö —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ–π');
    Exit;
  end;

  PendingChecks := TStringList.Create;
  ValidChecksCount := 0;

  try
    Log('=== –ü–ï–†–ï–í–Ü–†–ö–ê –í–Ü–î–ö–õ–ê–î–ï–ù–ò–• –§–Ü–°–ö–ê–õ–Ü–ó–ê–¶–Ü–ô ===');

    DMMag.SQLQ.SQL.Text :=
      'SELECT KOD, FISCAL_ID, FISCAL_STATUS FROM CHEK ' +
      'WHERE FISCAL_STATUS IN (''PENDING'', ''SENT'') ' +
      'AND FISCAL_ID IS NOT NULL';

    try
      DMMag.SQLQ.Open;

      while not DMMag.SQLQ.Eof do
      begin
        CheckID := DMMag.SQLQ.FieldByName('KOD').AsInteger;
        FiscalId := Trim(DMMag.SQLQ.FieldByName('FISCAL_ID').AsString);

        if (FiscalId <> '') and (Length(FiscalId) = 36) and
           (FiscalId[1] <> 'R') then
        begin
          if (Pos('-', FiscalId) = 9) and (FiscalId[15] = '-') and
             (FiscalId[20] = '-') and (FiscalId[25] = '-') then
          begin
            PendingChecks.AddObject(FiscalId, TObject(PtrInt(CheckID)));
            Inc(ValidChecksCount);
            Log(Format('–î–æ–¥–∞–Ω–æ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏: —á–µ–∫ %d, FiscalId: %s',
                [CheckID, Copy(FiscalId, 1, 8) + '...']));
          end
          else
          begin
            Log(Format('–ü—Ä–æ–ø—É—â–µ–Ω–æ –Ω–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç FiscalId –¥–ª—è —á–µ–∫–∞ %d: %s',
                [CheckID, FiscalId]));
          end;
        end
        else
        begin
          Log(Format('–ü—Ä–æ–ø—É—â–µ–Ω–æ –Ω–µ–≤—ñ—Ä–Ω–∏–π/–ø–æ—Ä–æ–∂–Ω—ñ–π FiscalId –¥–ª—è —á–µ–∫–∞ %d: "%s"',
              [CheckID, FiscalId]));
        end;

        DMMag.SQLQ.Next;
      end;

      DMMag.SQLQ.Close;

    except
      on E: Exception do
      begin
        Log('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —á–∏—Ç–∞–Ω–Ω—ñ –ë–î: ' + E.Message);
        DMMag.SQLQ.Close;
        Exit;
      end;
    end;

    Log(Format('–ó–Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª—ñ–¥–Ω–∏—Ö —á–µ–∫—ñ–≤ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏: %d –∑ %d',
        [ValidChecksCount, PendingChecks.Count]));

    for i := 0 to PendingChecks.Count - 1 do
    begin
      CheckID := PtrInt(PendingChecks.Objects[i]);
      FiscalId := PendingChecks[i];

      Log(Format('–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å —á–µ–∫–∞ %d: %s',
          [CheckID, Copy(FiscalId, 1, 8) + '...']));

      ReceiptResponse := nil;
      try
        if FReceiptAPI.GetReceiptStatusCurl(FiscalId, Response, ReceiptResponse) then
        begin
          if Assigned(ReceiptResponse) then
          begin
            try
              case ReceiptResponse.Status of
                rsDone:
                  begin
                    FDBManager.UpdateFiscalStatusInDB(CheckID, 'DONE',
                      Format('{"id":"%s","fiscal_code":"%s","serial":%d}', [
                        ReceiptResponse.Id,
                        ReceiptResponse.FiscalCode,
                        ReceiptResponse.Serial
                      ]), '');

                    Log(Format('‚úÖ –í—ñ–¥–∫–ª–∞–¥–µ–Ω–∞ —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è —á–µ–∫–∞ %d: %s',
                        [CheckID, ReceiptResponse.FiscalCode]));
                  end;

                rsError:
                  begin
                    FDBManager.UpdateFiscalStatusInDB(CheckID, 'ERROR', '',
                      ReceiptResponse.ErrorMessage);

                    Log(Format('‚ùå –ü–æ–º–∏–ª–∫–∞ —Ñ—ñ—Å–∫–∞–ª—ñ–∑–∞—Ü—ñ—ó –¥–ª—è —á–µ–∫–∞ %d: %s',
                        [CheckID, ReceiptResponse.ErrorMessage]));
                  end;

                rsPending, rsCreated:
                  begin
                    Log(Format('‚è≥ –ß–µ–∫ %d —â–µ –≤ –æ–±—Ä–æ–±—Ü—ñ. –°—Ç–∞—Ç—É—Å: %s',
                        [CheckID, ReceiptStatusToString(ReceiptResponse.Status)]));
                  end;

                else
                  Log(Format('‚ÑπÔ∏è –ù–µ–≤—ñ–¥–æ–º–∏–π —Å—Ç–∞—Ç—É—Å –¥–ª—è —á–µ–∫–∞ %d: %s',
                      [CheckID, ReceiptStatusToString(ReceiptResponse.Status)]));
              end;

            finally
              FreeAndNil(ReceiptResponse);
            end;
          end
          else
          begin
            Log(Format('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ —Å—Ç–∞—Ç—É—Å—É –¥–ª—è —á–µ–∫–∞ %d', [CheckID]));
          end;
        end
        else
        begin
          Log(Format('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É —Å—Ç–∞—Ç—É—Å—É –¥–ª—è —á–µ–∫–∞ %d: %s',
              [CheckID, Copy(Response, 1, 100)]));

          if Pos('Not Found', Response) > 0 then
          begin
            FDBManager.UpdateFiscalStatusInDB(CheckID, 'ERROR', '',
              '–ß–µ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ Checkbox. –ú–æ–∂–ª–∏–≤–æ, –±—É–≤ –≤–∏–¥–∞–ª–µ–Ω–∏–π.');
            Log(Format('üóëÔ∏è –ß–µ–∫ %d –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ - –ø–æ–∑–Ω–∞—á–µ–Ω–æ —è–∫ –ø–æ–º–∏–ª–∫–∞', [CheckID]));
          end;
        end;

      except
        on E: Exception do
        begin
          Log(Format('üí• –í–∏–Ω—è—Ç–æ–∫ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ —á–µ–∫–∞ %d: %s', [CheckID, E.Message]));
          if Assigned(ReceiptResponse) then
            FreeAndNil(ReceiptResponse);
        end;
      end;

      if i < PendingChecks.Count - 1 then
        Sleep(500);
    end;

    Log('=== –ó–ê–í–ï–†–®–ï–ù–û –ü–ï–†–ï–í–Ü–†–ö–£ –í–Ü–î–ö–õ–ê–î–ï–ù–ò–• –§–Ü–°–ö–ê–õ–Ü–ó–ê–¶–Ü–ô ===');

  finally
    PendingChecks.Free;
  end;
end;

procedure TFmChek.UpdateCashierInfo;
begin
  // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –∫–∞—Å–∏—Ä–∞
  UpdateCashierStatus(svOnline, FCashierNameFromIni);

  Log(Format('–ö–∞—Å–∏—Ä –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π: %s, –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è: %s', [
    FCashierNameFromIni,
    FDepartamentFromIni
  ]));
end;

procedure TFmChek.ClearCashierInfo;
begin
  // –û—á–∏—â–∞—î–º–æ —Å—Ç–∞—Ç—É—Å –∫–∞—Å–∏—Ä–∞
  UpdateCashierStatus(svUnknown);

  Log('–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–∞—Å–∏—Ä–∞ –æ—á–∏—â–µ–Ω–∞');
end;



procedure TFmChek.ChangePaymentType(CheckID: Integer; NewPaymentType: string;
  CashAmount: Double = 0; CardAmount: Double = 0; CardInfo: string = '');
var
  TotalAmount, PaymentTotal: Double;
begin
  // –ü–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è –Ω–∞ —á–µ–∫ —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä
  if not FDBManager.LocateCheck(CheckID) then
  begin
    ShowMessage('–ß–µ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
    Exit;
  end;

  // –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—É–º–∏ —á–µ–∫–∞ —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä
  TotalAmount := FDBManager.GetCheckTotal(CheckID);
  PaymentTotal := CashAmount + CardAmount;

  // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –≤–∏–º–æ–≥ Checkbox API
  if Abs(PaymentTotal - TotalAmount) > 0.01 then
  begin
    ShowMessage(Format(
      '–°—É–º–∞ –æ–ø–ª–∞—Ç–∏ (%.2f) –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—É–º—ñ —á–µ–∫–∞ (%.2f)! ' +
      '–ó–≥—ñ–¥–Ω–æ –∑ Checkbox API, —Å—É–º–∏ –ø–æ–≤–∏–Ω–Ω—ñ –∑–±—ñ–≥–∞—Ç–∏—Å—è.',
      [PaymentTotal, TotalAmount]));
    Exit;
  end;

  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ—Ä–µ–∫—Ç–Ω–æ—Å—Ç—ñ —Ç–∏–ø—É –æ–ø–ª–∞—Ç–∏
  if (NewPaymentType <> 'CASH') and (NewPaymentType <> 'CARD') and (NewPaymentType <> 'MIXED') then
  begin
    ShowMessage('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–∏–ø –æ–ø–ª–∞—Ç–∏. –î–æ–ø—É—Å—Ç–∏–º—ñ –∑–Ω–∞—á–µ–Ω–Ω—è: CASH, CARD, MIXED');
    Exit;
  end;

  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –∑–º—ñ—à–∞–Ω–æ—ó –æ–ø–ª–∞—Ç–∏
  if (NewPaymentType = 'MIXED') and ((CashAmount <= 0) or (CardAmount <= 0)) then
  begin
    ShowMessage('–î–ª—è –∑–º—ñ—à–∞–Ω–æ—ó –æ–ø–ª–∞—Ç–∏ –æ–±–∏–¥–≤—ñ —Å—É–º–∏ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0');
    Exit;
  end;

  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –≥–æ—Ç—ñ–≤–∫–æ–≤–æ—ó –æ–ø–ª–∞—Ç–∏
  if (NewPaymentType = 'CASH') and (CardAmount > 0) then
  begin
    ShowMessage('–î–ª—è –≥–æ—Ç—ñ–≤–∫–æ–≤–æ—ó –æ–ø–ª–∞—Ç–∏ —Å—É–º–∞ –ø–æ –∫–∞—Ä—Ç—Ü—ñ –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ 0');
    Exit;
  end;

  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–∫–æ–≤–æ—ó –æ–ø–ª–∞—Ç–∏
  if (NewPaymentType = 'CARD') and (CashAmount > 0) then
  begin
    ShowMessage('–î–ª—è –∫–∞—Ä—Ç–∫–æ–≤–æ—ó –æ–ø–ª–∞—Ç–∏ –≥–æ—Ç—ñ–≤–∫–æ–≤–∞ —Å—É–º–∞ –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ 0');
    Exit;
  end;

  // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –≤ –ë–î —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä
  FDBManager.UpdatePaymentInfo(CheckID, NewPaymentType, CashAmount, CardAmount,
    CardInfo, '', '', '');

  Log(Format('–ó–º—ñ–Ω–µ–Ω–æ —Ç–∏–ø –æ–ø–ª–∞—Ç–∏ –¥–ª—è —á–µ–∫–∞ %d: %s (–ì:%.2f, –ö:%.2f)',
      [CheckID, NewPaymentType, CashAmount, CardAmount]));
end;



// –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ —Ñ–∞–π–ª–∞–º–∏

procedure TFmChek.SaveStringToFile(const AFileName, AContent: string);
var
  LFile: TStringList;
begin
  LFile := TStringList.Create;
  try
    LFile.Text := AContent;
    LFile.SaveToFile(AFileName);
  finally
    LFile.Free;
  end;
end;


// –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ Z-–∑–≤—ñ—Ç–æ–º
function TFmChek.ExtractZReportIdFromResponse(Response: string): string;
var
  JsonParser: TJSONParser;
  JsonData: TJSONObject;
  ZReportObj: TJSONData;
begin
  Result := '';
  JsonParser := nil;
  JsonData := nil;

  try
    JsonParser := TJSONParser.Create(Response, [joUTF8]);
    JsonData := JsonParser.Parse as TJSONObject;

    if Assigned(JsonData) then
    begin
      // Z-–∑–≤—ñ—Ç –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –ø–æ–ª—ñ z_report
      ZReportObj := JsonData.Find('z_report');
      if Assigned(ZReportObj) and (ZReportObj.JSONType = jtObject) then
      begin
        Result := TJSONObject(ZReportObj).Get('id', '');
      end
      else
      begin
        // –°–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ ID –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ –∫–æ—Ä–µ–Ω—ñ
        Result := JsonData.Get('id', '');
      end;
    end;
  except
    on E: Exception do
    begin
      Log('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É Z-–∑–≤—ñ—Ç—É –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: ' + E.Message);
    end;
  end;

  // –ó–≤—ñ–ª—å–Ω–µ–Ω–Ω—è –ø–∞–º'—è—Ç—ñ
  if Assigned(JsonData) then
    JsonData.Free;
  if Assigned(JsonParser) then
    JsonParser.Free;
end;


procedure TFmChek.GetZReportTextAndSave(ReportId: string);
var
  ReportText, FileName: string;
begin
  if FReceiptAPI.GetSummaryReportText(ReportId, ReportText, rtZReport) then  // –ó–º—ñ–Ω–∏–ª–∏ –Ω–∞ GetReportText (–±–µ–∑ Curl)
  begin
    FileName := 'zreport_' + ReportId + '_' + FormatDateTime('yyyy-mm-dd_hh-nn-ss', Now) + '.txt';
    SaveStringToFile(temppath +'/'+ FileName, ReportText);  // –ó–º—ñ–Ω–∏–ª–∏ GetTempPath –Ω–∞ FReceiptAPI.TempDirectory
    Log('–¢–µ–∫—Å—Ç Z-–∑–≤—ñ—Ç—É –∑–±–µ—Ä–µ–∂–µ–Ω–æ: ' + FileName);

    // –ü–æ–∫–∞–∑—É—î–º–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∑–≤—ñ—Ç—É
    Log('Z-–∑–≤—ñ—Ç (—Ñ—Ä–∞–≥–º–µ–Ω—Ç): ' + Copy(ReportText, 1, 200));
  end
  else
  begin
    Log('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ç–µ–∫—Å—Ç Z-–∑–≤—ñ—Ç—É');
  end;
end;


procedure TFmChek.GetZReportPNGAndSave(ReportId: string);
var
  FileName: string;
  Success: Boolean;
begin
  FileName := receiptspath + '/zreport_' + ReportId + '_' +  // –ó–º—ñ–Ω–∏–ª–∏ GetReceiptsPath –Ω–∞ FReceiptAPI.ReceiptsDirectory
              FormatDateTime('yyyy-mm-dd_hh-nn-ss', Now) + '.png';

  Success := FReceiptAPI.GetSummaryReportPNG(ReportId, FileName,rtZReport,0,0);  // –ó–º—ñ–Ω–∏–ª–∏ –Ω–∞ GetReportPNG (–±–µ–∑ Curl)

  if Success then
  begin
    Log('PNG Z-–∑–≤—ñ—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ: ' + FileName);
    ShowCheck(FileName);
  end
  else
  begin
    Log('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ PNG Z-–∑–≤—ñ—Ç');
  end;
end;


function TFmChek.DBManagerReady: Boolean;
begin
  Result := Assigned(FDBManager) and (FDBManager.CurrentSchet > 0);
  if not Result then
    Log('–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: –º–µ–Ω–µ–¥–∂–µ—Ä –ë–î –Ω–µ –≥–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–±–æ—Ç–∏');
end;


procedure TFmChek.UpdateStatusBar(StatusType: TStatusType; StatusValue: TStatusValue;
                                  AdditionalText: string = '');
var
  FullText: string;
begin
  if not Assigned(StatusBar1) or (StatusBar1.Panels.Count < 4) then
    Exit;

  // –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –∑ –µ–º–æ–¥–∑—ñ
  FullText := StatusEmoji[StatusValue] + ' ' + StatusText[StatusValue];

  // –î–æ–¥–∞—î–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π —Ç–µ–∫—Å—Ç —è–∫—â–æ —î
  if AdditionalText <> '' then
    FullText := FullText + ' ' + AdditionalText;

  // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—É –ø–∞–Ω–µ–ª—å
  case StatusType of
    stAPI:         StatusBar1.Panels[0].Text := 'API: ' + FullText;
    stCashier:     StatusBar1.Panels[1].Text := '–ö–∞—Å–∏—Ä: ' + FullText;
    stCashRegister:StatusBar1.Panels[2].Text := '–ö–∞—Å–∞: ' + FullText;
    stShift:       StatusBar1.Panels[3].Text := '–ó–º—ñ–Ω–∞: ' + FullText;
  end;

  // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  Application.ProcessMessages;
end;


procedure TFmChek.UpdateAPIStatus(AStatus: TStatusValue; const AAdditional: string = '');
begin
  UpdateStatusBar(stAPI, AStatus, AAdditional);
end;

procedure TFmChek.UpdateCashierStatus(AStatus: TStatusValue; const ACashierName: string = '');
var
  DisplayText: string;
begin
  DisplayText := ACashierName;

  // –Ø–∫—â–æ —ñ–º'—è –∫–∞—Å–∏—Ä–∞ –ø–æ—Ä–æ–∂–Ω—î, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
  if (DisplayText = '') and (FCashierNameFromIni <> '') then
    DisplayText := FCashierNameFromIni;

  UpdateStatusBar(stCashier, AStatus, DisplayText);

  // –û–Ω–æ–≤–ª—é—î–º–æ Label –¥–ª—è –∫–∞—Å–∏—Ä–∞ - –í–ò–ü–†–ê–í–õ–ï–ù–ê –ß–ê–°–¢–ò–ù–ê
  if Assigned(lblCashierName) then
  begin
    if ACashierName <> '' then
      lblCashierName.Caption := ACashierName
    else if FCashierNameFromIni <> '' then
      lblCashierName.Caption := FCashierNameFromIni
    else
      lblCashierName.Caption := '–ö–∞—Å–∏—Ä';
  end;
end;

procedure TFmChek.UpdateCashRegisterStatus(AStatus: TStatusValue; const ARegisterInfo: string = '');
begin
  UpdateStatusBar(stCashRegister, AStatus, ARegisterInfo);
end;

procedure TFmChek.UpdateShiftStatus(AStatus: TStatusValue; const AShiftInfo: string = '');
begin
  UpdateStatusBar(stShift, AStatus, AShiftInfo);
end;

procedure TFmChek.UpdateAllStatuses;
begin
  if not UseCheckboxAPI then
  begin
    UpdateAPIStatus(svDisabled);
    UpdateCashierStatus(svDisabled);
    UpdateCashRegisterStatus(svDisabled);
    UpdateShiftStatus(svDisabled);
    Exit;
  end;

  if not Assigned(FReceiptAPI) then
  begin
    UpdateAPIStatus(svUnknown);
    UpdateCashierStatus(svUnknown);
    UpdateCashRegisterStatus(svUnknown);
    UpdateShiftStatus(svUnknown);
    Exit;
  end;

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É
  if FReceiptAPI.IsTokenValid then
    UpdateCashierStatus(svOnline)
  else
    UpdateCashierStatus(svUnknown);

  // –Ü–Ω—à—ñ —Å—Ç–∞—Ç—É—Å–∏ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –æ–∫—Ä–µ–º–æ
end;

initialization
  {$I chek.lrs}

end.
